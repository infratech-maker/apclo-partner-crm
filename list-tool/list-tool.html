<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¹ãƒˆåé›†ãƒ„ãƒ¼ãƒ« - ãƒ­ã‚±ãƒƒãƒˆãƒŠã‚¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgT25o-UtghcuUQl1zVLjSsQMTW-7kj2M&libraries=places&language=ja"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script>
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã¯ç„¡åŠ¹åŒ–ï¼ˆé–‹ç™ºç’°å¢ƒç”¨ï¼‰
      // (function() {
      //   const currentPartnerId = sessionStorage.getItem("currentPartnerId");
      //   if (!currentPartnerId) {
      //     window.location.href = "/login";
      //     return;
      //   }
      // })();
      
      // é–‹ç™ºç’°å¢ƒç”¨: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚’è¨­å®š
      if (!sessionStorage.getItem("currentPartnerId")) {
        sessionStorage.setItem("currentPartnerId", "ADMIN");
        sessionStorage.setItem("isAdmin", "true");
      }
    </script>
    <style>
        body {
            font-family: "Inter", "Noto Sans JP", sans-serif;
            background-color: #fafafa;
        }
        
        /* apclo.co.jpé¢¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ã‚¶ã‚¤ãƒ³ */
        .apclo-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.2s ease;
        }
        
        .apclo-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        
        .apclo-button {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .apclo-button:hover {
            transform: translateY(-1px);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .status-badge:hover {
            transform: scale(1.05);
        }
        
        .status-approach {
            background-color: #FEF3C7;
            color: #92400E;
            border: 1px solid #FCD34D;
        }
        
        .status-contracted {
            background-color: #D1FAE5;
            color: #065F46;
            border: 1px solid #34D399;
        }
        
        .status-none {
            background-color: #F3F4F6;
            color: #6B7280;
            border: 1px solid #D1D5DB;
        }
        .store-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .store-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }
        
        table {
            border-collapse: collapse;
        }
        
        th {
            position: sticky;
            top: 0;
            background-color: #f9fafb;
            z-index: 10;
        }
        
        tbody tr:hover {
            background-color: #f9fafb;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        #map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
        }

        /* åº—èˆ—åã¯ 30æ–‡å­—ç›¸å½“ã§æŠ˜ã‚Šè¿”ã— */
        .store-name-cell {
            max-width: 30ch;
            white-space: normal;
            word-break: break-word;
        }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .lt-tab {
            padding: 0.5rem 0.75rem;
            border-bottom-width: 2px;
            border-bottom-color: transparent;
            color: #6b7280; /* gray-500 */
            font-weight: 500;
        }

        .lt-tab:hover {
            color: #111827; /* gray-900 */
        }

        .lt-tab-active {
            border-bottom-color: #2563eb; /* blue-600 */
            color: #111827;
        }
        
        .mylist-subtab {
            padding: 8px 16px;
            border: none;
            background: none;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .mylist-subtab:hover {
            color: #374151;
        }
        
        .mylist-subtab-active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        .mylist-content {
            min-height: 200px;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã« th ã®ç›´ä¸‹ã«è¡¨ç¤ºï¼‰ */
        .header-filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1000;
            min-width: 250px;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .header-filter-menu.show {
            display: block;
        }
        
        .header-filter-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
            color: #374151;
        }
        
        .header-filter-menu-item:hover {
            background-color: #f9fafb;
        }
        
        .header-filter-menu-item:last-child {
            border-bottom: none;
        }
        
        .header-filter-menu-section {
            border-bottom: 1px solid #e5e7eb;
            padding: 8px 0;
        }
        
        .header-filter-menu-section:last-child {
            border-bottom: none;
        }
        
        .header-filter-menu-section-title {
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .header-filter-search {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .header-filter-search input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .header-filter-values {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .header-filter-value-item {
            padding: 6px 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .header-filter-value-item:hover {
            background-color: #f9fafb;
        }
        
        .header-filter-value-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .header-filter-actions {
            padding: 8px 12px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        
        .header-filter-actions button {
            flex: 1;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .header-filter-clear {
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        
        .header-filter-apply {
            background: #2563eb;
            border: none;
            color: white;
        }
        
        .header-filter-icon {
            margin-left: 4px;
            opacity: 0.5;
            cursor: pointer;
        }
        
        .header-filter-icon:hover {
            opacity: 1;
        }
        
        th {
            position: relative;
        }
        
        /* åˆ—å¹…ã®èª¿æ•´ */
        th[data-column="name"] {
            min-width: 320px;
            max-width: 320px;
        }
        
        th[data-column="address"] {
            min-width: 320px;
            max-width: 320px;
        }
        
        th[data-column="official_account"] {
            white-space: nowrap;
            min-width: 150px;
        }
        
        th[data-column="collected_at"] {
            white-space: nowrap;
            min-width: 120px;
        }
        
        th[data-column="delivery"] {
            white-space: nowrap;
            min-width: 180px;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ãƒ«ã®å¹…èª¿æ•´ */
        .store-name-cell {
            min-width: 320px;
            max-width: 320px;
        }
        
        .store-address-cell {
            min-width: 320px;
            max-width: 320px;
        }
        
        .store-official-account-cell {
            white-space: nowrap !important;
            min-width: 150px;
        }
        
        .store-collected-at-cell {
            white-space: nowrap !important;
            min-width: 120px;
        }
        
        .store-delivery-cell {
            white-space: nowrap !important;
            min-width: 180px;
        }
    </style>
</head>
  <body class="antialiased text-slate-900 bg-slate-100">
    <div class="min-h-screen flex">
      <!-- ã‚µã‚¤ãƒ‰ãƒŠãƒ“ï¼ˆå…±é€šãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ -->
      <aside class="hidden md:flex md:flex-col w-64 bg-slate-900 text-slate-100">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
          <div>
            <div class="text-xs uppercase tracking-widest text-slate-400">
              APCLO PARTNER
            </div>
            <div class="text-lg font-semibold tracking-tight" id="sidebar-title">
              List Board
            </div>
          </div>
        </div>
        <nav class="flex-1 px-3 py-4 space-y-1 text-sm" id="sidebar-nav">
          <!-- ä¸€èˆ¬ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
          <div id="partner-menu">
            <a
              href="/dashboard"
              class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
            >
              <span>ğŸ“Š</span>
              <span>Salesãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </a>
            <a
              href="/list-tool"
              class="flex items-center gap-2 px-3 py-2 rounded-md bg-slate-800 text-slate-50 font-medium"
            >
              <span>ğŸ“‹</span>
              <span>ãƒªã‚¹ãƒˆåé›†ãƒ„ãƒ¼ãƒ«</span>
            </a>
            <a
              href="/products"
              class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
            >
              <span>ğŸ›’</span>
              <span>ãã®ä»–å•†æ</span>
            </a>
          </div>
          <!-- ç®¡ç†è€…ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
          <div id="admin-menu" style="display: none;">
            <a
              href="/admin-dashboard"
              class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
            >
              <span>ğŸ“Š</span>
              <span>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </a>
            <a
              href="/list-tool"
              class="flex items-center gap-2 px-3 py-2 rounded-md bg-slate-800 text-slate-50 font-medium"
            >
              <span>ğŸ“‹</span>
              <span>ãƒªã‚¹ãƒˆåé›†ãƒ„ãƒ¼ãƒ«</span>
            </a>
            <a
              href="/billing"
              class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
            >
              <span>ğŸ’°</span>
              <span>è«‹æ±‚é–¢é€£ï¼ˆå…¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼‰</span>
            </a>
            <a
              href="/products"
              class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
            >
              <span>ğŸ›’</span>
              <span>ãã®ä»–å•†æ</span>
            </a>
            <a
              href="/account-management"
              class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
            >
              <span>ğŸ‘¥</span>
              <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</span>
            </a>
          </div>
        </nav>
        <div class="px-4 py-4 border-t border-slate-800 text-xs text-slate-400">
          <div>FAST ALONE FAR TOGETHER</div>
          <div class="mt-1">ä¸€äººã§ã¯ãŸã©ã‚Šç€ã‘ãªã„æœªæ¥ã‚’ã€ã¨ã‚‚ã«ã€‚</div>
        </div>
      </aside>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="flex-1 flex flex-col">
        <header class="bg-white border-b border-slate-200">
          <div class="px-4 md:px-8 py-4 flex items-center justify-between">
            <div>
              <h1 class="text-xl md:text-2xl font-semibold tracking-tight text-slate-900">
                ãƒªã‚¹ãƒˆåé›†ãƒ„ãƒ¼ãƒ«
              </h1>
              <p class="text-xs md:text-sm text-slate-500 mt-1">
                æ—¥æœ¬å…¨å›½ã®é£²é£Ÿåº—èˆ—æƒ…å ±ã‚’é–²è¦§ãƒ»æ¤œç´¢
              </p>
            </div>
            <div class="flex items-center gap-4">
              <button
                id="btn-release-notes"
                class="px-3 py-2 md:px-4 md:py-2 bg-blue-600 text-white rounded-md text-xs md:text-sm font-medium hover:bg-blue-700 transition flex items-center gap-2"
                title="ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ"
              >
                <span>ğŸ“</span>
                <span class="hidden sm:inline">ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ</span>
              </button>
              <span
                id="partner-id-display"
                class="hidden sm:inline-flex text-xs md:text-sm font-medium text-slate-600 px-3 py-1 rounded-full bg-slate-100"
              ></span>
              <button
                id="btn-logout"
                class="px-3 py-2 md:px-4 md:py-2 bg-slate-900 text-white rounded-md text-xs md:text-sm font-medium hover:bg-slate-800 transition"
              >
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
              </button>
            </div>
          </div>
        </header>

        <main class="px-4 lg:px-10 xl:px-12 py-6 md:py-8 max-w-7xl w-full mx-auto">

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex gap-6 text-sm" aria-label="List tool tabs">
                <button
                    type="button"
                    class="lt-tab"
                    data-tab="dashboard"
                >
                    ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </button>
                <button
                    type="button"
                    class="lt-tab lt-tab-active"
                    data-tab="search"
                >
                    æ¤œç´¢
                </button>
                <button
                    type="button"
                    class="lt-tab"
                    data-tab="mylist"
                >
                    MYãƒªã‚¹ãƒˆè¡¨ç¤º
                </button>
            </nav>
        </div>

        <!-- çµ±è¨ˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ–ã§è¡¨ç¤ºï¼‰ -->
        <section id="stats-section" class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4" style="display: none;">
            <div class="apclo-card p-6">
                <h3 class="text-gray-500 text-xs font-medium mb-2 uppercase tracking-wide">ç·åº—èˆ—æ•°</h3>
                <p id="total-stores" class="text-3xl font-semibold text-gray-900">-</p>
            </div>
            <div class="apclo-card p-6">
                <h3 class="text-gray-500 text-xs font-medium mb-2 uppercase tracking-wide">é›»è©±ç•ªå·å–å¾—ç‡</h3>
                <p id="phone-rate" class="text-3xl font-semibold text-gray-900">-</p>
            </div>
            <div class="apclo-card p-6">
                <h3 class="text-gray-500 text-xs font-medium mb-2 uppercase tracking-wide">ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆå–å¾—ç‡</h3>
                <p id="website-rate" class="text-3xl font-semibold text-gray-900">-</p>
            </div>
            <div class="apclo-card p-6">
                <h3 class="text-gray-500 text-xs font-medium mb-2 uppercase tracking-wide">éƒ½å¸‚æ•°</h3>
                <p id="cities-count" class="text-3xl font-semibold text-gray-900">-</p>
            </div>
            <div class="apclo-card p-6">
                <h3 class="text-gray-500 text-xs font-medium mb-2 uppercase tracking-wide">è£œå®Œå®Œäº†åº—èˆ—æ•°</h3>
                <p id="fully-completed-count" class="text-3xl font-semibold text-green-600">-</p>
                <p id="fully-completed-rate" class="text-sm text-gray-500 mt-1">-</p>
            </div>
        </section>

        <!-- ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ–ã§è¡¨ç¤ºï¼‰ -->
        <section id="charts-section" class="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6" style="display: none;">
            <!-- éƒ½å¸‚åˆ¥ä»¶æ•°ã‚°ãƒ©ãƒ• -->
            <div class="apclo-card p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">å¸‚åŒºç”ºæ‘åˆ¥åº—èˆ—æ•°ï¼ˆä¸Šä½20å¸‚åŒºç”ºæ‘ï¼‰</h3>
                <div class="relative" style="height: 400px;">
                    <canvas id="city-chart"></canvas>
                </div>
            </div>
            
            <!-- éƒ½é“åºœçœŒåˆ¥ä»¶æ•°ã‚°ãƒ©ãƒ• -->
            <div class="apclo-card p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">éƒ½é“åºœçœŒåˆ¥åº—èˆ—æ•°</h3>
                <div class="relative" style="height: 400px;">
                    <canvas id="prefecture-chart"></canvas>
                </div>
            </div>
            
            <!-- ã‚¨ãƒªã‚¢åˆ¥ä»¶æ•°ã‚°ãƒ©ãƒ• -->
            <div class="apclo-card p-6 lg:col-span-2">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">ã‚¨ãƒªã‚¢åˆ¥åº—èˆ—æ•°</h3>
                <div class="relative" style="height: 400px;">
                    <canvas id="area-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¤œç´¢ã‚¿ãƒ–ã§è¡¨ç¤ºï¼‰ -->
        <section id="search-section" class="apclo-card p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-4">
                <!-- æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">æ¤œç´¢</label>
                    
                    <div class="border border-gray-300 rounded-lg p-3 min-h-[60px] mb-3 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition">
                        <div id="search-keywords" class="flex flex-wrap gap-2 mb-2">
                        </div>
                        <input
                            type="text"
                            id="search-input"
                            placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦Enterã‚­ãƒ¼ã§è¿½åŠ "
                            class="w-full px-2 py-1 border-0 outline-none text-sm"
                        >
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="block text-xs font-semibold text-gray-600 mb-1">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰çµåˆ</label>
                            <div class="flex flex-col gap-2">
                                <label class="flex items-center text-sm text-gray-700 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                    <input
                                        type="radio"
                                        name="search-mode"
                                        value="AND"
                                        checked
                                        class="mr-2"
                                    >
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">ã™ã¹ã¦å«ã‚€ (AND)</span>
                                </label>
                                <label class="flex items-center text-sm text-gray-700 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                    <input
                                        type="radio"
                                        name="search-mode"
                                        value="OR"
                                        class="mr-2"
                                    >
                                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">ã„ãšã‚Œã‹å«ã‚€ (OR)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-xs font-semibold text-gray-600 mb-1">ãƒãƒƒãƒæ–¹æ³•</label>
                            <div class="flex flex-col gap-2">
                                <label class="flex items-center text-sm text-gray-700 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                    <input
                                        type="radio"
                                        name="match-type"
                                        value="partial"
                                        checked
                                        class="mr-2"
                                    >
                                    <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">éƒ¨åˆ†ä¸€è‡´</span>
                                </label>
                                <label class="flex items-center text-sm text-gray-700 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                    <input
                                        type="radio"
                                        name="match-type"
                                        value="prefix"
                                        class="mr-2"
                                    >
                                    <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs">å‰æ–¹ä¸€è‡´</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘</label>
                    
                    <div class="mb-3">
                        <label class="block text-xs font-semibold text-gray-600 mb-1">ã‚¨ãƒªã‚¢ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                        <div
                            id="area-filter-container"
                            class="border border-gray-300 rounded-lg p-2 max-h-32 overflow-y-auto bg-gray-50 custom-scrollbar mb-2"
                        >
                            <p class="text-xs text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="block text-xs font-semibold text-gray-600 mb-1">éƒ½é“åºœçœŒï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                        <div
                            id="prefecture-filter-container"
                            class="border border-gray-300 rounded-lg p-2 max-h-40 overflow-y-auto bg-gray-50 custom-scrollbar"
                        >
                            <p class="text-xs text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">å¸‚åŒºç”ºæ‘ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                        
                        <div id="selected-cities-display" class="mb-2" style="display: none;">
                            <label class="block text-xs font-semibold text-blue-600 mb-1">é¸æŠæ¸ˆã¿å¸‚åŒºç”ºæ‘</label>
                            <div
                                id="selected-cities-container"
                                class="border border-blue-300 rounded-lg p-2 bg-blue-50 min-h-[40px] max-h-32 overflow-y-auto custom-scrollbar"
                            >
                                <p class="text-xs text-gray-500">é¸æŠã•ã‚ŒãŸå¸‚åŒºç”ºæ‘ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                            </div>
                        </div>
                        
                        <input
                            type="text"
                            id="city-search-input"
                            placeholder="å¸‚åŒºç”ºæ‘åã§æ¤œç´¢..."
                            class="w-full px-3 py-2 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-sm"
                            style="display: none;"
                        >
                        <div
                            id="city-filter-container"
                            class="border border-gray-300 rounded-lg p-3 max-h-48 overflow-y-auto bg-gray-50 custom-scrollbar"
                        >
                            <p class="text-xs text-gray-500">éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§è¤‡æ•°é¸æŠ</p>
                    </div>
                </div>
                
                <!-- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-semibold text-gray-700">ã‚«ãƒ†ã‚´ãƒªï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                        <button
                            id="select-all-categories-btn"
                            type="button"
                            class="text-xs px-3 py-1 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors"
                        >
                            å…¨ä»¶é¸æŠ
                        </button>
                    </div>
                    
                    <input
                        type="text"
                        id="category-search-input"
                        placeholder="ã‚«ãƒ†ã‚´ãƒªãƒ¼åã§æ¤œç´¢..."
                        class="w-full px-3 py-2 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-sm"
                        style="display: none;"
                    >
                    
                    <div id="selected-categories-display" class="mb-2" style="display: none;">
                        <label class="block text-xs font-semibold text-purple-600 mb-1">é¸æŠæ¸ˆã¿ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <div
                            id="selected-categories-container"
                            class="border border-purple-300 rounded-lg p-2 bg-purple-50 min-h-[40px] max-h-32 overflow-y-auto custom-scrollbar"
                        >
                            <p class="text-xs text-gray-500">é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        </div>
                    </div>
                    
                    <div
                        id="category-filter-container"
                        class="border border-gray-300 rounded-lg p-3 max-h-48 overflow-y-auto bg-gray-50 custom-scrollbar"
                    >
                        <p class="text-xs text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§è¤‡æ•°é¸æŠ</p>
                </div>
                
                <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                    
                    <div
                        id="data-source-filter-container"
                        class="border border-gray-300 rounded-lg p-3 bg-gray-50"
                    >
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                        <p class="text-xs text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§è¤‡æ•°é¸æŠ</p>
                </div>
                
                <!-- å…¨é …ç›®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
                    
                    <div class="space-y-3">
                        <!-- é›»è©±ç•ªå·ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">é›»è©±ç•ªå·</label>
                            <input
                                type="text"
                                id="phone-filter-input"
                                placeholder="é›»è©±ç•ªå·ã§æ¤œç´¢..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-sm"
                            >
                        </div>
                        
                        <!-- ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</label>
                            <input
                                type="text"
                                id="website-filter-input"
                                placeholder="ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURLã§æ¤œç´¢..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-sm"
                            >
                        </div>
                        
                        <!-- è©•ä¾¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">è©•ä¾¡</label>
                            <div class="flex gap-2">
                                <select
                                    id="rating-filter-operator"
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-sm"
                                >
                                    <option value=">=">ä»¥ä¸Š</option>
                                    <option value="<=">ä»¥ä¸‹</option>
                                    <option value="=">ç­‰ã—ã„</option>
                                </select>
                                <input
                                    type="number"
                                    id="rating-filter-value"
                                    placeholder="è©•ä¾¡å€¤"
                                    min="0"
                                    max="5"
                                    step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-sm"
                                >
                            </div>
                        </div>
                        
                        <!-- è£œå®Œå®Œäº†ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">è£œå®ŒçŠ¶æ³</label>
                            <div class="flex flex-col gap-2">
                                <label class="flex items-center text-sm text-gray-700 cursor-pointer hover:bg-gray-50 p-2 rounded border border-gray-200">
                                    <input
                                        type="checkbox"
                                        id="fully-completed-filter"
                                        class="mr-2"
                                    >
                                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">âœ… è£œå®Œå®Œäº†ï¼ˆå…¨é …ç›®æƒã„ï¼‰</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="flex gap-3 justify-between items-center pt-4 border-t border-gray-200">
                <button
                    id="reset-filters"
                    class="apclo-button px-6 py-2 bg-white text-gray-700 border border-gray-300 text-sm font-medium"
                >
                    ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
                </button>
                
                <div class="flex gap-2">
                    <button
                        id="export-button"
                        class="apclo-button px-6 py-2 bg-gray-900 text-white text-sm font-medium flex items-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                </div>
            </div>
        </section>

        <!-- ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ–ã§è¡¨ç¤ºï¼‰ -->
        <section id="saved-lists-section" class="mb-8 apclo-card p-6" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆï¼ˆCRMç®¡ç†ï¼‰</h2>
                <div class="flex gap-2">
                    <button
                        id="btn-show-all-on-map"
                        class="apclo-button px-6 py-2 bg-white text-gray-700 border border-gray-300 text-sm font-medium flex items-center gap-2"
                        style="display: none;"
                    >
                        å…¨ãƒªã‚¹ãƒˆã‚’åœ°å›³è¡¨ç¤º
                    </button>
                    <button
                        id="btn-save-current-list"
                        class="apclo-button px-6 py-2 bg-gray-900 text-white text-sm font-medium flex items-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        ç¾åœ¨ã®æ¤œç´¢çµæœã‚’ä¿å­˜
                    </button>
                </div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="mb-4 flex gap-2">
                <button
                    id="filter-all"
                    class="apclo-button px-4 py-2 bg-gray-900 text-white text-sm font-medium"
                    onclick="filterListsByStatus('all')"
                >
                    ã™ã¹ã¦
                </button>
                <button
                    id="filter-approach"
                    class="apclo-button px-4 py-2 bg-white text-gray-700 border border-gray-300 text-sm font-medium"
                    onclick="filterListsByStatus('approach')"
                >
                    ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãƒªã‚¹ãƒˆ
                </button>
                <button
                    id="filter-contracted"
                    class="apclo-button px-4 py-2 bg-white text-gray-700 border border-gray-300 text-sm font-medium"
                    onclick="filterListsByStatus('contracted')"
                >
                    æˆç´„ãƒªã‚¹ãƒˆ
                </button>
            </div>
            
            <div id="saved-lists-container" class="space-y-3">
                <!-- ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </section>

        <!-- MYãƒªã‚¹ãƒˆè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆMYãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¿ãƒ–ã§è¡¨ç¤ºï¼‰ -->
        <section id="mylist-section" style="display: none;">
            <div class="mb-6 apclo-card p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">MYãƒªã‚¹ãƒˆè¡¨ç¤º</h2>
                
                <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆãŠæ°—ã«å…¥ã‚Š / ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ï¼‰ -->
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex gap-6 text-sm">
                        <button
                            type="button"
                            class="mylist-subtab mylist-subtab-active"
                            data-subtab="favorites"
                        >
                            ãŠæ°—ã«å…¥ã‚Š
                        </button>
                        <button
                            type="button"
                            class="mylist-subtab"
                            data-subtab="downloaded"
                        >
                            ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿
                        </button>
                    </nav>
                </div>
                
                <!-- ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆ -->
                <div id="favorites-content" class="mylist-content">
                    <div id="favorites-lists-container" class="space-y-3">
                        <!-- ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
                
                <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒªã‚¹ãƒˆ -->
                <div id="downloaded-content" class="mylist-content" style="display: none;">
                    <div id="downloaded-lists-container" class="space-y-3">
                        <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>
        </section>

        <!-- åº—èˆ—ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¤œç´¢ã‚¿ãƒ–ã§è¡¨ç¤ºï¼‰ -->
        <section id="stores-section">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">åº—èˆ—ä¸€è¦§</h2>
                <div class="flex items-center gap-4">
                    <div id="pagination-info" class="text-sm text-gray-500"></div>
                    <button
                        id="btn-select-all"
                        class="apclo-button px-4 py-2 bg-white text-gray-700 border border-gray-300 text-sm font-medium"
                    >
                        å…¨é¸æŠ
                    </button>
                    <button
                        id="btn-save-selected"
                        class="apclo-button px-4 py-2 bg-gray-900 text-white text-sm font-medium"
                        style="display: none;"
                    >
                        é¸æŠã—ãŸåº—èˆ—ã‚’ä¿å­˜
                    </button>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®æ¦‚è¦ãƒãƒ¼ -->
            <div id="active-filters-bar" class="hidden mb-3">
                <div class="flex items-center flex-wrap gap-2 text-xs">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full bg-blue-50 text-blue-700 font-medium">
                        ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­
                    </span>
                    <div id="active-filters-chips" class="flex flex-wrap gap-2"></div>
                    <button
                        type="button"
                        onclick="resetFilters()"
                        class="ml-auto inline-flex items-center px-3 py-1 rounded-full border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 transition-colors"
                    >
                        ã™ã¹ã¦ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>

            <div id="loading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <div class="apclo-card overflow-hidden">
                <div class="overflow-x-auto max-h-[70vh] overflow-y-auto custom-scrollbar">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50 sticky top-0 z-10 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="select-all-checkbox" class="w-4 h-4 text-gray-900 border-gray-300 rounded focus:ring-gray-500">
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="name">
                                    <div class="flex items-center justify-between">
                                        <span>åº—èˆ—å</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-name">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('name', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('name', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-name" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('name')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-name">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('name')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('name')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="address">
                                    <div class="flex items-center justify-between">
                                        <span>ä½æ‰€</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-address">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('address', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('address', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-address" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('address')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-address">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('address')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('address')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="contact">
                                    <div class="flex items-center justify-between">
                                        <span>é€£çµ¡å…ˆ</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-contact">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('contact', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('contact', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-contact" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('contact')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-contact">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('contact')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('contact')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="category">
                                    <div class="flex items-center justify-between">
                                        <span>ã‚«ãƒ†ã‚´ãƒªãƒ¼</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-category">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('category', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('category', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-category" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('category')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-category">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('category')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('category')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="closed_day">
                                    <div class="flex items-center justify-between">
                                        <span>å®šä¼‘æ—¥</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-closed_day">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('closed_day', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('closed_day', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-closed_day" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('closed_day')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-closed_day">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('closed_day')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('closed_day')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="opening_date">
                                    <div class="flex items-center justify-between">
                                        <span>ã‚ªãƒ¼ãƒ—ãƒ³æ—¥</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-opening_date">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('opening_date', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('opening_date', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-opening_date" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('opening_date')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-opening_date">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('opening_date')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('opening_date')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="transport">
                                    <div class="flex items-center justify-between">
                                        <span>äº¤é€šæ‰‹æ®µ</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-transport">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('transport', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('transport', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-transport" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('transport')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-transport">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('transport')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('transport')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="business_hours">
                                    <div class="flex items-center justify-between">
                                        <span>å–¶æ¥­æ™‚é–“</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-business_hours">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('business_hours', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('business_hours', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-business_hours" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('business_hours')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-business_hours">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('business_hours')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('business_hours')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="official_account">
                                    <div class="flex items-center justify-between">
                                        <span>å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-official_account">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('official_account', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('official_account', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-official_account" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('official_account')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-official_account">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('official_account')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('official_account')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="data_source">
                                    <div class="flex items-center justify-between">
                                        <span>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-data_source">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('data_source', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('data_source', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-values" id="header-filter-values-data_source">
                                                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('data_source')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('data_source')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="collected_at">
                                    <div class="flex items-center justify-between">
                                        <span>ãƒªã‚¹ãƒˆåé›†æ—¥</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-collected_at">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('collected_at', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('collected_at', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-search">
                                                <input type="text" id="header-filter-search-collected_at" placeholder="æ¤œç´¢..." oninput="filterHeaderValues('collected_at')">
                                            </div>
                                            <div class="header-filter-values" id="header-filter-values-collected_at">
                                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('collected_at')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('collected_at')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="delivery">
                                    <div class="flex items-center justify-between">
                                        <span>ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-delivery">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('delivery', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('delivery', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <p id="header-filter-delivery-selected-label" class="px-3 pb-1 text-xs text-gray-500">
                                                ã™ã¹ã¦ã®ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¡¨ç¤ºä¸­
                                            </p>
                                            <div class="header-filter-values" id="header-filter-values-delivery">
                                                <div class="header-filter-value-item">
                                                    <input type="checkbox" id="header-filter-delivery-all" value="" checked onchange="toggleHeaderFilterAll('delivery', this)">
                                                    <label for="header-filter-delivery-all">ã™ã¹ã¦</label>
                                                </div>
                                                <div class="header-filter-value-item">
                                                    <input type="checkbox" id="header-filter-delivery-ubereats" value="ubereats" checked>
                                                    <label for="header-filter-delivery-ubereats">Uber Eats</label>
                                                </div>
                                                <div class="header-filter-value-item">
                                                    <input type="checkbox" id="header-filter-delivery-wolt" value="wolt" checked>
                                                    <label for="header-filter-delivery-wolt">ã‚¦ã‚©ãƒ«ãƒˆ</label>
                                                </div>
                                                <div class="header-filter-value-item">
                                                    <input type="checkbox" id="header-filter-delivery-demaecan" value="demaecan" checked>
                                                    <label for="header-filter-delivery-demaecan">å‡ºå‰é¤¨</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('delivery')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('delivery')">OK</button>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider header-filter-th" data-column="status">
                                    <div class="flex items-center justify-between">
                                        <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
                                        <span class="header-filter-icon">ğŸ”½</span>
                                    </div>
                                    <div class="header-filter-menu" id="header-filter-menu-status">
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-item" onclick="sortColumn('status', 'asc')">æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                            <div class="header-filter-menu-item" onclick="sortColumn('status', 'desc')">é™é †ã§ä¸¦ã¹æ›¿ãˆ</div>
                                        </div>
                                        <div class="header-filter-menu-section">
                                            <div class="header-filter-menu-section-title">å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿</div>
                                            <div class="header-filter-values" id="header-filter-values-status">
                                                <div class="header-filter-value-item">
                                                    <input type="checkbox" id="header-filter-status-all" value="" checked onchange="toggleHeaderFilterAll('status', this)">
                                                    <label for="header-filter-status-all">ã™ã¹ã¦</label>
                                                </div>
                                                <div class="header-filter-value-item">
                                                    <input type="checkbox" id="header-filter-status-none" value="none" checked>
                                                    <label for="header-filter-status-none">æœªè¨­å®š</label>
                                                </div>
                                                <div class="header-filter-value-item">
                                                    <input type="checkbox" id="header-filter-status-approach" value="approach" checked>
                                                    <label for="header-filter-status-approach">ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­</label>
                                                </div>
                                                <div class="header-filter-value-item">
                                                    <input type="checkbox" id="header-filter-status-contracted" value="contracted" checked>
                                                    <label for="header-filter-status-contracted">æˆç´„æ¸ˆã¿</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="header-filter-actions">
                                            <button class="header-filter-clear" onclick="clearHeaderFilter('status')">ã‚¯ãƒªã‚¢</button>
                                            <button class="header-filter-apply" onclick="applyHeaderFilter('status')">OK</button>
                                        </div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="stores-container" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="pagination" class="mt-6 flex justify-center gap-2"></div>
        </section>
    </main>
    
    <!-- Googleãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="mapModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4" id="mapModalTitle">åœ°å›³è¡¨ç¤º</h2>
            <div id="map"></div>
        </div>
    </div>

    <script>
        // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªï¼ˆæ—¢ã«headå†…ã§ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯è¡¨ç¤ºã®ã¿ï¼‰
        function checkLogin() {
            const currentPartnerId = sessionStorage.getItem("currentPartnerId");
            const isAdmin = sessionStorage.getItem("isAdmin") === "true";
            
            if (!currentPartnerId) {
                window.location.href = "/login";
                return false;
            }
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚’è¡¨ç¤ºï¼ˆç®¡ç†è€…ã®å ´åˆã¯ã€Œãƒã‚¹ã‚¿ãƒ¼ç®¡ç†è€…ã€ã¨è¡¨ç¤ºï¼‰
            if (isAdmin) {
                document.getElementById("partner-id-display").textContent = "ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†è€…";
            } else {
                document.getElementById("partner-id-display").textContent = `ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ID: ${currentPartnerId}`;
            }
            return true;
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        document.getElementById("btn-logout").addEventListener("click", () => {
            sessionStorage.removeItem("currentPartnerId");
            sessionStorage.removeItem("isAdmin");
            window.location.href = "/login";
        });
        
        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°
        function normalizeDataSourceName(sourceName) {
            if (!sourceName) return '';
            const normalized = sourceName.toLowerCase().trim();
            // ãƒãƒƒãƒ”ãƒ³ã‚°: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å€¤ã®å¯¾å¿œ
            const mapping = {
                'ubereats': 'ubereats',
                'uber eats': 'ubereats',
                'uber_eats': 'ubereats',
                'wolt': 'wolt',
                'ã‚¦ã‚©ãƒ«ãƒˆ': 'wolt',
                'demaecan': 'demaecan',
                'å‡ºå‰é¤¨': 'demaecan',
                'tabelog': 'tabelog',
                'é£Ÿã¹ãƒ­ã‚°': 'tabelog',
                'gnavi': 'gnavi',
                'ãã‚‹ãªã³': 'gnavi',
                'gurunavi': 'gnavi'
            };
            // ãƒãƒƒãƒ”ãƒ³ã‚°ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯æ­£è¦åŒ–ã•ã‚ŒãŸå€¤ã‚’è¿”ã™
            for (const [key, value] of Object.entries(mapping)) {
                if (normalized === key.toLowerCase() || normalized.includes(key.toLowerCase())) {
                    return value;
                }
            }
            // ãƒãƒƒãƒ”ãƒ³ã‚°ã«ãªã„å ´åˆã¯å°æ–‡å­—åŒ–ã—ã¦è¿”ã™
            return normalized;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®UIã‚’å‹•çš„ã«ç”Ÿæˆ
        function renderDataSourceFilter() {
            const container = document.getElementById('data-source-filter-container');
            if (!container) return;
            
            container.innerHTML = '';
            DATA_SOURCES.forEach(source => {
                const label = document.createElement('label');
                label.className = 'flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = source.value;
                checkbox.className = 'mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 data-source-checkbox';
                checkbox.checked = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨é¸æŠ
                const span = document.createElement('span');
                span.className = 'text-sm text-gray-700';
                span.textContent = source.label;
                label.appendChild(checkbox);
                label.appendChild(span);
                container.appendChild(label);
            });
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.data-source-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const sourceValue = e.target.value;
                    if (e.target.checked) {
                        if (!currentFilters.dataSources.includes(sourceValue)) {
                            currentFilters.dataSources.push(sourceValue);
                        }
                    } else {
                        const index = currentFilters.dataSources.indexOf(sourceValue);
                        if (index > -1) currentFilters.dataSources.splice(index, 1);
                    }
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚åŒæœŸ
                    syncHeaderDataSourceFilter();
                    
                    loadStores(1);
                });
            });
            
            // åˆæœŸçŠ¶æ…‹ã§å…¨é¸æŠ
            currentFilters.dataSources = DATA_SOURCES.map(s => s.value);
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚åŒæœŸ
            syncHeaderDataSourceFilter();
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨å·¦å´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åŒæœŸ
        function syncHeaderDataSourceFilter() {
            const headerCheckboxes = document.querySelectorAll('#header-filter-values-data_source input[type="checkbox"]:not([id*="all"])');
            headerCheckboxes.forEach(cb => {
                const sourceValue = cb.value;
                const isSelected = currentFilters.dataSources.includes(sourceValue);
                cb.checked = isSelected;
                
                // headerFilterDataã‚‚æ›´æ–°
                if (isSelected) {
                    if (!headerFilterData.data_source.selected.includes(sourceValue)) {
                        headerFilterData.data_source.selected.push(sourceValue);
                    }
                } else {
                    const index = headerFilterData.data_source.selected.indexOf(sourceValue);
                    if (index > -1) {
                        headerFilterData.data_source.selected.splice(index, 1);
                    }
                }
            });
        }
        
        // å·¦å´ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åŒæœŸ
        function syncLeftDataSourceFilter() {
            const headerCheckboxes = document.querySelectorAll('#header-filter-values-data_source input[type="checkbox"]:not([id*="all"])');
            const selectedSources = [];
            headerCheckboxes.forEach(cb => {
                if (cb.checked) {
                    selectedSources.push(cb.value);
                }
            });
            
            // å·¦å´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
            currentFilters.dataSources = selectedSources;
            document.querySelectorAll('.data-source-checkbox').forEach(cb => {
                cb.checked = selectedSources.includes(cb.value);
            });
        }
        
        // ä½æ‰€ã‚’è¡¨ç¤ºç”¨ã«ç°¡æ˜“æ­£è¦åŒ–ã™ã‚‹é–¢æ•°
        function normalizeAddressToJapanese(address) {
            if (!address || address === 'æœªå–å¾—') {
                return address;
            }
            
            let result = address;
            
            // "æ—¥æœ¬ã€" ã‚’é™¤å»ï¼ˆGeocoding APIã®çµæœã‹ã‚‰ï¼‰
            result = result.replace(/^æ—¥æœ¬[ã€,]\s*/g, '');
            
            // "Japan, " ã‚’é™¤å»
            result = result.replace(/^Japan,\s*/g, '');
            
            // é‡è¤‡ã™ã‚‹éƒµä¾¿ç•ªå·ã‚’é™¤å»ï¼ˆæœ€åˆã®1ã¤ã ã‘æ®‹ã™ï¼‰
            const postalMatches = result.match(/ã€’(\d{3}-?\d{4})/g);
            if (postalMatches && postalMatches.length > 1) {
                const firstPostal = postalMatches[0];
                result = result.replace(/ã€’\d{3}-?\d{4}/g, '');
                result = `${firstPostal} ${result}`.trim();
            }
            
            // é‡è¤‡ã™ã‚‹éƒ½é“åºœçœŒåã‚’é™¤å»ï¼ˆæœ€åˆã®1ã¤ã ã‘æ®‹ã™ï¼‰
            const prefecturePattern = /(æ±äº¬éƒ½|å¤§é˜ªåºœ|äº¬éƒ½åºœ|ç¥å¥ˆå·çœŒ|æ„›çŸ¥çœŒ|å…µåº«çœŒ|ç¦å²¡çœŒ|åŒ—æµ·é“|åŸ¼ç‰çœŒ|åƒè‘‰çœŒ)/g;
            const prefectureMatches = result.match(prefecturePattern);
            if (prefectureMatches && prefectureMatches.length > 1) {
                const firstPrefecture = prefectureMatches[0];
                result = result.replace(prefecturePattern, '');
                // éƒµä¾¿ç•ªå·ã®å¾Œã«éƒ½é“åºœçœŒã‚’é…ç½®
                if (result.match(/^ã€’/)) {
                    result = result.replace(/^(ã€’\d{3}-?\d{4})\s*/, `$1 ${firstPrefecture}`);
                } else {
                    result = `${firstPrefecture}${result}`;
                }
            }
            
            // è‹±èªè¡¨è¨˜ã‚’é™¤å»ï¼ˆTokyo, City, Wardãªã©ï¼‰
            result = result.replace(/\b(Tokyo|Osaka|Kyoto|Kanagawa|Aichi|Hyogo|Fukuoka|Hokkaido|Saitama|Chiba)\b/gi, '');
            result = result.replace(/\b(City|Ward)\b/gi, '');
            
            // ä½™åˆ†ãªç©ºç™½ã‚’æ•´ç†
            result = result.replace(/\s+/g, ' ').trim();
            
            return result || address;
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
        function switchTab(tab) {
            const tabButtons = document.querySelectorAll('.lt-tab');
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.add('lt-tab-active');
                } else {
                    btn.classList.remove('lt-tab-active');
                }
            });

            const statsSection = document.getElementById('stats-section');
            const chartsSection = document.getElementById('charts-section');
            const searchSection = document.getElementById('search-section');
            const savedListsSection = document.getElementById('saved-lists-section');
            const storesSection = document.getElementById('stores-section');
            const myListSection = document.getElementById('mylist-section');

            if (tab === 'dashboard') {
                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ–ï¼šçµ±è¨ˆæƒ…å ± + ã‚°ãƒ©ãƒ• + ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆç®¡ç†
                if (statsSection) statsSection.style.display = '';
                if (chartsSection) chartsSection.style.display = '';
                if (savedListsSection) savedListsSection.style.display = '';
                if (searchSection) searchSection.style.display = 'none';
                if (storesSection) storesSection.style.display = 'none';
                if (myListSection) myListSection.style.display = 'none';
            } else if (tab === 'search') {
                // æ¤œç´¢ã‚¿ãƒ–ï¼šæ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ + åº—èˆ—ãƒªã‚¹ãƒˆ
                if (statsSection) statsSection.style.display = 'none';
                if (chartsSection) chartsSection.style.display = 'none';
                if (savedListsSection) savedListsSection.style.display = 'none';
                if (searchSection) searchSection.style.display = '';
                if (storesSection) storesSection.style.display = '';
                if (myListSection) myListSection.style.display = 'none';
            } else if (tab === 'mylist') {
                // MYãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¿ãƒ–ï¼šãŠæ°—ã«å…¥ã‚Šãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒªã‚¹ãƒˆ
                if (statsSection) statsSection.style.display = 'none';
                if (chartsSection) chartsSection.style.display = 'none';
                if (savedListsSection) savedListsSection.style.display = 'none';
                if (searchSection) searchSection.style.display = 'none';
                if (storesSection) storesSection.style.display = 'none';
                if (myListSection) myListSection.style.display = '';
            }
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªã‚’å®Ÿè¡Œ
        if (!checkLogin()) {
            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã«ã¯åˆ°é”ã—ãªã„
        }
        
        // ç®¡ç†è€…/ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«å¿œã˜ã¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆ
        const isAdmin = sessionStorage.getItem("isAdmin") === "true";
        const partnerMenu = document.getElementById('partner-menu');
        const adminMenu = document.getElementById('admin-menu');
        const sidebarTitle = document.getElementById('sidebar-title');
        
        if (isAdmin) {
            // ç®¡ç†è€…ã®å ´åˆ
            if (partnerMenu) partnerMenu.style.display = 'none';
            if (adminMenu) adminMenu.style.display = 'block';
            if (sidebarTitle) sidebarTitle.textContent = 'Admin Board';
        } else {
            // ä¸€èˆ¬ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®å ´åˆ
            if (partnerMenu) partnerMenu.style.display = 'block';
            if (adminMenu) adminMenu.style.display = 'none';
            if (sidebarTitle) sidebarTitle.textContent = 'List Board';
        }
        
        // ä»¥ä¸‹ã€templates/dashboard.htmlã®JavaScriptã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ç”¨
        // ï¼ˆé•·ã„ã®ã§ã€ä¸»è¦ãªé–¢æ•°ã®ã¿è¨˜è¼‰ã€‚å®Ÿéš›ã«ã¯templates/dashboard.htmlã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆéƒ¨åˆ†ã‚’ã‚³ãƒ”ãƒ¼ï¼‰
        
        let currentPage = 1;
        let searchKeywords = [];
        let allCategoriesData = [];
        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®šï¼ˆå°†æ¥çš„ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒè¿½åŠ ã•ã‚Œã‚‹å ´åˆã¯ã“ã“ã«è¿½åŠ ï¼‰
        const DATA_SOURCES = [
            { value: 'ubereats', label: 'Ubereats' },
            { value: 'wolt', label: 'ã‚¦ã‚©ãƒ«ãƒˆ' },
            { value: 'demaecan', label: 'å‡ºå‰é¤¨' },
            { value: 'tabelog', label: 'é£Ÿã¹ãƒ­ã‚°' },
            { value: 'gnavi', label: 'ãã‚‹ãªã³' }
        ];
        
        let currentFilters = {
            prefectures: [],
            cities: [],
            categories: [],
            dataSources: [], // deliveryServicesã‹ã‚‰dataSourcesã«å¤‰æ›´
            search: '',
            searchMode: 'AND',
            matchType: 'partial',
            phone: '',
            website: '',
            ratingOperator: '>=',
            ratingValue: '',
            fullyCompleted: false, // è£œå®Œå®Œäº†ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå¾Œç¶šã®å‡¦ç†ã§ä½¿ç”¨ï¼‰
            headerName: '',
            headerAddress: '',
            headerContact: '',
            headerCategory: '',
            headerDelivery: '',
            headerStatus: '',
            headerClosedDay: '',
            headerOpeningDate: '',
            headerTransport: '',
            headerBusinessHours: '',
            headerOfficialAccount: '',
            headerCollectedAt: ''
        };

        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¦‚è¦ã§ã‚‚ä½¿ç”¨ï¼‰
        function normalizeDataSourceNameForDisplay(sourceName) {
            if (!sourceName) return '';
            const source = DATA_SOURCES.find(s => s.value === sourceName);
            return source ? source.label : sourceName;
        }

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¦‚è¦ã‚’æ›´æ–°
        function updateActiveFiltersBar(currentCount, totalCount) {
            const bar = document.getElementById('active-filters-bar');
            const chipsContainer = document.getElementById('active-filters-chips');
            if (!bar || !chipsContainer) return;

            const chips = [];

            if (currentFilters.search) {
                chips.push(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${currentFilters.search}`);
            }
            if (currentFilters.prefectures.length > 0) {
                chips.push(`éƒ½é“åºœçœŒ: ${currentFilters.prefectures.join(', ')}`);
            }
            if (currentFilters.cities.length > 0) {
                chips.push(`å¸‚åŒºç”ºæ‘: ${currentFilters.cities.join(', ')}`);
            }
            if (currentFilters.categories.length > 0) {
                chips.push(`ã‚«ãƒ†ã‚´ãƒª: ${currentFilters.categories.join(', ')}`);
            }
            if (currentFilters.dataSources.length > 0 && currentFilters.dataSources.length < DATA_SOURCES.length) {
                const sourceLabels = currentFilters.dataSources.map(s => normalizeDataSourceNameForDisplay(s));
                chips.push(`ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${sourceLabels.join(', ')}`);
            }
            if (currentFilters.phone) {
                chips.push(`é›»è©±: ${currentFilters.phone}`);
            }
            if (currentFilters.website) {
                chips.push(`ã‚µã‚¤ãƒˆ: ${currentFilters.website}`);
            }
            if (currentFilters.ratingValue) {
                chips.push(`è©•ä¾¡: ${currentFilters.ratingOperator} ${currentFilters.ratingValue}`);
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç°¡æ˜“è¡¨ç¤º
            if (currentFilters.headerName) chips.push('åº—èˆ—åãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerAddress) chips.push('ä½æ‰€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerContact) chips.push('é€£çµ¡å…ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerCategory) chips.push('ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerDelivery) chips.push('ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.dataSources.length > 0 && currentFilters.dataSources.length < DATA_SOURCES.length) {
                const sourceLabels = currentFilters.dataSources.map(s => normalizeDataSourceNameForDisplay(s));
                chips.push(`ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${sourceLabels.join(', ')}`);
            }
            if (currentFilters.headerStatus) chips.push('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerClosedDay) chips.push('å®šä¼‘æ—¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerOpeningDate) chips.push('ã‚ªãƒ¼ãƒ—ãƒ³æ—¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerTransport) chips.push('äº¤é€šæ‰‹æ®µãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerBusinessHours) chips.push('å–¶æ¥­æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerOfficialAccount) chips.push('å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');
            if (currentFilters.headerCollectedAt) chips.push('ãƒªã‚¹ãƒˆåé›†æ—¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼');

            chipsContainer.innerHTML = '';

            if (chips.length === 0) {
                bar.classList.add('hidden');
                return;
            }

            chips.forEach(text => {
                const chip = document.createElement('span');
                chip.className = 'inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-gray-700';
                chip.textContent = text;
                chipsContainer.appendChild(chip);
            });

            bar.classList.remove('hidden');
        }

        // APIãƒ™ãƒ¼ã‚¹URLï¼ˆFlaskã‚¢ãƒ—ãƒªãŒå‹•ã„ã¦ã„ã‚‹å ´åˆï¼‰
        // const API_BASE = ''; // ä¸‹ã§å†å®šç¾©ã•ã‚Œã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ

        document.addEventListener('DOMContentLoaded', async () => {
            loadStats();
            loadAreas();
            loadPrefectures();
            loadCategories();
            loadStores();
            try {
                await displaySavedLists();
            } catch (error) {
                console.error('ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                const container = document.getElementById('saved-lists-container');
                if (container) {
                    container.innerHTML = '<p class="text-center text-red-500 py-4">ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>';
                }
            }
            
            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.store-checkbox');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
                updateSelectedCount();
            });
            
            // é¸æŠã—ãŸåº—èˆ—ã‚’ä¿å­˜
            document.getElementById('btn-save-selected').addEventListener('click', saveSelectedStores);
            
            // ç¾åœ¨ã®æ¤œç´¢çµæœã‚’ä¿å­˜
            document.getElementById('btn-save-current-list').addEventListener('click', saveCurrentSearchResults);
            
            // åˆæœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
            filterListsByStatus('all');
            
            // å…¨ãƒªã‚¹ãƒˆã‚’åœ°å›³è¡¨ç¤º
            const allMapBtn = document.getElementById('btn-show-all-on-map');
            if (allMapBtn) {
                allMapBtn.addEventListener('click', async () => {
                    const lists = await getSavedLists();
                    const allStores = [];
                    lists.forEach(list => {
                        list.stores.forEach(store => {
                            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                            const exists = allStores.some(s => 
                                (s.store_id && store.store_id && s.store_id === store.store_id) ||
                                (!s.store_id && !store.store_id && s.name === store.name)
                            );
                            if (!exists && ((store.location_lat && store.location_lng) || store.address)) {
                                allStores.push(store);
                            }
                        });
                    });
                    
                    if (allStores.length === 0) {
                        alert('åœ°å›³è¡¨ç¤ºå¯èƒ½ãªåº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }
                    
                    const modal = document.getElementById('mapModal');
                    const modalTitle = document.getElementById('mapModalTitle');
                    modalTitle.textContent = `å…¨ä¿å­˜ãƒªã‚¹ãƒˆ - åœ°å›³è¡¨ç¤º (${allStores.length}ä»¶)`;
                    modal.style.display = 'block';
                    
                    setTimeout(async () => {
                        // å…¨ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹å ´åˆã¯ã€ãƒªã‚¹ãƒˆæƒ…å ±ã‚‚ä¿æŒ
                        await initMapWithMultipleLists(allStores, 'å…¨ä¿å­˜ãƒªã‚¹ãƒˆ');
                    }, 100);
                });
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸåŒ–
            const modal = document.getElementById('mapModal');
            const closeBtn = document.querySelector('.close');
            
            if (closeBtn) {
                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                };
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
            
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('keydown', handleSearchKeyDown);
            
            document.querySelectorAll('input[name="search-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentFilters.searchMode = e.target.value;
                    updateSearchQuery();
                    loadStores(1);
                });
            });
            
            document.querySelectorAll('input[name="match-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentFilters.matchType = e.target.value;
                    loadStores(1);
                });
            });
            
            document.getElementById('city-search-input').addEventListener('input', debounce(filterAndDisplayCities, 300));
            document.getElementById('category-search-input').addEventListener('input', debounce(() => {
                filterAndDisplayCategories();
            }, 300));
            document.getElementById('select-all-categories-btn').addEventListener('click', handleSelectAllCategories);
            updateSelectedCategoriesDisplay();
            
            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®UIã‚’ç”Ÿæˆ
            renderDataSourceFilter();
            
            // å…¨é …ç›®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            document.getElementById('phone-filter-input').addEventListener('input', debounce(() => {
                currentFilters.phone = document.getElementById('phone-filter-input').value.trim();
                loadStores(1);
            }, 500));
            
            document.getElementById('website-filter-input').addEventListener('input', debounce(() => {
                currentFilters.website = document.getElementById('website-filter-input').value.trim();
                loadStores(1);
            }, 500));
            
            document.getElementById('rating-filter-value').addEventListener('input', debounce(() => {
                currentFilters.ratingOperator = document.getElementById('rating-filter-operator').value;
                currentFilters.ratingValue = document.getElementById('rating-filter-value').value;
                loadStores(1);
            }, 500));
            
            document.getElementById('rating-filter-operator').addEventListener('change', () => {
                currentFilters.ratingOperator = document.getElementById('rating-filter-operator').value;
                if (currentFilters.ratingValue) {
                    loadStores(1);
                }
            });
            
            // è£œå®Œå®Œäº†ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const fullyCompletedCheckbox = document.getElementById('fully-completed-filter');
            if (fullyCompletedCheckbox) {
                fullyCompletedCheckbox.addEventListener('change', (e) => {
                    currentFilters.fullyCompleted = e.target.checked;
                    loadStores(1);
                });
            }
            
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
            document.getElementById('export-button').addEventListener('click', showExportFormatModal);
            
            // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const releaseNotesBtn = document.getElementById('btn-release-notes');
            if (releaseNotesBtn) {
                releaseNotesBtn.addEventListener('click', showReleaseNotes);
            }

            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆè¨­å®š
            const tabButtons = document.querySelectorAll('.lt-tab');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    switchTab(tab);
                    // MYãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¿ãƒ–ãŒé–‹ã‹ã‚ŒãŸã¨ãã«åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                    if (tab === 'mylist') {
                        loadFavoritesLists();
                    }
                });
            });

            // MYãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¿ãƒ–ã®ã‚µãƒ–ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            const myListSubTabs = document.querySelectorAll('.mylist-subtab');
            myListSubTabs.forEach(btn => {
                btn.addEventListener('click', () => {
                    const subtab = btn.dataset.subtab;
                    myListSubTabs.forEach(b => {
                        if (b.dataset.subtab === subtab) {
                            b.classList.add('mylist-subtab-active');
                        } else {
                            b.classList.remove('mylist-subtab-active');
                        }
                    });
                    
                    const favoritesContent = document.getElementById('favorites-content');
                    const downloadedContent = document.getElementById('downloaded-content');
                    
                    if (subtab === 'favorites') {
                        if (favoritesContent) favoritesContent.style.display = '';
                        if (downloadedContent) downloadedContent.style.display = 'none';
                        loadFavoritesLists();
                    } else if (subtab === 'downloaded') {
                        if (favoritesContent) favoritesContent.style.display = 'none';
                        if (downloadedContent) downloadedContent.style.display = '';
                        loadDownloadedLists();
                    }
                });
            });

            // åˆæœŸã‚¿ãƒ–ã¯ã€Œæ¤œç´¢ã€
            switchTab('search');
        });

        let cityChart = null;
        let prefectureChart = null;
        let areaChart = null;

        async function loadStats() {
            try {
                const response = await fetch(`${STORE_API_BASE}/api/stats`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                const data = await response.json();
                document.getElementById('total-stores').textContent = data.total_stores.toLocaleString();
                
                // é›»è©±ç•ªå·å–å¾—ç‡ã®è¨ˆç®—
                const phoneRate = data.total_stores > 0 ? (data.with_phone / data.total_stores * 100) : 0;
                document.getElementById('phone-rate').textContent = phoneRate.toFixed(1) + '%';
                
                // ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆå–å¾—ç‡ã®è¨ˆç®—
                const websiteRate = data.total_stores > 0 ? (data.with_website / data.total_stores * 100) : 0;
                document.getElementById('website-rate').textContent = websiteRate.toFixed(1) + '%';
                
                document.getElementById('cities-count').textContent = data.cities || 0;
                
                // è£œå®Œå®Œäº†åº—èˆ—æ•°ã®è¡¨ç¤º
                const fullyCompletedCount = data.fully_completed_with_opening || data.fully_completed || 0;
                const fullyCompletedRate = data.with_opening_date_count > 0 
                    ? (fullyCompletedCount / data.with_opening_date_count * 100).toFixed(1) 
                    : '0.0';
                document.getElementById('fully-completed-count').textContent = fullyCompletedCount.toLocaleString();
                document.getElementById('fully-completed-rate').textContent = `é–‹åº—æ—¥ã‚ã‚Šã®${fullyCompletedRate}%`;
                
                // ã‚°ãƒ©ãƒ•ã‚’æç”»
                if (data.city_stats) {
                    drawCityChart(data.city_stats);
                }
                if (data.prefecture_stats) {
                    drawPrefectureChart(data.prefecture_stats);
                }
                if (data.area_stats) {
                    drawAreaChart(data.area_stats);
                }
            } catch (error) {
                console.error('çµ±è¨ˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function drawCityChart(cityStats) {
            const ctx = document.getElementById('city-chart');
            if (!ctx) return;
            
            // éƒ½å¸‚ã¨åº—èˆ—æ•°ã‚’é…åˆ—ã«å¤‰æ›ã—ã€åº—èˆ—æ•°ã®é™é †ã§ã‚½ãƒ¼ãƒˆ
            const entries = Object.entries(cityStats)
                .filter(([city, count]) => count > 0)  // åº—èˆ—æ•°ãŒ0ã‚ˆã‚Šå¤§ãã„ã‚‚ã®ã®ã¿
                .sort((a, b) => b[1] - a[1]); // åº—èˆ—æ•°ã®é™é †ã§ã‚½ãƒ¼ãƒˆ
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªã„
            if (entries.length === 0) {
                if (cityChart) {
                    cityChart.destroy();
                    cityChart = null;
                }
                ctx.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">éƒ½å¸‚åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const cities = entries.map(entry => entry[0]);
            const counts = entries.map(entry => entry[1]);
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (cityChart) {
                cityChart.destroy();
            }
            
            cityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cities,
                    datasets: [{
                        label: 'åº—èˆ—æ•°',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString() + 'ä»¶';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function drawPrefectureChart(prefectureStats) {
            const ctx = document.getElementById('prefecture-chart');
            if (!ctx) return;
            
            // éƒ½é“åºœçœŒã¨åº—èˆ—æ•°ã‚’é…åˆ—ã«å¤‰æ›ã—ã€åº—èˆ—æ•°ãŒ0ã‚ˆã‚Šå¤§ãã„ã‚‚ã®ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const entries = Object.entries(prefectureStats)
                .filter(([prefecture, count]) => count > 0)  // åº—èˆ—æ•°ãŒ0ã‚ˆã‚Šå¤§ãã„ã‚‚ã®ã®ã¿
                .sort((a, b) => b[1] - a[1]); // åº—èˆ—æ•°ã®é™é †ã§ã‚½ãƒ¼ãƒˆ
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªã„
            if (entries.length === 0) {
                if (prefectureChart) {
                    prefectureChart.destroy();
                    prefectureChart = null;
                }
                ctx.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">éƒ½é“åºœçœŒåˆ¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const prefectures = entries.map(entry => entry[0]);
            const counts = entries.map(entry => entry[1]);
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (prefectureChart) {
                prefectureChart.destroy();
            }
            
            // æœ€å¤§å€¤ã‚’å–å¾—ã—ã¦Xè»¸ã®æœ€å¤§å€¤ã‚’è¨­å®š
            const maxCount = Math.max(...counts);
            const maxTick = Math.ceil(maxCount * 1.1); // æœ€å¤§å€¤ã®110%ã‚’ä¸Šé™ã¨ã™ã‚‹
            
            prefectureChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: prefectures,
                    datasets: [{
                        label: 'åº—èˆ—æ•°',
                        data: counts,
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',  // æ¨ªæ£’ã‚°ãƒ©ãƒ•
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x || 0;
                                    return value.toLocaleString() + 'ä»¶';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: maxTick,  // æœ€å¤§å€¤ã‚’è¨­å®š
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                },
                                stepSize: Math.ceil(maxTick / 10)  // é©åˆ‡ãªé–“éš”ã§è¡¨ç¤º
                            }
                        },
                        y: {
                            reverse: false,  // ä¸Šã‹ã‚‰ä¸‹ã¸é™é †ï¼ˆåº—èˆ—æ•°ã®å¤šã„é †ï¼‰
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawAreaChart(areaStats) {
            const ctx = document.getElementById('area-chart');
            if (!ctx) return;
            
            const areas = Object.keys(areaStats);
            const counts = Object.values(areaStats);
            
            // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
            const colors = [
                'rgba(59, 130, 246, 0.6)',   // é’
                'rgba(16, 185, 129, 0.6)',   // ç·‘
                'rgba(245, 158, 11, 0.6)',   // é»„
                'rgba(239, 68, 68, 0.6)',    // èµ¤
                'rgba(139, 92, 246, 0.6)',   // ç´«
                'rgba(236, 72, 153, 0.6)',   // ãƒ”ãƒ³ã‚¯
                'rgba(20, 184, 166, 0.6)',   // ãƒ†ã‚£ãƒ¼ãƒ«
                'rgba(251, 146, 60, 0.6)',   // ã‚ªãƒ¬ãƒ³ã‚¸
                'rgba(99, 102, 241, 0.6)',   // ã‚¤ãƒ³ãƒ‡ã‚£ã‚´
                'rgba(168, 85, 247, 0.6)'    // ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆ
            ];
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (areaChart) {
                areaChart.destroy();
            }
            
            areaChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: areas,
                    datasets: [{
                        label: 'åº—èˆ—æ•°',
                        data: counts,
                        backgroundColor: areas.map((_, i) => colors[i % colors.length]),
                        borderColor: areas.map((_, i) => colors[i % colors.length].replace('0.6', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString()}ä»¶ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadAreas() {
            try {
                const response = await fetch(`${STORE_API_BASE}/api/areas`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                const data = await response.json();
                const container = document.getElementById('area-filter-container');
                container.innerHTML = '';
                data.areas.forEach(area => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center p-1.5 hover:bg-gray-100 cursor-pointer rounded';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = area;
                    checkbox.className = 'mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
                    checkbox.addEventListener('change', handleAreaChange);
                    const span = document.createElement('span');
                    span.textContent = area;
                    span.className = 'text-xs text-gray-700 font-medium';
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    container.appendChild(label);
                });
            } catch (error) {
                console.error('ã‚¨ãƒªã‚¢ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function handleAreaChange(e) {
            const area = e.target.value;
            const isChecked = e.target.checked;
            try {
                const response = await fetch(`${STORE_API_BASE}/api/areas`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                const data = await response.json();
                if (isChecked) {
                    const areaPrefectures = data.area_prefectures[area] || [];
                    areaPrefectures.forEach(pref => {
                        if (!currentFilters.prefectures.includes(pref)) {
                            currentFilters.prefectures.push(pref);
                        }
                        const checkbox = document.querySelector(`#prefecture-filter-container input[value="${pref}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else {
                    const areaPrefectures = data.area_prefectures[area] || [];
                    areaPrefectures.forEach(pref => {
                        const index = currentFilters.prefectures.indexOf(pref);
                        if (index > -1) currentFilters.prefectures.splice(index, 1);
                        const checkbox = document.querySelector(`#prefecture-filter-container input[value="${pref}"]`);
                        if (checkbox) checkbox.checked = false;
                    });
                }
                await updateCitiesFromPrefectures();
                loadStores(1);
            } catch (error) {
                console.error('ã‚¨ãƒªã‚¢å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function loadPrefectures() {
            try {
                const response = await fetch(`${STORE_API_BASE}/api/prefectures`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                const data = await response.json();
                const container = document.getElementById('prefecture-filter-container');
                container.innerHTML = '';
                data.prefectures.forEach(prefecture => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center p-1.5 hover:bg-gray-100 cursor-pointer rounded';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = prefecture;
                    checkbox.className = 'mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
                    checkbox.addEventListener('change', handlePrefectureChange);
                    const span = document.createElement('span');
                    span.textContent = prefecture;
                    span.className = 'text-xs text-gray-700';
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    container.appendChild(label);
                });
            } catch (error) {
                console.error('éƒ½é“åºœçœŒãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function handlePrefectureChange(e) {
            const prefecture = e.target.value;
            const isChecked = e.target.checked;
            if (isChecked) {
                if (!currentFilters.prefectures.includes(prefecture)) {
                    currentFilters.prefectures.push(prefecture);
                }
            } else {
                const index = currentFilters.prefectures.indexOf(prefecture);
                if (index > -1) currentFilters.prefectures.splice(index, 1);
            }
            await updateCitiesFromPrefectures();
            loadStores(1);
        }

        let allCitiesData = [];

        async function updateCitiesFromPrefectures() {
            const citySearchInput = document.getElementById('city-search-input');
            if (currentFilters.prefectures.length === 0) {
                document.getElementById('city-filter-container').innerHTML = '<p class="text-xs text-gray-500">éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
                citySearchInput.style.display = 'none';
                allCitiesData = [];
                currentFilters.cities = [];
                return;
            }
            allCitiesData = [];
            for (const pref of currentFilters.prefectures) {
                try {
                    const response = await fetch(`${STORE_API_BASE}/api/cities?prefecture=${encodeURIComponent(pref)}`, {
                        headers: {
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });
                    const data = await response.json();
                    allCitiesData.push(...data.cities);
                } catch (error) {
                    console.error(`å¸‚åŒºç”ºæ‘å–å¾—ã‚¨ãƒ©ãƒ¼ (${pref}):`, error);
                }
            }
            allCitiesData = [...new Set(allCitiesData)].sort();
            citySearchInput.style.display = 'block';
            filterAndDisplayCities();
            updateSelectedCitiesDisplay();
        }

        function updateSelectedCitiesDisplay() {
            const displaySection = document.getElementById('selected-cities-display');
            const container = document.getElementById('selected-cities-container');
            if (currentFilters.cities.length === 0) {
                displaySection.style.display = 'none';
                return;
            }
            displaySection.style.display = 'block';
            container.innerHTML = '';
            currentFilters.cities.forEach((city, index) => {
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center px-3 py-1.5 bg-blue-600 text-white rounded-full text-xs font-medium mr-2 mb-2';
                const span = document.createElement('span');
                span.textContent = city;
                span.className = 'mr-2';
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Ã—';
                removeBtn.className = 'hover:bg-blue-700 rounded-full w-5 h-5 flex items-center justify-center font-bold';
                removeBtn.type = 'button';
                removeBtn.addEventListener('click', () => {
                    const cityIndex = currentFilters.cities.indexOf(city);
                    if (cityIndex > -1) currentFilters.cities.splice(cityIndex, 1);
                    const checkbox = document.querySelector(`#city-filter-container input[value="${city}"]`);
                    if (checkbox) checkbox.checked = false;
                    updateSelectedCitiesDisplay();
                    filterAndDisplayCities();
                    loadStores(1);
                });
                tag.appendChild(span);
                tag.appendChild(removeBtn);
                container.appendChild(tag);
            });
        }

        function filterAndDisplayCities() {
            const searchQuery = document.getElementById('city-search-input').value.toLowerCase().trim();
            const container = document.getElementById('city-filter-container');
            container.innerHTML = '';
            if (allCitiesData.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500">å¸‚åŒºç”ºæ‘ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            const filteredCities = searchQuery
                ? allCitiesData.filter(city => city.toLowerCase().includes(searchQuery))
                : allCitiesData;
            if (filteredCities.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500">è©²å½“ã™ã‚‹å¸‚åŒºç”ºæ‘ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            filteredCities.forEach(city => {
                const isChecked = currentFilters.cities.includes(city);
                const label = document.createElement('label');
                label.className = `flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded ${isChecked ? 'bg-blue-50' : ''}`;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = city;
                checkbox.className = 'mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
                checkbox.checked = isChecked;
                checkbox.addEventListener('change', (e) => {
                    const cityValue = e.target.value;
                    const isNowChecked = e.target.checked;
                    if (isNowChecked) {
                        if (!currentFilters.cities.includes(cityValue)) {
                            currentFilters.cities.push(cityValue);
                        }
                    } else {
                        const index = currentFilters.cities.indexOf(cityValue);
                        if (index > -1) currentFilters.cities.splice(index, 1);
                    }
                    updateSelectedCitiesDisplay();
                    filterAndDisplayCities();
                    loadStores(1);
                });
                const span = document.createElement('span');
                span.textContent = city;
                span.className = `text-sm ${isChecked ? 'text-blue-700 font-semibold' : 'text-gray-700'}`;
                label.appendChild(checkbox);
                label.appendChild(span);
                container.appendChild(label);
            });
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${STORE_API_BASE}/api/categories`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                const data = await response.json();
                allCategoriesData = [];
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—å½¢å¼ã®å ´åˆ
                if (Array.isArray(data.categories)) {
                    allCategoriesData = data.categories;
                } 
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰ã®å ´åˆ
                else if (data.categories && typeof data.categories === 'object') {
                    for (const [group, categories] of Object.entries(data.categories)) {
                        if (Array.isArray(categories)) {
                            categories.forEach(cat => {
                                if (!allCategoriesData.includes(cat)) {
                                    allCategoriesData.push(cat);
                                }
                            });
                        }
                    }
                }
                
                allCategoriesData.sort();
                document.getElementById('category-search-input').style.display = 'block';
                filterAndDisplayCategories();
            } catch (error) {
                console.error('ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function filterAndDisplayCategories() {
            const searchQuery = document.getElementById('category-search-input').value.toLowerCase().trim();
            const container = document.getElementById('category-filter-container');
            container.innerHTML = '';
            if (allCategoriesData.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500">ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                updateSelectAllButton();
                return;
            }
            const filteredCategories = searchQuery
                ? allCategoriesData.filter(cat => cat.toLowerCase().includes(searchQuery))
                : allCategoriesData;
            if (filteredCategories.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500">è©²å½“ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                updateSelectAllButton();
                return;
            }
            filteredCategories.forEach(category => {
                const isChecked = currentFilters.categories.includes(category);
                const label = document.createElement('label');
                label.className = `flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded ${isChecked ? 'bg-purple-50' : ''}`;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = category;
                checkbox.className = 'mr-2 w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500';
                checkbox.checked = isChecked;
                checkbox.addEventListener('change', (e) => {
                    const categoryValue = e.target.value;
                    const isNowChecked = e.target.checked;
                    if (isNowChecked) {
                        if (!currentFilters.categories.includes(categoryValue)) {
                            currentFilters.categories.push(categoryValue);
                        }
                    } else {
                        const index = currentFilters.categories.indexOf(categoryValue);
                        if (index > -1) currentFilters.categories.splice(index, 1);
                    }
                    updateSelectedCategoriesDisplay();
                    updateSelectAllButton();
                    filterAndDisplayCategories();
                    loadStores(1);
                });
                const span = document.createElement('span');
                span.textContent = category;
                span.className = `text-sm ${isChecked ? 'text-purple-700 font-semibold' : 'text-gray-700'}`;
                label.appendChild(checkbox);
                label.appendChild(span);
                container.appendChild(label);
            });
            updateSelectAllButton();
        }

        function updateSelectAllButton() {
            const selectAllBtn = document.getElementById('select-all-categories-btn');
            if (!selectAllBtn) return;
            
            const searchQuery = document.getElementById('category-search-input').value.toLowerCase().trim();
            const filteredCategories = searchQuery
                ? allCategoriesData.filter(cat => cat.toLowerCase().includes(searchQuery))
                : allCategoriesData;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã™ã¹ã¦é¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const allSelected = filteredCategories.length > 0 && 
                filteredCategories.every(cat => currentFilters.categories.includes(cat));
            
            if (allSelected) {
                selectAllBtn.textContent = 'å…¨é¸æŠè§£é™¤';
                selectAllBtn.className = 'text-xs px-3 py-1 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors';
            } else {
                selectAllBtn.textContent = 'å…¨ä»¶é¸æŠ';
                selectAllBtn.className = 'text-xs px-3 py-1 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors';
            }
        }

        function handleSelectAllCategories() {
            const searchQuery = document.getElementById('category-search-input').value.toLowerCase().trim();
            const filteredCategories = searchQuery
                ? allCategoriesData.filter(cat => cat.toLowerCase().includes(searchQuery))
                : allCategoriesData;
            
            if (filteredCategories.length === 0) return;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã™ã¹ã¦é¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const allSelected = filteredCategories.every(cat => currentFilters.categories.includes(cat));
            
            if (allSelected) {
                // å…¨é¸æŠè§£é™¤ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã¿ã‚’è§£é™¤
                filteredCategories.forEach(category => {
                    const index = currentFilters.categories.indexOf(category);
                    if (index > -1) {
                        currentFilters.categories.splice(index, 1);
                    }
                });
            } else {
                // å…¨ä»¶é¸æŠï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ã™ã¹ã¦é¸æŠ
                filteredCategories.forEach(category => {
                    if (!currentFilters.categories.includes(category)) {
                        currentFilters.categories.push(category);
                    }
                });
            }
            
            updateSelectedCategoriesDisplay();
            updateSelectAllButton();
            filterAndDisplayCategories();
            loadStores(1);
        }

        function updateSelectedCategoriesDisplay() {
            const displaySection = document.getElementById('selected-categories-display');
            const container = document.getElementById('selected-categories-container');
            if (currentFilters.categories.length === 0) {
                displaySection.style.display = 'none';
                return;
            }
            displaySection.style.display = 'block';
            container.innerHTML = '';
            currentFilters.categories.forEach((category) => {
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center px-3 py-1.5 bg-purple-600 text-white rounded-full text-xs font-medium mr-2 mb-2';
                const span = document.createElement('span');
                span.textContent = category;
                span.className = 'mr-2';
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Ã—';
                removeBtn.className = 'hover:bg-purple-700 rounded-full w-5 h-5 flex items-center justify-center font-bold';
                removeBtn.type = 'button';
                removeBtn.addEventListener('click', () => {
                    const categoryIndex = currentFilters.categories.indexOf(category);
                    if (categoryIndex > -1) currentFilters.categories.splice(categoryIndex, 1);
                    const checkbox = document.querySelector(`#category-filter-container input[value="${category}"]`);
                    if (checkbox) checkbox.checked = false;
                    updateSelectedCategoriesDisplay();
                    filterAndDisplayCategories();
                    loadStores(1);
                });
                tag.appendChild(span);
                tag.appendChild(removeBtn);
                container.appendChild(tag);
            });
        }

        async function loadStores(page = 1) {
            const loading = document.getElementById('loading');
            const container = document.getElementById('stores-container');
            loading.style.display = 'block';
            container.innerHTML = '';
            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: 100,
                    search: currentFilters.search,
                    search_mode: currentFilters.searchMode,
                    match_type: currentFilters.matchType
                });
                currentFilters.categories.forEach(cat => params.append('categories', cat));
                currentFilters.prefectures.forEach(pref => params.append('prefectures', pref));
                currentFilters.cities.forEach(city => params.append('cities', city));
                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (currentFilters.dataSources.length > 0 && currentFilters.dataSources.length < DATA_SOURCES.length) {
                    currentFilters.dataSources.forEach(source => params.append('data_sources', source));
                }
                if (currentFilters.phone) params.append('phone', currentFilters.phone);
                if (currentFilters.website) params.append('website', currentFilters.website);
                if (currentFilters.ratingValue) {
                    params.append('rating_operator', currentFilters.ratingOperator);
                    params.append('rating_value', currentFilters.ratingValue);
                }
                if (currentFilters.fullyCompleted) {
                    params.append('fully_completed', 'true');
                }
                const response = await fetch(`${STORE_API_BASE}/api/stores?${params}`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                loading.style.display = 'none';
                if (!data || !data.stores) {
                    // åˆ—æ•°ã‚’å‹•çš„ã«å–å¾—
                    const headerRow = document.querySelector('thead tr');
                    const columnCount = headerRow ? headerRow.querySelectorAll('th').length : 15;
                    container.innerHTML = `<tr><td colspan="${columnCount}" class="px-6 py-8 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>`;
                    return;
                }
                if (data.stores.length === 0) {
                    // åˆ—æ•°ã‚’å‹•çš„ã«å–å¾—
                    const headerRow = document.querySelector('thead tr');
                    const columnCount = headerRow ? headerRow.querySelectorAll('th').length : 15;
                    container.innerHTML = `<tr><td colspan="${columnCount}" class="px-6 py-8 text-center text-gray-500">åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>`;
                    return;
                }
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
                let filteredStores = data.stores;
                
                // åº—èˆ—åãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerName) {
                    const nameFilters = currentFilters.headerName.split('|').filter(f => f);
                    if (nameFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => 
                            nameFilters.some(filter => (store.name || '').includes(filter))
                        );
                    }
                }
                
                // ä½æ‰€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerAddress) {
                    const addressFilters = currentFilters.headerAddress.split('|').filter(f => f);
                    if (addressFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => 
                            addressFilters.some(filter => (store.address || '').includes(filter))
                        );
                    }
                }
                
                // é€£çµ¡å…ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerContact) {
                    const contactFilters = currentFilters.headerContact.split('|').filter(f => f);
                    if (contactFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => 
                            contactFilters.some(filter => 
                                (store.phone || '').includes(filter) ||
                                (store.website || '').includes(filter)
                            )
                        );
                    }
                }
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerCategory) {
                    const categoryFilters = currentFilters.headerCategory.split('|').filter(f => f);
                    if (categoryFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => 
                            categoryFilters.some(filter => (store.category || '').includes(filter))
                        );
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.dataSources.length > 0 && currentFilters.dataSources.length < DATA_SOURCES.length) {
                    filteredStores = filteredStores.filter(store => {
                        const storeDataSource = store.data_source || '';
                        return currentFilters.dataSources.some(source => {
                            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®å€¤ã‚’æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ
                            const normalizedStoreSource = normalizeDataSourceName(storeDataSource);
                            const normalizedFilterSource = normalizeDataSourceName(source);
                            return normalizedStoreSource === normalizedFilterSource;
                        });
                    });
                }
                
                // ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã€è¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerDelivery) {
                    const deliveryFilters = currentFilters.headerDelivery.split(',').filter(f => f);
                    if (deliveryFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => {
                            const services = store.delivery_services || [];
                            // URLã‹ã‚‰ã‚‚åˆ¤å®šï¼ˆubereats.comãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
                            if (store.url && store.url.includes('ubereats.com')) {
                                services.push('Uber Eats');
                            }
                            // æ­£è¦åŒ–ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹åã§æ¯”è¼ƒ
                            const normalizedServices = services.map(normalizeDataSourceName);
                            return deliveryFilters.some(filter => {
                                const normalizedFilter = normalizeDataSourceName(filter);
                                return normalizedServices.some(s => s === normalizedFilter);
                            });
                        });
                    }
                }
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerStatus) {
                    const statusFilters = currentFilters.headerStatus.split(',').filter(f => f);
                    if (statusFilters.length > 0) {
                        filteredStores = await Promise.all(
                            filteredStores.map(async (store) => {
                                const storeStatus = await getStoreStatus(store.store_id || store.name);
                                return { store, status: storeStatus };
                            })
                        );
                        filteredStores = filteredStores
                            .filter(({ status }) => statusFilters.includes(status))
                            .map(({ store }) => store);
                    }
                }
                
                // å®šä¼‘æ—¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerClosedDay) {
                    const closedDayFilters = currentFilters.headerClosedDay.split('|').filter(f => f);
                    if (closedDayFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => 
                            closedDayFilters.some(filter => (store.closed_day || '').includes(filter))
                        );
                    }
                }
                
                // ã‚ªãƒ¼ãƒ—ãƒ³æ—¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerOpeningDate) {
                    const openingDateFilters = currentFilters.headerOpeningDate.split('|').filter(f => f);
                    if (openingDateFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => 
                            openingDateFilters.some(filter => (store.opening_date || '').includes(filter))
                        );
                    }
                }
                
                // äº¤é€šæ‰‹æ®µãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerTransport) {
                    const transportFilters = currentFilters.headerTransport.split('|').filter(f => f);
                    if (transportFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => 
                            transportFilters.some(filter => (store.transport || '').includes(filter))
                        );
                    }
                }
                
                // å–¶æ¥­æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerBusinessHours) {
                    const businessHoursFilters = currentFilters.headerBusinessHours.split('|').filter(f => f);
                    if (businessHoursFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => 
                            businessHoursFilters.some(filter => (store.business_hours || '').includes(filter))
                        );
                    }
                }
                
                // å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerOfficialAccount) {
                    const officialAccountFilters = currentFilters.headerOfficialAccount.split('|').filter(f => f);
                    if (officialAccountFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => {
                            const accounts = Array.isArray(store.official_account) 
                                ? store.official_account.join(', ') 
                                : (store.official_account || '');
                            return officialAccountFilters.some(filter => accounts.includes(filter));
                        });
                    }
                }
                
                // ãƒªã‚¹ãƒˆåé›†æ—¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¤‡æ•°å€¤å¯¾å¿œï¼‰
                if (currentFilters.headerCollectedAt) {
                    const collectedAtFilters = currentFilters.headerCollectedAt.split('|').filter(f => f);
                    if (collectedAtFilters.length > 0) {
                        filteredStores = filteredStores.filter(store => 
                            collectedAtFilters.some(filter => (store.collected_at || '').includes(filter))
                        );
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå·¦å´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
                if (currentFilters.dataSources.length > 0 && currentFilters.dataSources.length < DATA_SOURCES.length) {
                    filteredStores = filteredStores.filter(store => {
                        const storeDataSource = (store.data_source || '').toLowerCase();
                        return currentFilters.dataSources.some(source => {
                            const normalizedSource = normalizeDataSourceName(source);
                            return storeDataSource === normalizedSource;
                        });
                    });
                }
                
                if (filteredStores.length === 0) {
                    // åˆ—æ•°ã‚’å‹•çš„ã«å–å¾—ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ— + ãƒ‡ãƒ¼ã‚¿åˆ—ï¼‰
                    const headerRow = document.querySelector('thead tr');
                    const columnCount = headerRow ? headerRow.querySelectorAll('th').length : 15;
                    
                    container.innerHTML = `
                        <tr>
                            <td colspan="${columnCount}" class="px-6 py-16">
                                <div class="flex flex-col items-center justify-center text-center">
                                    <div class="mb-4">
                                        <svg class="w-16 h-16 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-700 mb-2">è©²å½“ã™ã‚‹åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h3>
                                    <p class="text-sm text-gray-500 mb-6 max-w-md">
                                        ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                                        ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ãƒªã‚»ãƒƒãƒˆã—ã¦å†åº¦æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚
                                    </p>
                                    <button 
                                        onclick="resetFilters()" 
                                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 font-medium shadow-sm"
                                    >
                                        ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°
                    const paginationInfo = document.getElementById('pagination-info');
                    if (paginationInfo) {
                        paginationInfo.textContent = '0ä»¶ä¸­ 0-0ä»¶ã‚’è¡¨ç¤º';
                    }
                    
                    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                    const pagination = document.getElementById('pagination');
                    if (pagination) {
                        pagination.innerHTML = '';
                    }
                    
                    return;
                }
                
                // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼ˆä¿å­˜æ©Ÿèƒ½ç”¨ï¼‰
                if (!window.currentStores) {
                    window.currentStores = {};
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                for (const store of filteredStores) {
                    window.currentStores[store.store_id || store.name] = store;
                }
                
                // ã‚½ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é©ç”¨
                if (currentSortColumn && currentSortDirection) {
                    applySort();
                } else {
                    // ã‚½ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯é€šå¸¸é€šã‚Šè¡¨ç¤º
                    for (const store of filteredStores) {
                        const row = await createStoreTableRow(store);
                        container.appendChild(row);
                    }
                }
                
                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œã®ä»¶æ•°ï¼‰
                let paginationInfo = document.getElementById('pagination-info');
                if (paginationInfo) {
                    paginationInfo.textContent = 
                        `${filteredStores.length}ä»¶ä¸­ ${((page - 1) * (data.per_page || 100)) + 1}-${Math.min(page * (data.per_page || 100), filteredStores.length)}ä»¶ã‚’è¡¨ç¤º`;
                }

                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¦‚è¦ã‚’æ›´æ–°
                updateActiveFiltersBar(filteredStores.length, data.total || filteredStores.length);

                if (data.total_pages) renderPagination(page, data.total_pages);
                currentPage = page;
            } catch (error) {
                loading.style.display = 'none';
                // åˆ—æ•°ã‚’å‹•çš„ã«å–å¾—
                const headerRow = document.querySelector('thead tr');
                const columnCount = headerRow ? headerRow.querySelectorAll('th').length : 15;
                container.innerHTML = `<tr><td colspan="${columnCount}" class="px-6 py-8 text-center text-red-500">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Flaskã‚¢ãƒ—ãƒªãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</td></tr>`;
                console.error('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ç¾åœ¨ã®æ¤œç´¢çµæœã‚’ä¿å­˜ï¼ˆæ”¹å–„ç‰ˆï¼‰
        async function saveCurrentSearchResults() {
            if (!window.currentStores || Object.keys(window.currentStores).length === 0) {
                alert('ä¿å­˜ã™ã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const listName = prompt('ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!listName) return;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ
            const statusChoice = confirm('æˆç´„æ¸ˆã¿ãƒªã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠã™ã‚‹ã¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãƒªã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ï¼‰');
            const status = statusChoice ? 'contracted' : 'approach';
            
            const stores = Object.values(window.currentStores);
            // å„åº—èˆ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã—ã¦ä¿å­˜
            for (const store of stores) {
                const storeId = store.store_id || store.name;
                const currentStoreStatus = await getStoreStatus(storeId);
                if (currentStoreStatus !== 'none') {
                    store.status = currentStoreStatus;
                }
            }
            
            await saveList(listName, stores, status);
            alert(`ã€Œ${listName}ã€ã«${stores.length}ä»¶ã®åº—èˆ—ã‚’${status === 'contracted' ? 'æˆç´„æ¸ˆã¿ã¨ã—ã¦' : 'ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­ã¨ã—ã¦'}ä¿å­˜ã—ã¾ã—ãŸ`);
        }

        async function createStoreTableRow(store) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors border-b border-gray-100';
            row.dataset.storeId = store.store_id || store.name;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚»ãƒ«
            const checkboxCell = document.createElement('td');
            checkboxCell.className = 'px-6 py-4';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'store-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
            checkbox.dataset.storeId = store.store_id || store.name;
            checkbox.addEventListener('change', updateSelectedCount);
            checkboxCell.appendChild(checkbox);
            
            const nameCell = document.createElement('td');
            nameCell.className = 'px-6 py-4 align-top';
            const nameDiv = document.createElement('div');
            nameDiv.className = 'text-sm font-medium text-gray-900 store-name-cell';
            nameDiv.style.wordBreak = 'break-word';
            nameDiv.style.maxWidth = '320px'; // 20æ–‡å­—åˆ†ã®å¹…ï¼ˆæ—¥æœ¬èª1æ–‡å­—ç´„16px Ã— 20æ–‡å­—ï¼‰
            nameDiv.style.minWidth = '320px';
            nameDiv.style.lineHeight = '1.5';
            const nameText = store.name || 'åç§°ä¸æ˜';
            // 20æ–‡å­—ã”ã¨ã«æ”¹è¡Œã‚’æŒ¿å…¥
            let formattedName = '';
            for (let i = 0; i < nameText.length; i += 20) {
                if (i > 0) formattedName += '\n';
                formattedName += nameText.substring(i, i + 20);
            }
            nameDiv.textContent = formattedName;
            nameDiv.style.whiteSpace = 'pre-wrap';
            nameCell.appendChild(nameDiv);
            if (store.url) {
                const link = document.createElement('a');
                link.href = store.url;
                link.target = '_blank';
                link.className = 'text-xs text-blue-600 hover:underline ml-2';
                link.textContent = 'â†’';
                nameDiv.appendChild(link);
            }
            const addressCell = document.createElement('td');
            addressCell.className = 'px-6 py-4 store-address-cell';
            const addressDiv = document.createElement('div');
            addressDiv.className = 'text-sm text-gray-900';
            addressDiv.style.wordBreak = 'break-word';
            addressDiv.style.maxWidth = '320px'; // 20æ–‡å­—åˆ†ã®å¹…ï¼ˆæ—¥æœ¬èª1æ–‡å­—ç´„16px Ã— 20æ–‡å­—ï¼‰
            addressDiv.style.minWidth = '320px';
            addressDiv.style.lineHeight = '1.5';
            let addressText = store.address || 'æœªå–å¾—';
            
            // è¡¨ç¤ºç”¨ã«ä½æ‰€æ–‡å­—åˆ—ã‚’ç°¡æ˜“æ­£è¦åŒ–ï¼ˆé‡è¤‡ã‚„ "Japan," ã‚’é™¤å»ï¼‰
            addressText = normalizeAddressToJapanese(addressText);
            // 20æ–‡å­—ã”ã¨ã«æ”¹è¡Œã‚’æŒ¿å…¥
            let formattedAddress = '';
            for (let i = 0; i < addressText.length; i += 20) {
                if (i > 0) formattedAddress += '\n';
                formattedAddress += addressText.substring(i, i + 20);
            }
            addressDiv.textContent = formattedAddress;
            addressDiv.style.whiteSpace = 'pre-wrap';
            
            // Googleãƒãƒƒãƒ—ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ ï¼ˆåº—èˆ—åã‚’å„ªå…ˆã€ä½æ‰€ãƒ»åº§æ¨™ã‚’è£œåŠ©çš„ã«ä½¿ç”¨ï¼‰
            if (store.name || store.address || (store.location_lat && store.location_lng)) {
                const mapLink = document.createElement('a');
                let mapUrl = '';
                const storeName = store.name || '';
                
                // å„ªå…ˆé †ä½: 1. åº—èˆ—å + ä½æ‰€, 2. åº—èˆ—åã®ã¿, 3. åº§æ¨™, 4. ä½æ‰€ã®ã¿
                if (storeName && addressText && addressText !== 'æœªå–å¾—') {
                    // åº—èˆ—åã¨ä½æ‰€ã®ä¸¡æ–¹ãŒã‚ã‚‹å ´åˆã¯ã€åº—èˆ—åã‚’å„ªå…ˆã—ã¦æ¤œç´¢ï¼ˆç²¾åº¦ãŒé«˜ã„ï¼‰
                    const query = `${storeName} ${addressText}`;
                    mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                } else if (storeName) {
                    // åº—èˆ—åã®ã¿
                    mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(storeName)}`;
                } else if (store.location_lat && store.location_lng) {
                    // åº§æ¨™
                    mapUrl = `https://www.google.com/maps?q=${store.location_lat},${store.location_lng}`;
                } else if (addressText && addressText !== 'æœªå–å¾—') {
                    // ä½æ‰€ã®ã¿
                    mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addressText)}`;
                }
                
                if (mapUrl) {
                    mapLink.href = mapUrl;
                    mapLink.target = '_blank';
                    mapLink.rel = 'noopener noreferrer';
                    mapLink.className = 'ml-2 text-blue-600 hover:underline text-xs';
                    mapLink.innerHTML = 'ğŸ—ºï¸ åœ°å›³';
                    mapLink.title = 'Googleãƒãƒƒãƒ—ã§é–‹ã';
                    addressDiv.appendChild(mapLink);
                }
            }
            addressCell.appendChild(addressDiv);
            const contactCell = document.createElement('td');
            contactCell.className = 'px-6 py-4';
            const contactDiv = document.createElement('div');
            contactDiv.className = 'text-sm text-gray-900 space-y-2';
            const phoneDiv = document.createElement('div');
            phoneDiv.className = 'flex items-center';
            if (store.phone) {
                const phoneIcon = document.createElement('span');
                phoneIcon.className = 'mr-2 text-gray-500';
                phoneIcon.textContent = 'ğŸ“';
                const phoneLink = document.createElement('a');
                phoneLink.href = `tel:${store.phone}`;
                phoneLink.className = 'text-blue-600 hover:underline font-medium';
                phoneLink.textContent = store.phone;
                phoneDiv.appendChild(phoneIcon);
                phoneDiv.appendChild(phoneLink);
            } else {
                phoneDiv.className = 'text-gray-400 text-xs';
                phoneDiv.textContent = 'ğŸ“ æœªå–å¾—';
            }
            contactDiv.appendChild(phoneDiv);
            const websiteDiv = document.createElement('div');
            websiteDiv.className = 'flex items-center';
            if (store.website) {
                const websiteIcon = document.createElement('span');
                websiteIcon.className = 'mr-2 text-gray-500';
                websiteIcon.textContent = 'ğŸŒ';
                const websiteLink = document.createElement('a');
                websiteLink.href = store.website;
                websiteLink.target = '_blank';
                websiteLink.rel = 'noopener noreferrer';
                websiteLink.className = 'text-blue-600 hover:underline break-all max-w-xs';
                let displayUrl = store.website.replace(/^https?:\/\//, '').replace(/^www\./, '');
                if (displayUrl.length > 35) displayUrl = displayUrl.substring(0, 35) + '...';
                websiteLink.textContent = displayUrl;
                websiteLink.title = store.website;
                websiteDiv.appendChild(websiteIcon);
                websiteDiv.appendChild(websiteLink);
            } else {
                websiteDiv.className = 'text-gray-400 text-xs';
                websiteDiv.textContent = 'ğŸŒ æœªå–å¾—';
            }
            contactDiv.appendChild(websiteDiv);
            contactCell.appendChild(contactDiv);
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚»ãƒ«ï¼ˆ10æ–‡å­—ã”ã¨ã«æŠ˜ã‚Šè¿”ã—ï¼‰
            const categoryCell = document.createElement('td');
            categoryCell.className = 'px-6 py-4 whitespace-nowrap';
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'text-sm text-gray-900';
            const categoryText = store.category || 'æœªè¨­å®š';
            let formattedCategory = '';
            for (let i = 0; i < categoryText.length; i += 10) {
                if (i > 0) formattedCategory += '\n';
                formattedCategory += categoryText.substring(i, i + 10);
            }
            categoryDiv.textContent = formattedCategory;
            categoryDiv.style.whiteSpace = 'pre-wrap';
            categoryCell.appendChild(categoryDiv);
            // å®šä¼‘æ—¥ã‚»ãƒ«
            const closedCell = document.createElement('td');
            closedCell.className = 'px-6 py-4 whitespace-nowrap';
            const closedDiv = document.createElement('div');
            closedDiv.className = 'text-sm text-gray-900';
            if (store.closed_day) {
                closedDiv.textContent = store.closed_day;
            } else {
                closedDiv.className = 'text-gray-400 text-xs';
                closedDiv.textContent = 'æœªè¨­å®š';
            }
            closedCell.appendChild(closedDiv);
            // ã‚ªãƒ¼ãƒ—ãƒ³æ—¥ã‚»ãƒ«
            const openingCell = document.createElement('td');
            openingCell.className = 'px-6 py-4 whitespace-nowrap';
            const openingDiv = document.createElement('div');
            openingDiv.className = 'text-sm text-gray-900';
            if (store.opening_date) {
                openingDiv.textContent = store.opening_date;
            } else {
                openingDiv.className = 'text-gray-400 text-xs';
                openingDiv.textContent = 'æœªå–å¾—';
            }
            openingCell.appendChild(openingDiv);
            // äº¤é€šæ‰‹æ®µã‚»ãƒ«ï¼ˆ10æ–‡å­—ã”ã¨ã«æŠ˜ã‚Šè¿”ã—ï¼‰
            const transportCell = document.createElement('td');
            transportCell.className = 'px-6 py-4 whitespace-nowrap';
            const transportDiv = document.createElement('div');
            transportDiv.className = 'text-sm text-gray-900';
            if (store.transport) {
                const transportText = store.transport;
                let formattedTransport = '';
                for (let i = 0; i < transportText.length; i += 10) {
                    if (i > 0) formattedTransport += '\n';
                    formattedTransport += transportText.substring(i, i + 10);
                }
                transportDiv.textContent = formattedTransport;
                transportDiv.style.whiteSpace = 'pre-wrap';
            } else {
                transportDiv.className = 'text-gray-400 text-xs';
                transportDiv.textContent = 'æœªå–å¾—';
            }
            transportCell.appendChild(transportDiv);
            // å–¶æ¥­æ™‚é–“ã‚»ãƒ«ï¼ˆ10æ–‡å­—ã”ã¨ã«æŠ˜ã‚Šè¿”ã—ï¼‰
            const businessHoursCell = document.createElement('td');
            businessHoursCell.className = 'px-6 py-4';
            const businessHoursDiv = document.createElement('div');
            businessHoursDiv.className = 'text-sm text-gray-900 max-w-xs';
            if (store.business_hours) {
                const bhText = store.business_hours;
                let formattedBH = '';
                for (let i = 0; i < bhText.length; i += 10) {
                    if (i > 0) formattedBH += '\n';
                    formattedBH += bhText.substring(i, i + 10);
                }
                businessHoursDiv.textContent = formattedBH;
                businessHoursDiv.title = store.business_hours;
                businessHoursDiv.style.whiteSpace = 'pre-wrap';
            } else {
                businessHoursDiv.className = 'text-gray-400 text-xs';
                businessHoursDiv.textContent = 'æœªå–å¾—';
            }
            businessHoursCell.appendChild(businessHoursDiv);
            // å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚»ãƒ«
            const officialAccountCell = document.createElement('td');
            officialAccountCell.className = 'px-6 py-4 store-official-account-cell';
            const officialAccountDiv = document.createElement('div');
            officialAccountDiv.className = 'flex flex-nowrap gap-1 overflow-hidden';
            officialAccountDiv.style.whiteSpace = 'nowrap';
            const officialAccounts = Array.isArray(store.official_account) ? store.official_account : (store.official_account ? store.official_account.split(',') : []);
            if (officialAccounts.length > 0) {
                officialAccounts.forEach(url => {
                    if (url.trim()) {
                        const link = document.createElement('a');
                        link.href = url.trim();
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = 'inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 hover:bg-blue-200';
                        let icon = 'ğŸ”—';
                        if (url.includes('twitter.com') || url.includes('x.com')) icon = 'ğŸ¦';
                        else if (url.includes('instagram.com')) icon = 'ğŸ“·';
                        else if (url.includes('facebook.com')) icon = 'ğŸ‘¥';
                        link.textContent = icon;
                        link.title = url.trim();
                        officialAccountDiv.appendChild(link);
                    }
                });
            } else {
                const noAccount = document.createElement('span');
                noAccount.className = 'text-gray-400 text-xs';
                noAccount.textContent = 'æœªå–å¾—';
                officialAccountDiv.appendChild(noAccount);
            }
            officialAccountCell.appendChild(officialAccountDiv);
            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚»ãƒ«
            const dataSourceCell = document.createElement('td');
            dataSourceCell.className = 'px-6 py-4 whitespace-nowrap';
            const dataSourceDiv = document.createElement('div');
            const sourceBadge = document.createElement('span');
            sourceBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium';
            const dataSource = store.data_source || '';
            if (dataSource === 'tabelog') {
                sourceBadge.className += ' bg-orange-100 text-orange-800';
                sourceBadge.textContent = 'é£Ÿã¹ãƒ­ã‚°';
            } else if (dataSource === 'google_places_api') {
                sourceBadge.className += ' bg-blue-100 text-blue-800';
                sourceBadge.textContent = 'Googleãƒãƒƒãƒ—';
            } else if (dataSource === 'ubereats') {
                sourceBadge.className += ' bg-green-100 text-green-800';
                sourceBadge.textContent = 'Uber Eats';
            } else {
                sourceBadge.className += ' bg-gray-100 text-gray-800';
                sourceBadge.textContent = dataSource || 'ãã®ä»–';
            }
            dataSourceDiv.appendChild(sourceBadge);
            dataSourceCell.appendChild(dataSourceDiv);
            // ãƒªã‚¹ãƒˆåé›†æ—¥ã‚»ãƒ«
            const collectedAtCell = document.createElement('td');
            collectedAtCell.className = 'px-6 py-4 store-collected-at-cell';
            const collectedAtDiv = document.createElement('div');
            collectedAtDiv.className = 'text-sm text-gray-900';
            collectedAtDiv.style.whiteSpace = 'nowrap';
            collectedAtDiv.style.overflow = 'hidden';
            collectedAtDiv.style.textOverflow = 'ellipsis';
            if (store.collected_at) {
                collectedAtDiv.textContent = store.collected_at;
            } else {
                collectedAtDiv.className = 'text-gray-400 text-xs';
                collectedAtDiv.textContent = 'æœªè¨­å®š';
            }
            collectedAtCell.appendChild(collectedAtDiv);
            const deliveryCell = document.createElement('td');
            deliveryCell.className = 'px-6 py-4 store-delivery-cell';
            const deliveryDiv = document.createElement('div');
            deliveryDiv.className = 'flex flex-nowrap gap-1 overflow-hidden';
            deliveryDiv.style.whiteSpace = 'nowrap';
            const deliveryServices = store.delivery_services || [];
            const serviceSet = new Set();
            deliveryServices.forEach(service => serviceSet.add(service));
            if (store.url && store.url.includes('ubereats.com')) serviceSet.add('Uber Eats');
            if (serviceSet.size > 0) {
                const serviceNames = {
                    'ubereats': 'Uber Eats',
                    'Uber Eats': 'Uber Eats',
                    'wolt': 'ã‚¦ã‚©ãƒ«ãƒˆ',
                    'ã‚¦ã‚©ãƒ«ãƒˆ': 'ã‚¦ã‚©ãƒ«ãƒˆ',
                    'demaecan': 'å‡ºå‰é¤¨',
                    'å‡ºå‰é¤¨': 'å‡ºå‰é¤¨'
                };
                Array.from(serviceSet).forEach(service => {
                    const badge = document.createElement('span');
                    badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    badge.textContent = serviceNames[service] || service;
                    deliveryDiv.appendChild(badge);
                });
            } else {
                const noService = document.createElement('span');
                noService.className = 'text-gray-400 text-xs';
                noService.textContent = 'æœªå–å¾—';
                deliveryDiv.appendChild(noService);
            }
            deliveryCell.appendChild(deliveryDiv);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ«
            const statusCell = document.createElement('td');
            statusCell.className = 'px-6 py-4 whitespace-nowrap';
            const statusDiv = document.createElement('div');
            statusDiv.className = 'flex items-center gap-2';
            
            // åº—èˆ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆstoreã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«statusãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼‰
            const storeStatus = store.status || await getStoreStatus(store.store_id || store.name);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
            const statusSelect = document.createElement('select');
            statusSelect.className = `status-badge ${getStatusClass(storeStatus)} border-0 outline-none cursor-pointer`;
            statusSelect.style.appearance = 'none';
            statusSelect.style.padding = '4px 12px';
            statusSelect.style.borderRadius = '16px';
            statusSelect.style.fontSize = '12px';
            statusSelect.style.fontWeight = '500';
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            const options = [
                { value: 'none', label: 'æœªè¨­å®š', class: 'status-none' },
                { value: 'approach', label: 'ğŸ“‹ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­', class: 'status-approach' },
                { value: 'contracted', label: 'âœ… æˆç´„æ¸ˆã¿', class: 'status-contracted' }
            ];
            
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                option.selected = opt.value === storeStatus;
                statusSelect.appendChild(option);
            });
            
            statusSelect.onchange = async () => {
                const newStatus = statusSelect.value;
                await saveStoreStatus(store.store_id || store.name, newStatus);
                statusSelect.className = `status-badge ${getStatusClass(newStatus)} border-0 outline-none cursor-pointer`;
                statusSelect.style.appearance = 'none';
                statusSelect.style.padding = '4px 12px';
                statusSelect.style.borderRadius = '16px';
                statusSelect.style.fontSize = '12px';
                statusSelect.style.fontWeight = '500';
                updateStoreInLists(store.store_id || store.name, newStatus);
            };
            
            statusDiv.appendChild(statusSelect);
            
            statusCell.appendChild(statusDiv);
            
            row.appendChild(checkboxCell);
            row.appendChild(nameCell);
            row.appendChild(addressCell);
            row.appendChild(contactCell);
            row.appendChild(categoryCell);
            row.appendChild(closedCell);
            row.appendChild(openingCell);
            row.appendChild(transportCell);
            row.appendChild(businessHoursCell);
            row.appendChild(officialAccountCell);
            row.appendChild(dataSourceCell);
            row.appendChild(collectedAtCell);
            row.appendChild(deliveryCell);
            row.appendChild(statusCell);
            return row;
        }
        
        // åº—èˆ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆAPIçµŒç”±ï¼‰
        let cachedStoreStatuses = {};
        let storeStatusLoadAttempted = false; // ãƒ­ãƒ¼ãƒ‰è©¦è¡Œãƒ•ãƒ©ã‚°
        async function getStoreStatus(storeId) {
            try {
                // ä¸€åº¦ã ã‘APIã‚’å‘¼ã³å‡ºã™ï¼ˆè¤‡æ•°å›ã®å‘¼ã³å‡ºã—ã‚’é˜²ãï¼‰
                if (!storeStatusLoadAttempted && Object.keys(cachedStoreStatuses).length === 0) {
                    storeStatusLoadAttempted = true;
                    try {
                    const currentPartnerId = sessionStorage.getItem("currentPartnerId");
                        if (currentPartnerId) {
                    const data = await apiCall(`/store-statuses?rep_id=${currentPartnerId}`);
                    cachedStoreStatuses = data.statuses || {};
                        }
                    } catch (error) {
                        // ã‚¨ãƒ©ãƒ¼ã¯apiCallå†…ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
                        storeStatusLoadAttempted = false; // ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã«ã™ã‚‹
                    }
                }
                return cachedStoreStatuses[storeId] || 'none';
            } catch (error) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorageã‹ã‚‰å–å¾—
                const key = getPartnerStorageKey('storeStatuses');
                const data = localStorage.getItem(key);
                const statuses = data ? JSON.parse(data) : {};
                return statuses[storeId] || 'none';
            }
        }
        
        // åº—èˆ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿å­˜ï¼ˆAPIçµŒç”±ï¼‰
        async function saveStoreStatus(storeId, status) {
            try {
                const currentPartnerId = sessionStorage.getItem("currentPartnerId");
                if (currentPartnerId) {
                await apiCall('/store-statuses', {
                    method: 'POST',
                    body: JSON.stringify({
                        rep_id: currentPartnerId,
                        store_id: storeId,
                        status: status
                    })
                });
                }
                cachedStoreStatuses[storeId] = status;
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã¯apiCallå†…ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
            } finally {
                // å¸¸ã«localStorageã«ã‚‚ä¿å­˜ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                const key = getPartnerStorageKey('storeStatuses');
                const data = localStorage.getItem(key);
                const statuses = data ? JSON.parse(data) : {};
                statuses[storeId] = status;
                localStorage.setItem(key, JSON.stringify(statuses));
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¯ãƒ©ã‚¹åã‚’å–å¾—
        function getStatusClass(status) {
            if (status === 'contracted') return 'status-contracted';
            if (status === 'approach') return 'status-approach';
            return 'status-none';
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
        function getStatusLabel(status) {
            if (status === 'contracted') return 'âœ… æˆç´„æ¸ˆã¿';
            if (status === 'approach') return 'ğŸ“‹ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­';
            return 'æœªè¨­å®š';
        }
        
        
        // ãƒªã‚¹ãƒˆå†…ã®åº—èˆ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        async function updateStoreInLists(storeId, newStatus) {
            const lists = await getSavedLists();
            let updated = false;
            
            lists.forEach(list => {
                list.stores.forEach(store => {
                    const sId = store.store_id || store.name;
                    if (sId === storeId) {
                        store.status = newStatus;
                        updated = true;
                    }
                });
            });
            
            if (updated) {
                const key = getPartnerStorageKey('savedLists');
                localStorage.setItem(key, JSON.stringify(lists));
            }
        }
        
        // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDæ¯ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ç”Ÿæˆï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
        function getPartnerStorageKey(key) {
            const currentPartnerId = sessionStorage.getItem("currentPartnerId");
            return `partner_${currentPartnerId}_${key}`;
        }
        
        // ==================== APIå‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ====================
        // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç®¡ç†ç”¨APIã®ãƒ™ãƒ¼ã‚¹URL
        const PARTNER_API_BASE = '/api/partner';
        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãªã©ã®æ—¢å­˜APIã®ãƒ™ãƒ¼ã‚¹URL
        const STORE_API_BASE = '';
        
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${PARTNER_API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    // 404ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é™ã‹ã«å‡¦ç†ï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆï¼‰
                    if (response.status === 404) {
                        return { statuses: {} };
                    }
                    const error = await response.json().catch(() => ({ error: 'APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼' }));
                    throw new Error(error.error || 'APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼');
                }
                
                return await response.json();
            } catch (error) {
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é™ã‹ã«å‡¦ç†ï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆï¼‰
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
                    return { statuses: {} };
                }
                // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã®ã¿ï¼ˆå¤§é‡ã®ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãï¼‰
                if (!error.silent) {
                    console.warn('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ï¼ˆé™ã‹ã«å‡¦ç†ï¼‰:', endpoint, error.message);
                }
                throw error;
            }
        }
        
        // ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆAPIçµŒç”±ï¼‰
        let cachedLists = [];
        async function getSavedLists() {
            try {
                const currentPartnerId = sessionStorage.getItem("currentPartnerId");
                if (!currentPartnerId) {
                    console.warn('ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                    return [];
                }
                console.log('ãƒªã‚¹ãƒˆå–å¾—ä¸­...', currentPartnerId);
                const data = await apiCall(`/saved-lists?rep_id=${currentPartnerId}`);
                console.log('ãƒªã‚¹ãƒˆå–å¾—æˆåŠŸ:', data);
                cachedLists = (data.lists || []).map(l => ({
                    id: l.list_id,
                    name: l.name,
                    stores: Array.isArray(l.stores) ? l.stores : (typeof l.stores === 'string' ? JSON.parse(l.stores) : []),
                    status: l.status || 'approach',
                    createdAt: l.created_at,
                    updatedAt: l.updated_at
                }));
                return cachedLists;
            } catch (error) {
                console.error('ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorageã‹ã‚‰å–å¾—
                const key = getPartnerStorageKey('savedLists');
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            }
        }
        
        // ãƒªã‚¹ãƒˆã‚’ä¿å­˜ï¼ˆAPIçµŒç”±ï¼‰
        async function saveList(listName, stores, status = 'approach') {
            try {
                const currentPartnerId = sessionStorage.getItem("currentPartnerId");
                await apiCall('/saved-lists', {
                    method: 'POST',
                    body: JSON.stringify({
                        rep_id: currentPartnerId,
                        name: listName,
                        stores: stores,
                        status: status
                    })
                });
                await displaySavedLists();
            } catch (error) {
                console.error('ãƒªã‚¹ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorageã«ä¿å­˜
                const lists = await getSavedLists();
                const newList = {
                    id: Date.now().toString(),
                    name: listName,
                    stores: stores,
                    status: status,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                lists.push(newList);
                const key = getPartnerStorageKey('savedLists');
                localStorage.setItem(key, JSON.stringify(lists));
                await displaySavedLists();
            }
        }
        
        // ãƒªã‚¹ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´
        async function changeListStatus(listId, newStatus) {
            const lists = await getSavedLists();
            const list = lists.find(l => l.id === listId);
            if (list) {
                list.status = newStatus;
                list.updatedAt = new Date().toISOString();
                const key = getPartnerStorageKey('savedLists');
                localStorage.setItem(key, JSON.stringify(lists));
                await displaySavedLists();
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        let currentStatusFilter = 'all';
        
        window.filterListsByStatus = async function(status) {
            currentStatusFilter = status;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'bg-yellow-500', 'bg-green-600');
                btn.classList.add('bg-gray-400');
            });
            
            const activeBtn = document.getElementById(`filter-${status}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-400');
                if (status === 'all') {
                    activeBtn.classList.add('bg-blue-600');
                } else if (status === 'approach') {
                    activeBtn.classList.add('bg-yellow-500');
                } else if (status === 'contracted') {
                    activeBtn.classList.add('bg-green-600');
                }
            }
            
            await displaySavedLists();
        };
        
        // åº—èˆ—ã‚’ãƒªã‚¹ãƒˆã«ä¿å­˜
        async function saveStoreToList(store) {
            const listName = prompt('ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ—¢å­˜ã®ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ã™ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ï¼‰:');
            if (!listName) return;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ
            const statusChoice = confirm('æˆç´„æ¸ˆã¿ãƒªã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠã™ã‚‹ã¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãƒªã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ï¼‰');
            const status = statusChoice ? 'contracted' : 'approach';
            
            // åº—èˆ—ã®ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
            const storeId = store.store_id || store.name;
            const currentStoreStatus = await getStoreStatus(storeId);
            if (currentStoreStatus !== 'none') {
                store.status = currentStoreStatus;
            }
            
            const lists = await getSavedLists();
            let targetList = lists.find(l => l.name === listName);
            
            if (targetList) {
                // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
                const exists = targetList.stores.some(s => 
                    (s.store_id && store.store_id && s.store_id === store.store_id) ||
                    (!s.store_id && !store.store_id && s.name === store.name)
                );
                if (!exists) {
                    targetList.stores.push(store);
                    targetList.updatedAt = new Date().toISOString();
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒç•°ãªã‚‹å ´åˆã¯æ›´æ–°
                    if (targetList.status !== status) {
                        targetList.status = status;
                    }
                } else {
                    alert('ã“ã®åº—èˆ—ã¯æ—¢ã«ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã¾ã™');
                    return;
                }
            } else {
                // æ–°ã—ã„ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                targetList = {
                    id: Date.now().toString(),
                    name: listName,
                    stores: [store],
                    status: status,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                lists.push(targetList);
            }
            
            const key = getPartnerStorageKey('savedLists');
            localStorage.setItem(key, JSON.stringify(lists));
            await displaySavedLists();
            alert(`ã€Œ${listName}ã€ã«${status === 'contracted' ? 'æˆç´„æ¸ˆã¿ã¨ã—ã¦' : 'ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­ã¨ã—ã¦'}ä¿å­˜ã—ã¾ã—ãŸ`);
        }
        
        // ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        async function displaySavedLists() {
            const container = document.getElementById('saved-lists-container');
            if (!container) {
                console.error('saved-lists-containerè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                let lists = await getSavedLists();
                const allMapBtn = document.getElementById('btn-show-all-on-map');
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (currentStatusFilter !== 'all') {
                    lists = lists.filter(list => list.status === currentStatusFilter);
                }
                
                if (lists.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-4">ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    if (allMapBtn) allMapBtn.style.display = 'none';
                    return;
                }
                
                // åœ°å›³è¡¨ç¤ºå¯èƒ½ãªãƒªã‚¹ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const allLists = await getSavedLists(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‰ã®å…¨ãƒªã‚¹ãƒˆ
            const hasMappableLists = allLists.some(list => {
                return list.stores.some(s => (s.location_lat && s.location_lng) || s.address);
            });
            
            if (allMapBtn) {
                allMapBtn.style.display = hasMappableLists ? 'block' : 'none';
            }
            
                    container.innerHTML = lists.map(list => {
                const date = new Date(list.updatedAt).toLocaleString('ja-JP');
                // åº§æ¨™æƒ…å ±ãŒã‚ã‚‹åº—èˆ—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                const storesWithLocation = list.stores.filter(s => 
                    (s.location_lat && s.location_lng) || s.address
                ).length;
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè‰²åˆ†ã‘ï¼ˆapcloé¢¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
                const statusInfo = list.status === 'contracted' 
                    ? { label: 'æˆç´„æ¸ˆã¿', badgeClass: 'status-contracted' }
                    : { label: 'ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­', badgeClass: 'status-approach' };
                
                return `
                    <div class="apclo-card p-5 border-l-4 ${list.status === 'contracted' ? 'border-green-500' : 'border-yellow-500'}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900">${list.name}</h3>
                                    <span class="status-badge ${statusInfo.badgeClass}">
                                        ${statusInfo.label}
                                    </span>
                                </div>
                                <div class="flex items-center gap-4 text-sm text-gray-600 mt-2">
                                    <span>${list.stores.length}ä»¶ã®åº—èˆ—</span>
                                    ${storesWithLocation > 0 ? `<span class="text-gray-400">â€¢</span><span>${storesWithLocation}ä»¶ãŒåœ°å›³è¡¨ç¤ºå¯èƒ½</span>` : ''}
                                    <span class="text-gray-400">â€¢</span>
                                    <span class="text-gray-500">æ›´æ–°: ${date}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    onclick="viewSavedList('${list.id}')"
                                    class="apclo-button px-4 py-2 bg-gray-900 text-white text-sm font-medium"
                                >
                                    é–²è¦§
                                </button>
                                ${storesWithLocation > 0 ? `
                                <button
                                    onclick="showListOnMap('${list.id}')"
                                    class="apclo-button px-4 py-2 bg-white text-gray-700 border border-gray-300 text-sm font-medium"
                                >
                                    åœ°å›³è¡¨ç¤º
                                </button>
                                ` : ''}
                                ${list.status === 'approach' ? `
                                <button
                                    onclick="changeListStatus('${list.id}', 'contracted')"
                                    class="apclo-button px-4 py-2 bg-white text-gray-700 border border-gray-300 text-sm font-medium"
                                    title="æˆç´„æ¸ˆã¿ã«å¤‰æ›´"
                                >
                                    æˆç´„
                                </button>
                                ` : `
                                <button
                                    onclick="changeListStatus('${list.id}', 'approach')"
                                    class="apclo-button px-4 py-2 bg-white text-gray-700 border border-gray-300 text-sm font-medium"
                                    title="ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­ã«æˆ»ã™"
                                >
                                    ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
                                </button>
                                `}
                                <button
                                    onclick="exportSavedList('${list.id}')"
                                    class="apclo-button px-4 py-2 bg-white text-gray-700 border border-gray-300 text-sm font-medium"
                                >
                                    ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                                <button
                                    onclick="deleteSavedList('${list.id}')"
                                    class="apclo-button px-4 py-2 bg-white text-red-600 border border-red-300 text-sm font-medium hover:bg-red-50"
                                >
                                    å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            } catch (error) {
                console.error('ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                if (container) {
                    container.innerHTML = '<p class="text-center text-red-500 py-4">ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>';
                }
            }
        }
        
        // ãƒªã‚¹ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
        window.changeListStatus = async function(listId, newStatus) {
            if (confirm(`ã“ã®ãƒªã‚¹ãƒˆã‚’ã€Œ${newStatus === 'contracted' ? 'æˆç´„æ¸ˆã¿' : 'ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­'}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
                await changeListStatus(listId, newStatus);
            }
        };
        
        // Googleãƒãƒƒãƒ—ã§ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        let map = null;
        let markers = [];
        const geocoder = new google.maps.Geocoder();
        
        window.showListOnMap = async function(listId) {
            const lists = await getSavedLists();
            const list = lists.find(l => l.id === listId);
            if (!list) return;
            
            // ä½æ‰€ã¾ãŸã¯åº§æ¨™æƒ…å ±ãŒã‚ã‚‹åº—èˆ—ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const storesWithLocation = list.stores.filter(s => 
                (s.location_lat && s.location_lng) || s.address
            );
            
            if (storesWithLocation.length === 0) {
                alert('åœ°å›³è¡¨ç¤ºå¯èƒ½ãªåº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆä½æ‰€ã¾ãŸã¯åº§æ¨™æƒ…å ±ãŒå¿…è¦ã§ã™ï¼‰');
                return;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = document.getElementById('mapModal');
            const modalTitle = document.getElementById('mapModalTitle');
            const statusLabel = list.status === 'contracted' ? 'âœ… æˆç´„æ¸ˆã¿' : 'ğŸ“‹ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­';
            modalTitle.textContent = `${list.name} (${statusLabel}) - åœ°å›³è¡¨ç¤º (${storesWithLocation.length}ä»¶)`;
            modal.style.display = 'block';
            
            // åœ°å›³ã‚’åˆæœŸåŒ–ï¼ˆãƒªã‚¹ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¸¡ã™ï¼‰
            setTimeout(async () => {
                await initMap(storesWithLocation, list.name, list.status);
            }, 100);
        };
        
        // ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address: address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve({
                            lat: results[0].geometry.location.lat(),
                            lng: results[0].geometry.location.lng()
                        });
                    } else {
                        reject(new Error('Geocoding failed: ' + status));
                    }
                });
            });
        }
        
        // åœ°å›³ã‚’åˆæœŸåŒ–
        async function initMap(stores, listName, listStatus = 'approach') {
            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // åœ°å›³ã®ä¸­å¿ƒã‚’æ±ºå®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ±äº¬ï¼‰
            let center = { lat: 35.6812, lng: 139.7671 };
            let bounds = new google.maps.LatLngBounds();
            let hasValidBounds = false;
            
            // åœ°å›³ã‚’ä½œæˆ
            const mapElement = document.getElementById('map');
            map = new google.maps.Map(mapElement, {
                zoom: 10,
                center: center,
                mapTypeId: 'roadmap'
            });
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'map-loading';
            loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><p>åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div>';
            mapElement.appendChild(loadingDiv);
            
            // å„åº—èˆ—ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ ï¼ˆéåŒæœŸå‡¦ç†ï¼‰
            let processedCount = 0;
            const totalStores = stores.length;
            
            for (let index = 0; index < stores.length; index++) {
                const store = stores[index];
                let position = null;
                let address = store.address || '';
                
                try {
                    // åº§æ¨™æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    if (store.location_lat && store.location_lng) {
                        position = {
                            lat: parseFloat(store.location_lat),
                            lng: parseFloat(store.location_lng)
                        };
                    } else if (address) {
                        // ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—
                        try {
                            position = await geocodeAddress(address);
                            // å–å¾—ã—ãŸåº§æ¨™ã‚’ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                            store.location_lat = position.lat;
                            store.location_lng = position.lng;
                        } catch (error) {
                            console.warn(`ä½æ‰€ã®åº§æ¨™å–å¾—ã«å¤±æ•—: ${address}`, error);
                            continue; // åº§æ¨™å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        }
                    } else {
                        continue; // åº§æ¨™ã‚‚ä½æ‰€ã‚‚ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    }
                    
                    // ãƒãƒ¼ã‚«ãƒ¼ã®è‰²ã‚’æ±ºå®šï¼ˆãƒªã‚¹ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ï¼‰
                    const markerColor = listStatus === 'contracted' 
                        ? '#34A853'  // æˆç´„æ¸ˆã¿: ç·‘
                        : '#FBBC04';  // ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­: é»„è‰²
                    
                    // ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: store.name || 'åº—èˆ—',
                        label: {
                            text: (markers.length + 1).toString(),
                            color: 'white',
                            fontSize: '12px',
                            fontWeight: 'bold'
                        },
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 12,
                            fillColor: markerColor,
                            fillOpacity: 1,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 2
                        }
                    });
                    
                    // æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ
                    const statusBadge = listStatus === 'contracted' 
                        ? '<span style="background: #34A853; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 5px;">âœ… æˆç´„æ¸ˆã¿</span>'
                        : '<span style="background: #FBBC04; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 5px;">ğŸ“‹ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­</span>';
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px; max-width: 300px;">
                                <h3 style="font-weight: bold; margin-bottom: 5px; display: flex; align-items: center;">
                                    ${store.name || 'åç§°ä¸æ˜'}
                                    ${statusBadge}
                                </h3>
                                ${address ? `<p style="margin: 5px 0; color: #666;">ğŸ“ ${address}</p>` : ''}
                                ${store.phone ? `<p style="margin: 5px 0;">ğŸ“ <a href="tel:${store.phone}" style="color: #0066cc;">${store.phone}</a></p>` : ''}
                                ${store.category ? `<p style="margin: 5px 0; color: #666;">${store.category}</p>` : ''}
                                ${store.website ? `<p style="margin: 5px 0;"><a href="${store.website}" target="_blank" style="color: #0066cc;">ğŸŒ ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</a></p>` : ''}
                                <p style="margin: 5px 0;">
                                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(store.name || '')}${store.address ? ' ' + encodeURIComponent(store.address) : ''}" target="_blank" style="color: #0066cc;">
                                        ğŸ—ºï¸ Googleãƒãƒƒãƒ—ã§é–‹ã
                                    </a>
                                </p>
                            </div>
                        `
                    });
                    
                    // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });
                    
                    markers.push(marker);
                    bounds.extend(position);
                    hasValidBounds = true;
                    
                    processedCount++;
                    
                    // é€²æ—è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `<div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><p>åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­... (${processedCount}/${totalStores})</p></div>`;
                    }
                    
                    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è€ƒæ…®ã—ã¦å°‘ã—å¾…æ©Ÿ
                    if (index < stores.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } catch (error) {
                    console.error(`åº—èˆ—ã®å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${store.name}`, error);
                }
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
            if (loadingDiv && loadingDiv.parentNode) {
                loadingDiv.parentNode.removeChild(loadingDiv);
            }
            
            // ã™ã¹ã¦ã®ãƒãƒ¼ã‚«ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«åœ°å›³ã‚’èª¿æ•´
            if (hasValidBounds && markers.length > 0) {
                map.fitBounds(bounds);
                // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒåºƒã™ãã‚‹å ´åˆã¯èª¿æ•´
                google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
                    if (map.getZoom() > 15) {
                        map.setZoom(15);
                    }
                });
            } else if (markers.length === 1) {
                // ãƒãƒ¼ã‚«ãƒ¼ãŒ1ã¤ã®å ´åˆã¯ãã®ä½ç½®ã«ã‚ºãƒ¼ãƒ 
                map.setCenter(markers[0].getPosition());
                map.setZoom(15);
            } else if (markers.length === 0) {
                alert('åœ°å›³è¡¨ç¤ºå¯èƒ½ãªåº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
        }
        
        // è¤‡æ•°ãƒªã‚¹ãƒˆã‚’åœ°å›³ã«è¡¨ç¤ºï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã«è‰²åˆ†ã‘ï¼‰
        async function initMapWithMultipleLists(stores, title) {
            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // åœ°å›³ã‚’ä½œæˆ
            const mapElement = document.getElementById('map');
            map = new google.maps.Map(mapElement, {
                zoom: 10,
                center: { lat: 35.6812, lng: 139.7671 },
                mapTypeId: 'roadmap'
            });
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'map-loading';
            loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><p>åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div>';
            mapElement.appendChild(loadingDiv);
            
            // å…¨ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦ã€å„åº—èˆ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
            const lists = await getSavedLists();
            const storeStatusMap = {};
            lists.forEach(list => {
                list.stores.forEach(store => {
                    const storeKey = store.store_id || store.name;
                    if (!storeStatusMap[storeKey]) {
                        storeStatusMap[storeKey] = list.status;
                    }
                });
            });
            
            let bounds = new google.maps.LatLngBounds();
            let hasValidBounds = false;
            let processedCount = 0;
            
            for (let index = 0; index < stores.length; index++) {
                const store = stores[index];
                let position = null;
                let address = store.address || '';
                const storeKey = store.store_id || store.name;
                const storeStatus = storeStatusMap[storeKey] || 'approach';
                
                try {
                    if (store.location_lat && store.location_lng) {
                        position = {
                            lat: parseFloat(store.location_lat),
                            lng: parseFloat(store.location_lng)
                        };
                    } else if (address) {
                        try {
                            position = await geocodeAddress(address);
                            store.location_lat = position.lat;
                            store.location_lng = position.lng;
                        } catch (error) {
                            console.warn(`ä½æ‰€ã®åº§æ¨™å–å¾—ã«å¤±æ•—: ${address}`, error);
                            continue;
                        }
                    } else {
                        continue;
                    }
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸãƒãƒ¼ã‚«ãƒ¼è‰²
                    const markerColor = storeStatus === 'contracted' 
                        ? '#34A853'  // æˆç´„æ¸ˆã¿: ç·‘
                        : '#FBBC04';  // ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­: é»„è‰²
                    
                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: store.name || 'åº—èˆ—',
                        label: {
                            text: (markers.length + 1).toString(),
                            color: 'white',
                            fontSize: '12px',
                            fontWeight: 'bold'
                        },
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 12,
                            fillColor: markerColor,
                            fillOpacity: 1,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 2
                        }
                    });
                    
                    const statusBadge = storeStatus === 'contracted' 
                        ? '<span style="background: #34A853; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 5px;">âœ… æˆç´„æ¸ˆã¿</span>'
                        : '<span style="background: #FBBC04; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 5px;">ğŸ“‹ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­</span>';
                    
                    // åº—èˆ—æƒ…å ±ã‚’è©³ç´°ã«è¡¨ç¤º
                    const storeInfo = {
                        name: store.name || 'åç§°ä¸æ˜',
                        address: store.address || 'ä½æ‰€æœªå–å¾—',
                        phone: store.phone || 'é›»è©±ç•ªå·æœªå–å¾—',
                        website: store.website || '',
                        category: store.category || 'ã‚«ãƒ†ã‚´ãƒªãƒ¼æœªè¨­å®š',
                        rating: store.rating || '',
                        deliveryServices: Array.isArray(store.delivery_services) ? store.delivery_services : (store.delivery_services ? [store.delivery_services] : [])
                    };
                    
                    // Googleãƒãƒƒãƒ—æ¤œç´¢URLï¼ˆåº—èˆ—åã‚’å„ªå…ˆï¼‰
                    const mapQuery = storeInfo.name ? (storeInfo.address !== 'ä½æ‰€æœªå–å¾—' ? `${storeInfo.name} ${storeInfo.address}` : storeInfo.name) : (storeInfo.address !== 'ä½æ‰€æœªå–å¾—' ? storeInfo.address : `${position.lat},${position.lng}`);
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapQuery)}`;
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 12px; max-width: 350px; font-family: 'Noto Sans JP', sans-serif;">
                                <h3 style="font-weight: bold; margin-bottom: 8px; font-size: 16px; display: flex; align-items: center; flex-wrap: wrap;">
                                    ${storeInfo.name}
                                    ${statusBadge}
                                </h3>
                                <div style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px;">
                                    <div style="margin-bottom: 6px;">
                                        <span style="font-weight: 600; color: #6b7280; font-size: 12px;">ğŸ“ ä½æ‰€:</span>
                                        <div style="margin-top: 2px; font-size: 13px; color: #1f2937;">${storeInfo.address}</div>
                                    </div>
                                    ${storeInfo.phone !== 'é›»è©±ç•ªå·æœªå–å¾—' ? `
                                    <div style="margin-bottom: 6px;">
                                        <span style="font-weight: 600; color: #6b7280; font-size: 12px;">ğŸ“ é›»è©±:</span>
                                        <div style="margin-top: 2px; font-size: 13px; color: #1f2937;"><a href="tel:${storeInfo.phone}" style="color: #2563eb; text-decoration: none;">${storeInfo.phone}</a></div>
                                    </div>
                                    ` : ''}
                                    ${storeInfo.website ? `
                                    <div style="margin-bottom: 6px;">
                                        <span style="font-weight: 600; color: #6b7280; font-size: 12px;">ğŸŒ ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ:</span>
                                        <div style="margin-top: 2px;">
                                            <a href="${storeInfo.website}" target="_blank" style="font-size: 13px; color: #2563eb; text-decoration: none;">${storeInfo.website}</a>
                                        </div>
                                    </div>
                                    ` : ''}
                                    <div style="margin-bottom: 6px;">
                                        <span style="font-weight: 600; color: #6b7280; font-size: 12px;">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªãƒ¼:</span>
                                        <div style="margin-top: 2px; font-size: 13px; color: #1f2937;">${storeInfo.category}</div>
                                    </div>
                                    ${storeInfo.rating ? `
                                    <div style="margin-bottom: 6px;">
                                        <span style="font-weight: 600; color: #6b7280; font-size: 12px;">â­ è©•ä¾¡:</span>
                                        <div style="margin-top: 2px; font-size: 13px; color: #1f2937;">${storeInfo.rating} / 5.0</div>
                                    </div>
                                    ` : ''}
                                    ${storeInfo.deliveryServices.length > 0 ? `
                                    <div style="margin-bottom: 6px;">
                                        <span style="font-weight: 600; color: #6b7280; font-size: 12px;">ğŸšš ãƒ‡ãƒªãƒãƒªãƒ¼:</span>
                                        <div style="margin-top: 2px; font-size: 12px; color: #1f2937;">
                                            ${storeInfo.deliveryServices.map(s => `<span style="display: inline-block; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; margin-right: 4px; margin-bottom: 4px;">${s}</span>`).join('')}
                                        </div>
                                    </div>
                                    ` : ''}
                                    <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #9ca3af;">
                                            åº§æ¨™: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}
                                        </div>
                                        <div style="margin-top: 4px;">
                                            <a href="${mapUrl}" target="_blank" style="font-size: 12px; color: #2563eb; text-decoration: none;">
                                                ğŸ—ºï¸ Googleãƒãƒƒãƒ—ã§é–‹ã
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });
                    
                    markers.push(marker);
                    bounds.extend(position);
                    hasValidBounds = true;
                    processedCount++;
                    
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `<div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><p>åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­... (${processedCount}/${stores.length})</p></div>`;
                    }
                    
                    if (index < stores.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } catch (error) {
                    console.error(`åº—èˆ—ã®å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${store.name}`, error);
                }
            }
            
            if (loadingDiv && loadingDiv.parentNode) {
                loadingDiv.parentNode.removeChild(loadingDiv);
            }
            
            // å‡¡ä¾‹ã‚’è¿½åŠ 
            const legend = document.createElement('div');
            legend.innerHTML = `
                <div style="position: absolute; top: 10px; right: 10px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 1000;">
                    <div style="font-weight: bold; margin-bottom: 5px;">å‡¡ä¾‹</div>
                    <div style="display: flex; align-items: center; margin: 5px 0;">
                        <div style="width: 20px; height: 20px; background: #FBBC04; border-radius: 50%; border: 2px solid white; margin-right: 8px;"></div>
                        <span>ğŸ“‹ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­</span>
                    </div>
                    <div style="display: flex; align-items: center; margin: 5px 0;">
                        <div style="width: 20px; height: 20px; background: #34A853; border-radius: 50%; border: 2px solid white; margin-right: 8px;"></div>
                        <span>âœ… æˆç´„æ¸ˆã¿</span>
                    </div>
                </div>
            `;
            legend.style.position = 'relative';
            mapElement.appendChild(legend);
            
            if (hasValidBounds && markers.length > 0) {
                map.fitBounds(bounds);
                google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
                    if (map.getZoom() > 15) {
                        map.setZoom(15);
                    }
                });
            } else if (markers.length === 1) {
                map.setCenter(markers[0].getPosition());
                map.setZoom(15);
            } else if (markers.length === 0) {
                alert('åœ°å›³è¡¨ç¤ºå¯èƒ½ãªåº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('mapModal');
            const closeBtn = document.querySelector('.close');
            
            if (closeBtn) {
                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                };
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        });
        
        // ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆã‚’é–²è¦§
        window.viewSavedList = async function(listId) {
            try {
                const lists = await getSavedLists();
                const list = lists.find(l => l.id === listId);
                if (!list) return;
                
                // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚å«ã‚ã‚‹ï¼‰
                window.currentStores = {};
                for (const store of list.stores) {
                    const storeId = store.store_id || store.name;
                    // ä¿å­˜ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒãªã„å ´åˆã¯ã€ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
                    if (!store.status) {
                        store.status = await getStoreStatus(storeId);
                    }
                    window.currentStores[storeId] = store;
                }
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤º
                const container = document.getElementById('stores-container');
                container.innerHTML = '';
                for (const store of list.stores) {
                    const row = await createStoreTableRow(store);
                    container.appendChild(row);
                }
                
                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°
                const paginationInfo = document.getElementById('pagination-info');
                if (paginationInfo) {
                    paginationInfo.textContent = `${list.stores.length}ä»¶ã‚’è¡¨ç¤ºï¼ˆä¿å­˜ã—ãŸãƒªã‚¹ãƒˆ: ${list.name}ï¼‰`;
                }
                
                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                const pagination = document.getElementById('pagination');
                if (pagination) {
                    pagination.innerHTML = '';
                }
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤º
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                const container = document.getElementById('stores-container');
                if (container) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="15" class="px-6 py-16">
                                <div class="flex flex-col items-center justify-center text-center">
                                    <div class="mb-4">
                                        <svg class="w-16 h-16 text-red-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-red-600 mb-2">ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                                    <p class="text-sm text-gray-500 mb-6">
                                        ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
                                    </p>
                                    <button 
                                        onclick="window.location.reload()" 
                                        class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 font-medium shadow-sm"
                                    >
                                        ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
        };
        
        // ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        window.exportSavedList = async function(listId) {
            const lists = await getSavedLists();
            const list = lists.find(l => l.id === listId);
            if (!list) return;
            
            // CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            const headers = ['åº—èˆ—å', 'é›»è©±ç•ªå·', 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ', 'ä½æ‰€', 'ã‚«ãƒ†ã‚´ãƒª', 'è©•ä¾¡', 'éƒ½å¸‚', 'Place ID', 'URL', 'ã‚ªãƒ¼ãƒ—ãƒ³æ—¥'];
            const csvRows = [headers.join(',')];
            
            list.stores.forEach(store => {
                const row = [
                    `"${(store.name || '').replace(/"/g, '""')}"`,
                    `"${(store.phone || '').replace(/"/g, '""')}"`,
                    `"${(store.website || '').replace(/"/g, '""')}"`,
                    `"${(store.address || '').replace(/"/g, '""')}"`,
                    `"${(store.category || '').replace(/"/g, '""')}"`,
                    `"${(store.rating || '').replace(/"/g, '""')}"`,
                    `"${(store.city || '').replace(/"/g, '""')}"`,
                    `"${(store.place_id || '').replace(/"/g, '""')}"`,
                    `"${(store.url || '').replace(/"/g, '""')}"`,
                    `"${(store.closed_day || '').replace(/"/g, '""')}",` +
                    `"${(store.opening_date || '').replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });
            
            const csvContent = '\ufeff' + csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${list.name}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };
        
        // ä¿å­˜ã—ãŸãƒªã‚¹ãƒˆã‚’å‰Šé™¤
        window.deleteSavedList = async function(listId) {
            if (!confirm('ã“ã®ãƒªã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const lists = await getSavedLists();
            const filtered = lists.filter(l => l.id !== listId);
            const key = getPartnerStorageKey('savedLists');
            localStorage.setItem(key, JSON.stringify(filtered));
            await displaySavedLists();
        };
        
        // é¸æŠã•ã‚ŒãŸåº—èˆ—æ•°ã‚’æ›´æ–°
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.store-checkbox:checked');
            const saveBtn = document.getElementById('btn-save-selected');
            if (checkboxes.length > 0) {
                saveBtn.style.display = 'block';
                saveBtn.textContent = `ğŸ’¾ ${checkboxes.length}ä»¶ã‚’ä¿å­˜`;
            } else {
                saveBtn.style.display = 'none';
            }
        }
        
        // é¸æŠã—ãŸåº—èˆ—ã‚’ä¿å­˜
        async function saveSelectedStores() {
            const checkboxes = document.querySelectorAll('.store-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('ä¿å­˜ã™ã‚‹åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const listName = prompt('ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ—¢å­˜ã®ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ã™ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ï¼‰:');
            if (!listName) return;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ
            const statusChoice = confirm('æˆç´„æ¸ˆã¿ãƒªã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠã™ã‚‹ã¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãƒªã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ï¼‰');
            const status = statusChoice ? 'contracted' : 'approach';
            
            const stores = [];
            for (const checkbox of checkboxes) {
                const storeId = checkbox.dataset.storeId;
                // ä¿æŒã•ã‚Œã¦ã„ã‚‹åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
                if (window.currentStores && window.currentStores[storeId]) {
                    const store = window.currentStores[storeId];
                    // åº—èˆ—ã®ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
                    const currentStoreStatus = await getStoreStatus(storeId);
                    if (currentStoreStatus !== 'none') {
                        store.status = currentStoreStatus;
                    }
                    stores.push(store);
                }
            }
            
            if (stores.length === 0) {
                alert('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }
            
            // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹ã‹ã€æ–°è¦ä½œæˆ
            const lists = await getSavedLists();
            let targetList = lists.find(l => l.name === listName);
            
            if (targetList) {
                // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
                stores.forEach(store => {
                    const exists = targetList.stores.some(s => 
                        (s.store_id && store.store_id && s.store_id === store.store_id) ||
                        (!s.store_id && !store.store_id && s.name === store.name)
                    );
                    if (!exists) {
                        targetList.stores.push(store);
                    }
                });
                targetList.updatedAt = new Date().toISOString();
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒç•°ãªã‚‹å ´åˆã¯æ›´æ–°
                if (targetList.status !== status) {
                    targetList.status = status;
                }
                const key = getPartnerStorageKey('savedLists');
                localStorage.setItem(key, JSON.stringify(lists));
            } else {
                saveList(listName, stores, status);
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedCount();
            await displaySavedLists();
            alert(`ã€Œ${listName}ã€ã«${stores.length}ä»¶ã®åº—èˆ—ã‚’${status === 'contracted' ? 'æˆç´„æ¸ˆã¿ã¨ã—ã¦' : 'ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸­ã¨ã—ã¦'}ä¿å­˜ã—ã¾ã—ãŸ`);
        }

        function renderPagination(current, total) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            if (total <= 1) return;
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'å‰ã¸';
            prevBtn.className = 'px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50';
            prevBtn.disabled = current === 1;
            prevBtn.addEventListener('click', () => loadStores(current - 1));
            pagination.appendChild(prevBtn);
            const start = Math.max(1, current - 2);
            const end = Math.min(total, current + 2);
            for (let i = start; i <= end; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = `px-4 py-2 border rounded-lg ${
                    i === current 
                        ? 'bg-blue-600 text-white border-blue-600' 
                        : 'border-gray-300 hover:bg-gray-50'
                }`;
                btn.addEventListener('click', () => loadStores(i));
                pagination.appendChild(btn);
            }
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'æ¬¡ã¸';
            nextBtn.className = 'px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50';
            nextBtn.disabled = current === total;
            nextBtn.addEventListener('click', () => loadStores(current + 1));
            pagination.appendChild(nextBtn);
        }

        function updateSearchKeywordsDisplay() {
            const container = document.getElementById('search-keywords');
            container.innerHTML = '';
            searchKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm';
                tag.innerHTML = `
                    <span>${escapeHtml(keyword)}</span>
                    <button 
                        type="button"
                        onclick="removeKeyword(${index})"
                        class="ml-2 text-blue-600 hover:text-blue-800 font-bold"
                    >Ã—</button>
                `;
                container.appendChild(tag);
            });
        }

        function addKeyword(keyword) {
            const trimmed = keyword.trim();
            if (trimmed && !searchKeywords.includes(trimmed)) {
                searchKeywords.push(trimmed);
                updateSearchKeywordsDisplay();
                updateSearchQuery();
                loadStores(1);
            }
        }

        window.removeKeyword = function(index) {
            searchKeywords.splice(index, 1);
            updateSearchKeywordsDisplay();
            updateSearchQuery();
            loadStores(1);
        };

        function updateSearchQuery() {
            currentFilters.search = searchKeywords.join(' ');
        }

        function handleSearchKeyDown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = e.target.value.trim();
                if (value) {
                    addKeyword(value);
                    e.target.value = '';
                }
            } else if (e.key === 'Backspace' && e.target.value === '' && searchKeywords.length > 0) {
                removeKeyword(searchKeywords.length - 1);
            }
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            searchKeywords = [];
            updateSearchKeywordsDisplay();
            const areaCheckboxes = document.querySelectorAll('#area-filter-container input[type="checkbox"]');
            areaCheckboxes.forEach(cb => cb.checked = false);
            const prefectureCheckboxes = document.querySelectorAll('#prefecture-filter-container input[type="checkbox"]');
            prefectureCheckboxes.forEach(cb => cb.checked = false);
            document.getElementById('city-search-input').value = '';
            document.getElementById('city-search-input').style.display = 'none';
            const cityCheckboxes = document.querySelectorAll('#city-filter-container input[type="checkbox"]');
            cityCheckboxes.forEach(cb => cb.checked = false);
            document.getElementById('city-filter-container').innerHTML = '<p class="text-xs text-gray-500">éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
            document.getElementById('selected-cities-display').style.display = 'none';
            allCitiesData = [];
            document.getElementById('category-search-input').value = '';
            const categoryCheckboxes = document.querySelectorAll('#category-filter-container input[type="checkbox"]');
            categoryCheckboxes.forEach(cb => cb.checked = false);
            document.getElementById('selected-categories-display').style.display = 'none';
            
            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.delivery-service-checkbox').forEach(cb => cb.checked = false);
            
            // å…¨é …ç›®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('phone-filter-input').value = '';
            document.getElementById('website-filter-input').value = '';
            document.getElementById('rating-filter-operator').value = '>=';
            document.getElementById('rating-filter-value').value = '';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            ['name', 'address', 'contact', 'category', 'delivery', 'status'].forEach(column => {
                if (headerFilterData[column]) {
                    headerFilterData[column].selected = [];
                }
                const menu = document.getElementById(`header-filter-menu-${column}`);
                if (menu) {
                    menu.classList.remove('show');
                }
                if (column === 'delivery' || column === 'status') {
                    const checkboxes = document.querySelectorAll(`#header-filter-values-${column} input[type="checkbox"]`);
                    checkboxes.forEach(cb => cb.checked = true);
                }
            });
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentFilters.headerName = '';
            currentFilters.headerAddress = '';
            currentFilters.headerContact = '';
            currentFilters.headerCategory = '';
            currentFilters.headerDelivery = '';
            currentFilters.headerStatus = '';
            currentFilters.headerClosedDay = '';
            currentFilters.headerOpeningDate = '';
            currentFilters.headerTransport = '';
            currentFilters.headerBusinessHours = '';
            currentFilters.headerOfficialAccount = '';
            currentFilters.headerCollectedAt = '';
            
            document.querySelector('input[name="search-mode"][value="AND"]').checked = true;
            document.querySelector('input[name="match-type"][value="partial"]').checked = true;
            currentFilters = { prefectures: [], cities: [], categories: [], dataSources: DATA_SOURCES.map(s => s.value), search: '', searchMode: 'AND', matchType: 'partial', phone: '', website: '', ratingOperator: '>=', ratingValue: '', fullyCompleted: false, headerName: '', headerAddress: '', headerContact: '', headerCategory: '', headerDelivery: '', headerStatus: '', headerClosedDay: '', headerOpeningDate: '', headerTransport: '', headerBusinessHours: '', headerOfficialAccount: '', headerCollectedAt: '' };
            filterAndDisplayCategories();
            loadStores(1);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
        function showExportFormatModal() {
            const modal = document.createElement('div');
            modal.id = 'export-format-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼ã‚’é¸æŠ</h3>
                        <div class="space-y-3">
                            <button
                                id="export-format-csv"
                                class="w-full px-6 py-3 bg-gray-900 text-white text-sm font-medium rounded-md hover:bg-gray-800 transition-colors flex items-center justify-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                CSVå½¢å¼
                            </button>
                            <button
                                id="export-format-json"
                                class="w-full px-6 py-3 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                JSONå½¢å¼
                            </button>
                            <button
                                id="export-format-excel"
                                class="w-full px-6 py-3 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Excelå½¢å¼
                            </button>
                            <button
                                id="export-format-cancel"
                                class="w-full px-6 py-3 bg-gray-200 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-300 transition-colors"
                            >
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.getElementById('export-format-csv').addEventListener('click', () => {
                modal.remove();
                handleExportCSV();
            });
            document.getElementById('export-format-json').addEventListener('click', () => {
                modal.remove();
                handleExportJSON();
            });
            document.getElementById('export-format-excel').addEventListener('click', () => {
                modal.remove();
                handleExportExcel();
            });
            document.getElementById('export-format-cancel').addEventListener('click', () => {
                modal.remove();
            });
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†ä¸­ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showExportModal(format) {
            const modal = document.createElement('div');
            modal.id = 'export-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${format === 'CSV' ? 'CSV' : format === 'JSON' ? 'JSON' : 'Excel'}ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†ä¸­</h3>
                        <p class="text-sm text-gray-600 mb-4">ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã¦ã„ã¾ã™...</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                            <div id="export-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="export-progress-text" class="text-xs text-gray-500">0%</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’åˆæœŸçŠ¶æ…‹ã‹ã‚‰å°‘ã—é€²ã‚ã‚‹ï¼ˆè¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
            let progress = 0;
            const progressInterval = setInterval(() => {
                // 90%ã¾ã§å¾ã€…ã«é€²ã‚ã‚‹ï¼ˆå®Ÿéš›ã®å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§ï¼‰
                if (progress < 25) {
                    progress = Math.min(progress + Math.random() * 3, 25);
                }
                const progressBar = document.getElementById('export-progress-bar');
                const progressText = document.getElementById('export-progress-text');
                if (progressBar && progressText && progressBar.style.width !== '100%') {
                    const currentWidth = parseFloat(progressBar.style.width) || 0;
                    if (currentWidth < 25) {
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${Math.floor(progress)}%`;
                    }
                }
            }, 300);
            
            return { modal, progressInterval };
        }

        function hideExportModal(modal, progressInterval) {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            if (modal) {
                modal.remove();
            }
        }

        async function handleExportCSV() {
            let url = ''; // urlå¤‰æ•°ã‚’æœ€åˆã«å®šç¾©
            let modal, progressInterval;
            try {
                const params = new URLSearchParams({
                    search: currentFilters.search || '',
                    search_mode: currentFilters.searchMode || 'AND',
                    match_type: currentFilters.matchType || 'partial'
                });
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                if (currentFilters.prefectures && currentFilters.prefectures.length > 0) {
                    currentFilters.prefectures.forEach(pref => params.append('prefectures', pref));
                }
                if (currentFilters.cities && currentFilters.cities.length > 0) {
                    currentFilters.cities.forEach(city => params.append('cities', city));
                }
                if (currentFilters.categories && currentFilters.categories.length > 0) {
                    currentFilters.categories.forEach(cat => params.append('categories', cat));
                }
                if (currentFilters.deliveryServices && currentFilters.deliveryServices.length > 0) {
                    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (currentFilters.dataSources.length > 0 && currentFilters.dataSources.length < DATA_SOURCES.length) {
                    currentFilters.dataSources.forEach(source => params.append('data_sources', source));
                }
                }
                
                url = `${STORE_API_BASE}/api/export/csv?${params}`;
                
                console.log('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹:', {
                    url: url,
                    filters: currentFilters,
                    params: params.toString()
                });
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                const modalResult = showExportModal('CSV');
                modal = modalResult.modal;
                progressInterval = modalResult.progressInterval;
                
                const progressBar = document.getElementById('export-progress-bar');
                const progressText = document.getElementById('export-progress-text');
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’30%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '30%';
                    progressText.textContent = '30% - ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...';
                }
                
                // fetch APIã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã‚’å»¶é•·ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
                // é€²æ—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆå®Ÿéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…ã¤é–“ï¼‰
                const progressSimulation = setInterval(() => {
                    const currentWidth = parseFloat(progressBar?.style.width || '30');
                    if (currentWidth < 70) {
                        const newWidth = Math.min(currentWidth + 0.5, 70);
                        if (progressBar && progressText) {
                            progressBar.style.width = `${newWidth}%`;
                            progressText.textContent = `${Math.floor(newWidth)}% - ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ä¸­...`;
                        }
                    }
                }, 500);
                
                // ngrokã®è­¦å‘Šãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                clearTimeout(timeoutId);
                clearInterval(progressSimulation);
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’75%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '75%';
                    progressText.textContent = '75% - ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­...';
                }
                
                if (!response.ok) {
                    // 403ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã‚’æä¾›
                    if (response.status === 403) {
                        const errorText = await response.text().catch(() => '');
                        console.error('403ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', errorText);
                        throw new Error(`HTTP error! status: ${response.status} - ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ngrokã®è­¦å‘Šãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’85%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '85%';
                    progressText.textContent = '85% - ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...';
                }
                
                // Blobã¨ã—ã¦å–å¾—ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œï¼‰
                const reader = response.body.getReader();
                const chunks = [];
                let receivedBytes = 0;
                
                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        if (value) {
                            chunks.push(value);
                            receivedBytes += value.length;
                            
                            // é€²æ—ã‚’æ›´æ–°ï¼ˆ85%ã‹ã‚‰95%ã¾ã§ï¼‰
                            if (progressBar && progressText) {
                                const estimatedProgress = 85 + Math.min((receivedBytes / 1000000) * 10, 10); // 1MBã”ã¨ã«10%å¢—åŠ ï¼ˆæœ€å¤§95%ï¼‰
                                progressBar.style.width = `${estimatedProgress}%`;
                                progressText.textContent = `${Math.floor(estimatedProgress)}% - ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­... (${(receivedBytes / 1024 / 1024).toFixed(1)}MB)`;
                            }
                        }
                    }
                } catch (readError) {
                    console.error('ã‚¹ãƒˆãƒªãƒ¼ãƒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', readError);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€æ—¢ã«å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã§ç¶šè¡Œ
                    if (chunks.length === 0) {
                        throw readError;
                    }
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’95%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '95%';
                    progressText.textContent = '95% - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...';
                }
                
                // Blobã‚’æ§‹ç¯‰
                if (chunks.length === 0) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒå—ä¿¡ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚');
                }
                
                const blob = new Blob(chunks, { type: 'text/csv; charset=utf-8' });
                
                // Blobã‚µã‚¤ã‚ºã®ç¢ºèª
                if (blob.size === 0) {
                    throw new Error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãŒ0ãƒã‚¤ãƒˆã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚');
                }
                
                console.log(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${(blob.size / 1024).toFixed(2)}KB`);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
                const downloadUrl = window.URL.createObjectURL(blob);
                const filename = `restaurants_export_${new Date().getTime()}.csv`;
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±¥æ­´ã‚’ä¿å­˜
                const currentPartnerId = sessionStorage.getItem("currentPartnerId");
                let estimatedCount = 0;
                if (currentPartnerId) {
                    const downloadHistoryKey = `download_history_${currentPartnerId}`;
                    const downloadHistory = JSON.parse(localStorage.getItem(downloadHistoryKey) || '[]');
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’æ¨å®šï¼ˆãƒã‚¤ãƒˆæ•°ã‹ã‚‰ï¼‰
                    estimatedCount = Math.floor(receivedBytes / 200); // 1ä»¶ã‚ãŸã‚Šç´„200ãƒã‚¤ãƒˆã¨ä»®å®š
                    downloadHistory.unshift({
                        filename: filename,
                        downloadedAt: new Date().toISOString(),
                        count: estimatedCount,
                        type: 'CSV',
                        size: blob.size
                    });
                    // æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
                    if (downloadHistory.length > 100) {
                        downloadHistory.splice(100);
                    }
                    localStorage.setItem(downloadHistoryKey, JSON.stringify(downloadHistory));
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '100%';
                    progressText.textContent = '100% - å®Œäº†ï¼';
                }
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                setTimeout(() => {
                    hideExportModal(modal, progressInterval);
                }, 1000);
                
                console.log('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†:', {
                    filename: filename,
                    size: `${(blob.size / 1024).toFixed(2)}KB`,
                    records: estimatedCount || 'ä¸æ˜'
                });
                
            } catch (error) {
                console.error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    url: url || 'æœªå®šç¾©'
                });
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿é–‰ã˜ã‚‹
                if (modal && progressInterval) {
                hideExportModal(modal, progressInterval);
                }
                
                let errorMessage = 'CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚\nãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„å ´åˆã¯ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ã¦ä»¶æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message && error.message.includes('HTTP error')) {
                    const statusMatch = error.message.match(/status: (\d+)/);
                    const status = statusMatch ? statusMatch[1] : 'ä¸æ˜';
                    
                    if (status === '403') {
                        errorMessage = 'CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸï¼ˆ403ã‚¨ãƒ©ãƒ¼ï¼‰ã€‚\n\nngrokã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è­¦å‘Šãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚\nã¾ãŸã¯ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else {
                        errorMessage = `CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆHTTP ${status}ï¼‰ã€‚\n\n${error.message}\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                    }
                } else {
                    errorMessage += error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    errorMessage += '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                }
                
                alert(errorMessage);
            }
        }

        async function handleExportExcel() {
            let url = '';
            let modal, progressInterval;
            try {
                const params = new URLSearchParams({
                    search: currentFilters.search || '',
                    search_mode: currentFilters.searchMode || 'AND',
                    match_type: currentFilters.matchType || 'partial'
                });
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                if (currentFilters.prefectures && currentFilters.prefectures.length > 0) {
                    currentFilters.prefectures.forEach(pref => params.append('prefectures', pref));
                }
                if (currentFilters.cities && currentFilters.cities.length > 0) {
                    currentFilters.cities.forEach(city => params.append('cities', city));
                }
                if (currentFilters.categories && currentFilters.categories.length > 0) {
                    currentFilters.categories.forEach(cat => params.append('categories', cat));
                }
                if (currentFilters.deliveryServices && currentFilters.deliveryServices.length > 0) {
                    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                    if (currentFilters.dataSources.length > 0 && currentFilters.dataSources.length < DATA_SOURCES.length) {
                        currentFilters.dataSources.forEach(source => params.append('data_sources', source));
                    }
                }
                
                url = `${STORE_API_BASE}/api/export/excel?${params}`;
                
                console.log('Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹:', {
                    url: url,
                    filters: currentFilters,
                    params: params.toString()
                });
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                const modalResult = showExportModal('Excel');
                modal = modalResult.modal;
                progressInterval = modalResult.progressInterval;
                
                const progressBar = document.getElementById('export-progress-bar');
                const progressText = document.getElementById('export-progress-text');
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’30%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '30%';
                    progressText.textContent = '30% - ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...';
                }
                
                // fetch APIã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã‚’å»¶é•·ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
                // é€²æ—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆå®Ÿéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…ã¤é–“ï¼‰
                const progressSimulation = setInterval(() => {
                    const currentWidth = parseFloat(progressBar?.style.width || '30');
                    if (currentWidth < 70) {
                        const newWidth = Math.min(currentWidth + 0.5, 70);
                        if (progressBar && progressText) {
                            progressBar.style.width = `${newWidth}%`;
                            progressText.textContent = `${Math.floor(newWidth)}% - ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ä¸­...`;
                        }
                    }
                }, 500);
                
                // ngrokã®è­¦å‘Šãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
                let response;
                try {
                    response = await fetch(url, {
                        signal: controller.signal,
                        headers: {
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    clearInterval(progressSimulation);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é€²æ—ã‚’æ›´æ–°
                    if (progressBar && progressText) {
                        progressBar.style.width = '100%';
                        progressText.textContent = 'ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ';
                    }
                    console.error('Fetchã‚¨ãƒ©ãƒ¼:', fetchError);
                    throw new Error(`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${fetchError.message || 'æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ngrokã®æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'}`);
                }
                
                clearTimeout(timeoutId);
                clearInterval(progressSimulation);
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’75%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '75%';
                    progressText.textContent = '75% - ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­...';
                }
                
                if (!response.ok) {
                    // 403ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã‚’æä¾›
                    if (response.status === 403) {
                        const errorText = await response.text().catch(() => '');
                        console.error('403ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', errorText);
                        throw new Error(`HTTP error! status: ${response.status} - ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ngrokã®è­¦å‘Šãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’85%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '85%';
                    progressText.textContent = '85% - ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...';
                }
                
                // Blobã¨ã—ã¦å–å¾—
                const blob = await response.blob();
                
                // Blobã‚µã‚¤ã‚ºã®ç¢ºèª
                if (blob.size === 0) {
                    throw new Error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãŒ0ãƒã‚¤ãƒˆã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚');
                }
                
                console.log(`Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${(blob.size / 1024).toFixed(2)}KB`);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
                const downloadUrl = window.URL.createObjectURL(blob);
                const filename = `restaurants_export_${new Date().getTime()}.xlsx`;
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±¥æ­´ã‚’ä¿å­˜
                const currentPartnerId = sessionStorage.getItem("currentPartnerId");
                let estimatedCount = 0;
                if (currentPartnerId) {
                    const downloadHistoryKey = `download_history_${currentPartnerId}`;
                    const downloadHistory = JSON.parse(localStorage.getItem(downloadHistoryKey) || '[]');
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’æ¨å®šï¼ˆãƒã‚¤ãƒˆæ•°ã‹ã‚‰ï¼‰
                    estimatedCount = Math.floor(blob.size / 300); // Excelã¯1ä»¶ã‚ãŸã‚Šç´„300ãƒã‚¤ãƒˆã¨ä»®å®š
                    downloadHistory.unshift({
                        filename: filename,
                        downloadedAt: new Date().toISOString(),
                        count: estimatedCount,
                        type: 'Excel',
                        size: blob.size
                    });
                    // æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
                    if (downloadHistory.length > 100) {
                        downloadHistory.splice(100);
                    }
                    localStorage.setItem(downloadHistoryKey, JSON.stringify(downloadHistory));
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '100%';
                    progressText.textContent = '100% - å®Œäº†ï¼';
                }
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                setTimeout(() => {
                    hideExportModal(modal, progressInterval);
                }, 1000);
                
                console.log('Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†:', {
                    filename: filename,
                    size: `${(blob.size / 1024).toFixed(2)}KB`,
                    records: estimatedCount || 'ä¸æ˜'
                });
                
            } catch (error) {
                console.error('Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    url: url || 'æœªå®šç¾©'
                });
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿é–‰ã˜ã‚‹
                if (modal && progressInterval) {
                    hideExportModal(modal, progressInterval);
                }
                
                let errorMessage = 'Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚\nãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„å ´åˆã¯ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ã¦ä»¶æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message && error.message.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼')) {
                    errorMessage = 'Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message + '\n\nngrokã®æ¥ç¶šãŒä¸å®‰å®šãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                } else if (error.message && error.message.includes('HTTP error')) {
                    const statusMatch = error.message.match(/status: (\d+)/);
                    const status = statusMatch ? statusMatch[1] : 'ä¸æ˜';
                    
                    if (status === '403') {
                        errorMessage = 'Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸï¼ˆ403ã‚¨ãƒ©ãƒ¼ï¼‰ã€‚\n\nngrokã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è­¦å‘Šãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚\nã¾ãŸã¯ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        errorMessage = `Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆHTTP ${status}ï¼‰ã€‚\n\n${error.message}\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                    }
                } else {
                    errorMessage += error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    errorMessage += '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                }
                
                alert(errorMessage);
            }
        }

        async function handleExportJSON() {
            const params = new URLSearchParams({
                search: currentFilters.search,
                search_mode: currentFilters.searchMode,
                match_type: currentFilters.matchType
            });
            currentFilters.prefectures.forEach(pref => params.append('prefectures', pref));
            currentFilters.cities.forEach(city => params.append('cities', city));
            currentFilters.categories.forEach(cat => params.append('categories', cat));
            currentFilters.deliveryServices.forEach(service => params.append('delivery_services', service));
            
            const url = `${STORE_API_BASE}/api/export/json?${params}`;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            const { modal, progressInterval } = showExportModal('JSON');
            
            try {
                const progressBar = document.getElementById('export-progress-bar');
                const progressText = document.getElementById('export-progress-text');
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’30%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '30%';
                    progressText.textContent = '30% - ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...';
                }
                
                // fetch APIã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã‚’å»¶é•·ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
                // é€²æ—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆå®Ÿéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…ã¤é–“ï¼‰
                const progressSimulation = setInterval(() => {
                    const currentWidth = parseFloat(progressBar?.style.width || '30');
                    if (currentWidth < 70) {
                        const newWidth = Math.min(currentWidth + 0.5, 70);
                        if (progressBar && progressText) {
                            progressBar.style.width = `${newWidth}%`;
                            progressText.textContent = `${Math.floor(newWidth)}% - ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ä¸­...`;
                        }
                    }
                }, 500);
                
                const response = await fetch(url, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                clearInterval(progressSimulation);
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’75%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '75%';
                    progressText.textContent = '75% - ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­...';
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’85%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '85%';
                    progressText.textContent = '85% - ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...';
                }
                
                // Blobã¨ã—ã¦å–å¾—ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œï¼‰
                const reader = response.body.getReader();
                const chunks = [];
                let receivedBytes = 0;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    chunks.push(value);
                    receivedBytes += value.length;
                    
                    // é€²æ—ã‚’æ›´æ–°ï¼ˆ85%ã‹ã‚‰95%ã¾ã§ï¼‰
                    if (progressBar && progressText) {
                        const estimatedProgress = 85 + Math.min((receivedBytes / 1000000) * 10, 10); // 1MBã”ã¨ã«10%å¢—åŠ ï¼ˆæœ€å¤§95%ï¼‰
                        progressBar.style.width = `${estimatedProgress}%`;
                        progressText.textContent = `${Math.floor(estimatedProgress)}% - ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­... (${(receivedBytes / 1024 / 1024).toFixed(1)}MB)`;
                    }
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’95%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '95%';
                    progressText.textContent = '95% - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...';
                }
                
                // Blobã‚’æ§‹ç¯‰
                const blob = new Blob(chunks, { type: 'application/json; charset=utf-8' });
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
                const downloadUrl = window.URL.createObjectURL(blob);
                const filename = `restaurants_export_${new Date().getTime()}.json`;
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±¥æ­´ã‚’ä¿å­˜
                const currentPartnerId = sessionStorage.getItem("currentPartnerId");
                if (currentPartnerId) {
                    const downloadHistoryKey = `download_history_${currentPartnerId}`;
                    const downloadHistory = JSON.parse(localStorage.getItem(downloadHistoryKey) || '[]');
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‹ã‚‰ä»¶æ•°ã‚’æ¨å®š
                    const estimatedCount = Math.floor(receivedBytes / 500); // JSONã¯1ä»¶ã‚ãŸã‚Šç´„500ãƒã‚¤ãƒˆã¨ä»®å®š
                    downloadHistory.unshift({
                        filename: filename,
                        downloadedAt: new Date().toISOString(),
                        count: estimatedCount,
                        type: 'JSON'
                    });
                    // æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
                    if (downloadHistory.length > 100) {
                        downloadHistory.splice(100);
                    }
                    localStorage.setItem(downloadHistoryKey, JSON.stringify(downloadHistory));
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«
                if (progressBar && progressText) {
                    progressBar.style.width = '100%';
                    progressText.textContent = '100% - å®Œäº†ï¼';
                }
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                setTimeout(() => {
                    hideExportModal(modal, progressInterval);
                }, 1000);
                
            } catch (error) {
                console.error('JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                hideExportModal(modal, progressInterval);
                
                if (error.name === 'AbortError') {
                    alert('JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚\nãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„å ´åˆã¯ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ã¦ä»¶æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚');
                } else {
                    alert('JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + error.message);
                }
            }
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç®¡ç†
        let currentHeaderFilterMenu = null;
        let headerFilterData = {
            name: { values: [], selected: [] },
            address: { values: [], selected: [] },
            contact: { values: [], selected: [] },
            category: { values: [], selected: [] },
            delivery: { values: [], selected: [] },
            status: { values: [], selected: [] },
            closed_day: { values: [], selected: [] },
            opening_date: { values: [], selected: [] },
            transport: { values: [], selected: [] },
            business_hours: { values: [], selected: [] },
            official_account: { values: [], selected: [] },
            collected_at: { values: [], selected: [] },
            data_source: { values: [], selected: [] }
        };
        
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã§ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åˆ¶å¾¡ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        document.addEventListener('click', (e) => {
            // 1) ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
            const icon = e.target.closest('.header-filter-icon');
            if (icon) {
                e.stopPropagation();
                e.preventDefault();
                
                const th = icon.closest('.header-filter-th');
                if (!th) {
                    console.warn('header-filter-th not found for icon', icon);
                    return;
                }
                
                const column = th.dataset.column;
                if (!column) {
                    console.warn('data-column not found on th', th);
                    return;
                }
                
                const menu = document.getElementById(`header-filter-menu-${column}`);
                if (!menu) {
                    console.warn(`Menu not found: header-filter-menu-${column}`);
                    return;
                }
                
                // ä»–ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
                document.querySelectorAll('.header-filter-menu').forEach(m => {
                    if (m !== menu) {
                        m.classList.remove('show');
                    }
                });
                
                // ç¾åœ¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã/é–‰ã˜ã‚‹
                menu.classList.toggle('show');
                currentHeaderFilterMenu = menu.classList.contains('show') ? column : null;
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã„ãŸã‚‰ã€å€¤ã®ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                if (menu.classList.contains('show')) {
                    updateHeaderFilterValues(column);
                }
                return; // ã“ã“ã§çµ‚äº†ï¼ˆä¸‹ã®ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã€ã¯å®Ÿè¡Œã—ãªã„ï¼‰
            }
            
            // 2) ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã‚¯ãƒªãƒƒã‚¯ãƒ»ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã¯é–‰ã˜å‡¦ç†ã®å¯¾è±¡å¤–
            if (e.target.closest('.header-filter-menu') || e.target.closest('.header-filter-th')) {
                return;
            }
            
            // 3) ãã‚Œä»¥å¤–ã®ã‚¯ãƒªãƒƒã‚¯ã§ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å…¨ã¦é–‰ã˜ã‚‹
            document.querySelectorAll('.header-filter-menu').forEach(m => {
                m.classList.remove('show');
            });
            currentHeaderFilterMenu = null;
        });
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
            if (e.target.closest('.header-filter-icon') || e.target.closest('.header-filter-menu') || e.target.closest('.header-filter-th')) {
                return;
            }
            
            document.querySelectorAll('.header-filter-menu').forEach(m => {
                m.classList.remove('show');
            });
            currentHeaderFilterMenu = null;
        });
        
        // åˆ—ã®å€¤ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateHeaderFilterValues(column) {
            const container = document.getElementById(`header-filter-values-${column}`);
            if (!container) return;
            
            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¯è¨­å®šã‹ã‚‰å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€å›ºå®šå€¤ã¨ã—ã¦æ‰±ã†
            if (column === 'data_source') {
                headerFilterData[column].values = DATA_SOURCES.map(s => s.value);
            }
            // ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å›ºå®šå€¤ãªã®ã§æ›´æ–°ä¸è¦
            if (column === 'delivery' || column === 'status') {
                return;
            }
            
            if (!window.currentStores || Object.keys(window.currentStores).length === 0) {
                // ãƒ‡ãƒ¼ã‚¿ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ã€å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
                loadStores(1).then(() => {
                    updateHeaderFilterValues(column);
                });
                return;
            }
            
            const stores = Object.values(window.currentStores);
            let values = [];
            
            if (column === 'name') {
                values = [...new Set(stores.map(s => s.name || '').filter(v => v))];
            } else if (column === 'address') {
                values = [...new Set(stores.map(s => s.address || '').filter(v => v))];
            } else if (column === 'contact') {
                values = [...new Set([
                    ...stores.map(s => s.phone || '').filter(v => v),
                    ...stores.map(s => s.website || '').filter(v => v)
                ])];
            } else if (column === 'category') {
                values = [...new Set(stores.map(s => s.category || '').filter(v => v))];
            } else if (column === 'closed_day') {
                values = [...new Set(stores.map(s => s.closed_day || '').filter(v => v))];
            } else if (column === 'opening_date') {
                values = [...new Set(stores.map(s => s.opening_date || '').filter(v => v))];
            } else if (column === 'transport') {
                values = [...new Set(stores.map(s => s.transport || '').filter(v => v))];
            } else if (column === 'business_hours') {
                values = [...new Set(stores.map(s => s.business_hours || '').filter(v => v))];
            } else if (column === 'official_account') {
                // å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯é…åˆ—ã¾ãŸã¯æ–‡å­—åˆ—ã®å¯èƒ½æ€§ãŒã‚ã‚‹
                values = [...new Set(stores.map(s => {
                    if (Array.isArray(s.official_account)) {
                        return s.official_account.join(', ');
                    }
                    return s.official_account || '';
                }).filter(v => v))];
            } else if (column === 'collected_at') {
                values = [...new Set(stores.map(s => s.collected_at || '').filter(v => v))];
            } else if (column === 'data_source') {
                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¯è¨­å®šã‹ã‚‰å‹•çš„ã«ç”Ÿæˆ
                values = DATA_SOURCES.map(s => s.value);
            } else {
                // å°†æ¥è¿½åŠ ã•ã‚Œã‚‹åˆ—ã«ã‚‚è‡ªå‹•çš„ã«å¯¾å¿œï¼ˆæ±ç”¨çš„ãªå‡¦ç†ï¼‰
                values = [...new Set(stores.map(s => {
                    const value = s[column];
                    if (Array.isArray(value)) {
                        return value.join(', ');
                    }
                    return value || '';
                }).filter(v => v))];
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ—ã®å ´åˆã¯è¨­å®šã‹ã‚‰ç”Ÿæˆã—ãŸå€¤ã‚’ä½¿ç”¨ï¼ˆæ—¢ã«è¨­å®šæ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            if (column !== 'data_source') {
                headerFilterData[column].values = values.sort();
            }
            
            // å€¤ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            container.innerHTML = '';
            const searchInput = document.getElementById(`header-filter-search-${column}`);
            const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
            
            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ—ã®å ´åˆã¯è¨­å®šã‹ã‚‰ç”Ÿæˆã—ãŸå€¤ã‚’ä½¿ç”¨
            const valuesToUse = column === 'data_source' ? DATA_SOURCES.map(s => s.value) : values;
            const filteredValues = searchQuery 
                ? valuesToUse.filter(v => {
                    const source = DATA_SOURCES.find(s => s.value === v);
                    const displayValue = source ? source.label : v;
                    return displayValue.toLowerCase().includes(searchQuery);
                })
                : valuesToUse;
            
            if (filteredValues.length === 0) {
                container.innerHTML = '<div class="header-filter-value-item" style="padding: 12px; color: #6b7280; text-align: center;">è©²å½“ã™ã‚‹å€¤ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            // ã€Œã™ã¹ã¦é¸æŠã€ãƒªãƒ³ã‚¯
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'header-filter-value-item';
            selectAllDiv.style.padding = '8px 12px';
            selectAllDiv.style.borderBottom = '1px solid #e5e7eb';
            const selectAllLink = document.createElement('a');
            selectAllLink.href = '#';
            selectAllLink.style.color = '#2563eb';
            selectAllLink.style.textDecoration = 'none';
            selectAllLink.textContent = `${filteredValues.length}ã‚’ã™ã¹ã¦é¸æŠ`;
            selectAllLink.onclick = (e) => {
                e.preventDefault();
                filteredValues.forEach(val => {
                    if (!headerFilterData[column].selected.includes(val)) {
                        headerFilterData[column].selected.push(val);
                    }
                });
                renderHeaderFilterValues(column);
            };
            selectAllDiv.appendChild(selectAllLink);
            container.appendChild(selectAllDiv);
            
            // å„å€¤ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            filteredValues.forEach(value => {
                const item = document.createElement('div');
                item.className = 'header-filter-value-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `header-filter-${column}-${value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                checkbox.value = value;
                checkbox.checked = headerFilterData[column].selected.length === 0 || headerFilterData[column].selected.includes(value);
                checkbox.onchange = () => {
                    if (checkbox.checked) {
                        if (!headerFilterData[column].selected.includes(value)) {
                            headerFilterData[column].selected.push(value);
                        }
                    } else {
                        const index = headerFilterData[column].selected.indexOf(value);
                        if (index > -1) {
                            headerFilterData[column].selected.splice(index, 1);
                        }
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ—ã®å ´åˆã€å·¦å´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚åŒæœŸ
                    if (column === 'data_source') {
                        syncLeftDataSourceFilter();
                    }
                };
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ—ã®å ´åˆã¯è¡¨ç¤ºåã‚’ä½¿ç”¨
                if (column === 'data_source') {
                    const source = DATA_SOURCES.find(s => s.value === value);
                    label.textContent = source ? source.label : value || '(ç©ºç™½)';
                } else {
                    label.textContent = value || '(ç©ºç™½)';
                }
                label.style.cursor = 'pointer';
                item.appendChild(checkbox);
                item.appendChild(label);
                container.appendChild(item);
            });
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤ã®è¡¨ç¤ºã‚’æ›´æ–°
        function renderHeaderFilterValues(column) {
            const container = document.getElementById(`header-filter-values-${column}`);
            if (!container) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([id*="all"])');
            checkboxes.forEach(cb => {
                cb.checked = headerFilterData[column].selected.length === 0 || headerFilterData[column].selected.includes(cb.value);
            });
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤ã®æ¤œç´¢
        function filterHeaderValues(column) {
            updateHeaderFilterValues(column);
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä½ç½®ã‚’èª¿æ•´ï¼ˆç”»é¢ç«¯ã§è¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã«ï¼‰
        function adjustMenuPosition(menu, thElement) {
            if (!menu || !thElement) return;
            
            const thRect = thElement.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            const menuWidth = menuRect.width || menu.offsetWidth || 280;
            const menuHeight = menuRect.height || menu.offsetHeight || 400;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            const margin = 10; // ãƒãƒ¼ã‚¸ãƒ³
            
            let left = thRect.left + scrollX;
            let top = thRect.bottom + scrollY + 5; // 5pxã®é–“éš”
            
            // å³ç«¯ã§è¦‹åˆ‡ã‚Œã‚‹å ´åˆã€å·¦å´ã«èª¿æ•´
            if (left + menuWidth > viewportWidth + scrollX - margin) {
                left = Math.max(margin, viewportWidth + scrollX - menuWidth - margin);
            }
            
            // å·¦ç«¯ã§è¦‹åˆ‡ã‚Œã‚‹å ´åˆã€å³å´ã«èª¿æ•´
            if (left < scrollX + margin) {
                left = scrollX + margin;
            }
            
            // ä¸‹ç«¯ã§è¦‹åˆ‡ã‚Œã‚‹å ´åˆã€ä¸Šå´ã«è¡¨ç¤º
            const spaceBelow = viewportHeight + scrollY - (thRect.bottom + scrollY);
            const spaceAbove = (thRect.top + scrollY) - scrollY;
            
            if (spaceBelow < menuHeight + margin && spaceAbove > spaceBelow) {
                // ä¸Šå´ã«è¡¨ç¤ºã™ã‚‹æ–¹ãŒã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚‹å ´åˆ
                top = thRect.top + scrollY - menuHeight - 5;
                // ä¸Šå´ã§ã‚‚è¦‹åˆ‡ã‚Œã‚‹å ´åˆã€ç”»é¢å†…ã«åã‚ã‚‹
                if (top < scrollY + margin) {
                    top = scrollY + margin;
                    const maxHeight = Math.min(menuHeight, viewportHeight - margin * 2);
                    menu.style.maxHeight = maxHeight + 'px';
                }
            } else if (spaceBelow < menuHeight + margin) {
                // ä¸‹å´ã®ã‚¹ãƒšãƒ¼ã‚¹ãŒè¶³ã‚Šãªã„å ´åˆã€ç”»é¢å†…ã«åã‚ã‚‹
                const maxHeight = Math.max(200, spaceBelow - margin * 2);
                menu.style.maxHeight = maxHeight + 'px';
            } else {
                // ååˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚‹å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æœ€å¤§é«˜ã•ã«æˆ»ã™
                menu.style.maxHeight = '500px';
            }
            
            // ä½ç½®ã‚’è¨­å®š
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.style.position = 'fixed'; // fixedã«å¤‰æ›´ã—ã¦ç¢ºå®Ÿã«è¡¨ç¤º
            
            // è¦–èªæ€§ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã€èƒŒæ™¯ã¨ã‚·ãƒ£ãƒ‰ã‚¦ã‚’å¼·åŒ–
            menu.style.backgroundColor = '#ffffff';
            menu.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
            menu.style.border = '1px solid #e5e7eb';
        }
        
        // ã™ã¹ã¦é¸æŠ/è§£é™¤
        function toggleHeaderFilterAll(column, checkbox) {
            const container = document.getElementById(`header-filter-values-${column}`);
            if (!container) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([id*="all"])');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    if (!headerFilterData[column].selected.includes(cb.value)) {
                        headerFilterData[column].selected.push(cb.value);
                    }
                } else {
                    const index = headerFilterData[column].selected.indexOf(cb.value);
                    if (index > -1) {
                        headerFilterData[column].selected.splice(index, 1);
                    }
                }
            });

            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ—ã®ã€Œã™ã¹ã¦ã€ã¯å³æ™‚é©ç”¨
            if (column === 'data_source') {
                // å·¦å´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚åŒæœŸ
                syncLeftDataSourceFilter();
                // ã€Œã™ã¹ã¦ã€ã¯OKãƒœã‚¿ãƒ³ç„¡ã—ã§å³æ™‚åæ˜ 
                applyHeaderFilter('data_source');
            }
            
            // ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹åˆ—ã®ã€Œã™ã¹ã¦ã€ã¯å³æ™‚é©ç”¨ï¼†ãƒ©ãƒ™ãƒ«æ›´æ–°
            if (column === 'delivery') {
                const label = document.getElementById('header-filter-delivery-selected-label');
                if (label) {
                    if (checkbox.checked) {
                        label.textContent = 'ã™ã¹ã¦ã®ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¡¨ç¤ºä¸­';
                    } else {
                        label.textContent = 'ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ã¯é©ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“';
                    }
                }
                // ã€Œã™ã¹ã¦ã€ã¯OKãƒœã‚¿ãƒ³ç„¡ã—ã§å³æ™‚åæ˜ 
                applyHeaderFilter('delivery');
            }
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
        function applyHeaderFilter(column) {
            const menu = document.getElementById(`header-filter-menu-${column}`);
            if (menu) {
                menu.classList.remove('show');
            }
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            if (column === 'name') {
                currentFilters.headerName = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'address') {
                currentFilters.headerAddress = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'contact') {
                currentFilters.headerContact = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'category') {
                currentFilters.headerCategory = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'closed_day') {
                currentFilters.headerClosedDay = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'opening_date') {
                currentFilters.headerOpeningDate = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'transport') {
                currentFilters.headerTransport = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'business_hours') {
                currentFilters.headerBusinessHours = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'official_account') {
                currentFilters.headerOfficialAccount = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'collected_at') {
                currentFilters.headerCollectedAt = headerFilterData[column].selected.length > 0 
                    ? headerFilterData[column].selected.join('|') 
                    : '';
            } else if (column === 'delivery') {
                const checkboxes = document.querySelectorAll(`#header-filter-values-delivery input[type="checkbox"]:not([id*="all"])`);
                const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
                // 3ã¤ã™ã¹ã¦é¸æŠ or 0ä»¶ã®å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—æ‰±ã„
                if (selected.length === 0 || selected.length === 3) {
                    currentFilters.headerDelivery = '';
                } else {
                    currentFilters.headerDelivery = selected.join(',');
                }

                // é¸æŠä¸­ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
                const label = document.getElementById('header-filter-delivery-selected-label');
                if (label) {
                    if (selected.length === 0 || selected.length === 3) {
                        label.textContent = 'ã™ã¹ã¦ã®ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¡¨ç¤ºä¸­';
                    } else {
                        const serviceLabels = selected.map(s => {
                            const norm = normalizeDeliveryServiceName(s);
                            if (norm === 'ubereats') return 'Uber Eats';
                            if (norm === 'wolt') return 'ã‚¦ã‚©ãƒ«ãƒˆ';
                            if (norm === 'demaecan') return 'å‡ºå‰é¤¨';
                            return s;
                        });
                        label.textContent = `é¸æŠä¸­: ${serviceLabels.join(', ')}`;
                    }
                }
            } else if (column === 'status') {
                const checkboxes = document.querySelectorAll(`#header-filter-values-status input[type="checkbox"]:not([id*="all"])`);
                const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
                currentFilters.headerStatus = selected.length > 0 ? selected.join(',') : '';
            }
            
            loadStores(1);
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        function clearHeaderFilter(column) {
            headerFilterData[column].selected = [];
            const container = document.getElementById(`header-filter-values-${column}`);
            if (container) {
                const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = true);
            }
            
            if (column === 'delivery' || column === 'status') {
                const checkboxes = document.querySelectorAll(`#header-filter-values-${column} input[type="checkbox"]:not([id*="all"])`);
                checkboxes.forEach(cb => cb.checked = true);
            }
            
            if (column === 'name') currentFilters.headerName = '';
            else if (column === 'address') currentFilters.headerAddress = '';
            else if (column === 'contact') currentFilters.headerContact = '';
            else if (column === 'category') currentFilters.headerCategory = '';
            else if (column === 'delivery') currentFilters.headerDelivery = '';
            else if (column === 'status') currentFilters.headerStatus = '';
            else if (column === 'closed_day') currentFilters.headerClosedDay = '';
            else if (column === 'opening_date') currentFilters.headerOpeningDate = '';
            else if (column === 'transport') currentFilters.headerTransport = '';
            else if (column === 'business_hours') currentFilters.headerBusinessHours = '';
            else if (column === 'official_account') currentFilters.headerOfficialAccount = '';
            else if (column === 'collected_at') currentFilters.headerCollectedAt = '';
            else if (column === 'data_source') {
                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                currentFilters.dataSources = DATA_SOURCES.map(s => s.value);
                syncLeftDataSourceFilter();
            } else {
                // å°†æ¥è¿½åŠ ã•ã‚Œã‚‹åˆ—ã«ã‚‚è‡ªå‹•çš„ã«å¯¾å¿œï¼ˆæ±ç”¨çš„ãªå‡¦ç†ï¼‰
                const filterKey = `header${column.charAt(0).toUpperCase() + column.slice(1).replace(/_([a-z])/g, (_, letter) => letter.toUpperCase())}`;
                if (currentFilters.hasOwnProperty(filterKey)) {
                    currentFilters[filterKey] = '';
                }
            }

            // ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã®é¸æŠãƒ©ãƒ™ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (column === 'delivery') {
                const label = document.getElementById('header-filter-delivery-selected-label');
                if (label) {
                    label.textContent = 'ã™ã¹ã¦ã®ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¡¨ç¤ºä¸­';
                }
            }
            
            const menu = document.getElementById(`header-filter-menu-${column}`);
            if (menu) {
                menu.classList.remove('show');
            }
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œã«ç¢ºå®Ÿã«ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
            // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ã€DOMæ›´æ–°ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã®æ›´æ–°ã‚’ç¢ºå®Ÿã«ã™ã‚‹
            setTimeout(() => {
                // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã®ãƒšãƒ¼ã‚¸ã‹ã‚‰è¡¨ç¤º
                loadStores(1);
            }, 150);
        }
        
        // ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ä¿æŒ
        let currentSortColumn = null;
        let currentSortDirection = null;
        
        // åˆ—ã‚’ã‚½ãƒ¼ãƒˆ
        function sortColumn(column, direction) {
            // ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’æ›´æ–°
            currentSortColumn = column;
            currentSortDirection = direction;
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            const menu = document.getElementById(`header-filter-menu-${column}`);
            if (menu) {
                menu.classList.remove('show');
            }
            
            // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (!window.currentStores || Object.keys(window.currentStores).length === 0) {
                // ãƒ‡ãƒ¼ã‚¿ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ã€å…ˆã«èª­ã¿è¾¼ã‚€
                loadStores(currentPage || 1).then(() => {
                    applySort();
                });
                return;
            }
            
            // ã‚½ãƒ¼ãƒˆã‚’é©ç”¨
            applySort();
        }
        
        // ã‚½ãƒ¼ãƒˆã‚’é©ç”¨ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
        function applySort() {
            if (!window.currentStores || !currentSortColumn) {
                return;
            }
            
            const container = document.getElementById('stores-container');
            if (!container) return;
            
            // ç¾åœ¨ã®ã‚¹ãƒˆã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
            let stores = Object.values(window.currentStores);
            
            // ã‚½ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
            stores.sort((a, b) => {
                let aValue, bValue;
                
                // åˆ—ã«å¿œã˜ã¦å€¤ã‚’å–å¾—
                switch (currentSortColumn) {
                    case 'name':
                        aValue = (a.name || '').toString().toLowerCase();
                        bValue = (b.name || '').toString().toLowerCase();
                        break;
                    case 'address':
                        aValue = (a.address || '').toString().toLowerCase();
                        bValue = (b.address || '').toString().toLowerCase();
                        break;
                    case 'contact':
                        // é›»è©±ç•ªå·ã¾ãŸã¯ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã§æ¯”è¼ƒ
                        aValue = ((a.phone || '') + (a.website || '')).toLowerCase();
                        bValue = ((b.phone || '') + (b.website || '')).toLowerCase();
                        break;
                    case 'category':
                        aValue = (a.category || '').toString().toLowerCase();
                        bValue = (b.category || '').toString().toLowerCase();
                        break;
                    case 'closed_day':
                        aValue = (a.closed_day || '').toString().toLowerCase();
                        bValue = (b.closed_day || '').toString().toLowerCase();
                        break;
                    case 'opening_date':
                        // æ—¥ä»˜æ–‡å­—åˆ—ï¼ˆYYYY-MM-DDï¼‰ã¨ã—ã¦æ¯”è¼ƒ
                        aValue = (a.opening_date || '');
                        bValue = (b.opening_date || '');
                        break;
                    case 'transport':
                        aValue = (a.transport || '').toString().toLowerCase();
                        bValue = (b.transport || '').toString().toLowerCase();
                        break;
                    case 'business_hours':
                        aValue = (a.business_hours || '').toString().toLowerCase();
                        bValue = (b.business_hours || '').toString().toLowerCase();
                        break;
                    case 'official_account':
                        // å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆURLç¾¤ã‚’çµåˆã—ã¦æ¯”è¼ƒ
                        aValue = (Array.isArray(a.official_account) ? a.official_account.join(',') : (a.official_account || '')).toString().toLowerCase();
                        bValue = (Array.isArray(b.official_account) ? b.official_account.join(',') : (b.official_account || '')).toString().toLowerCase();
                        break;
                    case 'data_source':
                        aValue = (a.data_source || '').toString().toLowerCase();
                        bValue = (b.data_source || '').toString().toLowerCase();
                        break;
                    case 'collected_at':
                        // åé›†æ—¥ï¼ˆYYYY-MM-DDï¼‰ã¨ã—ã¦æ¯”è¼ƒ
                        aValue = (a.collected_at || '');
                        bValue = (b.collected_at || '');
                        break;
                    case 'delivery':
                        // ãƒ‡ãƒªãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã®æ•°ã‚’æ¯”è¼ƒ
                        aValue = (a.delivery_services || []).length;
                        bValue = (b.delivery_services || []).length;
                        break;
                    case 'status':
                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ä¸€æ—¦æ–‡å­—åˆ—ã§ã‚½ãƒ¼ãƒˆ
                        aValue = (a.status || 'none').toString().toLowerCase();
                        bValue = (b.status || 'none').toString().toLowerCase();
                        break;
                    default:
                        return 0;
                }
                
                // æ•°å€¤ã®å ´åˆã¯æ•°å€¤ã¨ã—ã¦æ¯”è¼ƒ
                if (currentSortColumn === 'delivery') {
                    if (currentSortDirection === 'asc') {
                        return aValue - bValue;
                    } else {
                        return bValue - aValue;
                    }
                }
                
                // æ–‡å­—åˆ—ã®å ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦æ¯”è¼ƒ
                if (aValue < bValue) {
                    return currentSortDirection === 'asc' ? -1 : 1;
                } else if (aValue > bValue) {
                    return currentSortDirection === 'asc' ? 1 : -1;
                } else {
                    return 0;
                }
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢
            container.innerHTML = '';
            
            // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å†è¡¨ç¤º
            (async () => {
                for (const store of stores) {
                    const row = await createStoreTableRow(store);
                    container.appendChild(row);
                }
            })();
        }
        
        // ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadFavoritesLists() {
            const container = document.getElementById('favorites-lists-container');
            if (!container) return;
            
            try {
                const lists = await getSavedLists();
                // ãŠæ°—ã«å…¥ã‚Šã¯ã€is_favoriteãƒ•ãƒ©ã‚°ãŒã‚ã‚‹ãƒªã‚¹ãƒˆã€ã¾ãŸã¯ç‰¹å®šã®æ¡ä»¶ã§åˆ¤å®š
                const favoriteLists = lists.filter(list => {
                    // ãŠæ°—ã«å…¥ã‚Šãƒ•ãƒ©ã‚°ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    if (list.is_favorite !== undefined) {
                        return list.is_favorite === true;
                    }
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã™ã¹ã¦ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆå¾Œã§ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã‚’è¿½åŠ ï¼‰
                    return true;
                });
                
                if (favoriteLists.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-8">ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                container.innerHTML = '';
                favoriteLists.forEach(list => {
                    const listCard = createListCard(list);
                    container.appendChild(listCard);
                });
            } catch (error) {
                console.error('ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = '<p class="text-center text-red-500 py-8">ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadDownloadedLists() {
            const container = document.getElementById('downloaded-lists-container');
            if (!container) return;
            
            try {
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±¥æ­´ã‚’localStorageã‹ã‚‰å–å¾—
                const currentPartnerId = sessionStorage.getItem("currentPartnerId");
                const downloadHistoryKey = `download_history_${currentPartnerId}`;
                const downloadHistory = JSON.parse(localStorage.getItem(downloadHistoryKey) || '[]');
                
                if (downloadHistory.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-8">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                container.innerHTML = '';
                downloadHistory.forEach(item => {
                    const historyCard = document.createElement('div');
                    historyCard.className = 'apclo-card p-4 border border-gray-200';
                    historyCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-semibold text-gray-900">${escapeHtml(item.filename || 'ç„¡é¡Œã®ãƒªã‚¹ãƒˆ')}</h3>
                                <p class="text-sm text-gray-500 mt-1">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚: ${new Date(item.downloadedAt).toLocaleString('ja-JP')}</p>
                                <p class="text-sm text-gray-500">ä»¶æ•°: ${item.count || 0}ä»¶</p>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    onclick="reDownloadList('${escapeHtml(item.filename)}', ${item.count || 0})"
                                    class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                                >
                                    å†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(historyCard);
                });
            } catch (error) {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = '<p class="text-center text-red-500 py-8">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }
        
        // ãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆãŠæ°—ã«å…¥ã‚Šç”¨ï¼‰
        function createListCard(list) {
            const card = document.createElement('div');
            card.className = 'apclo-card p-4 border border-gray-200';
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">${escapeHtml(list.name)}</h3>
                        <p class="text-sm text-gray-500 mt-1">${list.stores ? list.stores.length : 0}ä»¶</p>
                        <p class="text-xs text-gray-400 mt-1">ä½œæˆæ—¥: ${new Date(list.createdAt).toLocaleString('ja-JP')}</p>
                    </div>
                    <div class="flex gap-2">
                        <button
                            onclick="viewSavedList('${list.id}')"
                            class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                        >
                            è¡¨ç¤º
                        </button>
                        <button
                            onclick="toggleFavorite('${list.id}')"
                            class="px-3 py-1 text-xs bg-yellow-500 text-white rounded hover:bg-yellow-600"
                        >
                            ${list.is_favorite ? 'â˜… ãŠæ°—ã«å…¥ã‚Šè§£é™¤' : 'â˜† ãŠæ°—ã«å…¥ã‚Š'}
                        </button>
                    </div>
                </div>
            `;
            return card;
        }
        
        // ãŠæ°—ã«å…¥ã‚Šã‚’åˆ‡ã‚Šæ›¿ãˆ
        async function toggleFavorite(listId) {
            const lists = await getSavedLists();
            const list = lists.find(l => l.id === listId);
            if (list) {
                list.is_favorite = !list.is_favorite;
                const key = getPartnerStorageKey('savedLists');
                localStorage.setItem(key, JSON.stringify(lists));
                await loadFavoritesLists();
            }
        }
        
        // å†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±¥æ­´ã‹ã‚‰ï¼‰
        window.reDownloadList = function(filename, count) {
            alert(`ã€Œ${filename}ã€ã®å†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚\nä»¶æ•°: ${count}ä»¶`);
        }

        // ==================== ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ====================
        function showReleaseNotes() {
            const modal = document.createElement('div');
            modal.id = 'release-notes-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ</h2>
                        <button
                            id="close-release-notes"
                            class="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                        >
                            Ã—
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}
                        </span>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- æ©Ÿèƒ½1: ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢ã®æ”¹å–„ -->
                        <div class="border border-gray-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                <span>ğŸ”</span>
                                <span>ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢ã®æ”¹å–„</span>
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-medium text-red-600 mb-2">Before</p>
                                    <div class="bg-red-50 border border-red-200 rounded p-4">
                                        <p class="text-sm text-gray-700 mb-2">ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒªã‚¹ãƒˆã«ä»¥ä¸‹ã®ã‚ˆã†ãªå€¤ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã—ãŸï¼š</p>
                                        <ul class="text-xs text-gray-600 space-y-1 list-disc list-inside">
                                            <li>ã‚ã–ã¿é‡é§… 100m / ãƒ‰ãƒ¼ãƒŠãƒ„</li>
                                            <li>ã‚ã³ã“é§… 313m / ã‚«ãƒ•ã‚§ã€ã‚¹ã‚¤ãƒ¼ãƒ„</li>
                                            <li>æ¾å±±å¸‚ / å±…é…’å±‹</li>
                                        </ul>
                                        <p class="text-xs text-gray-600 mt-2">é§…åã‚„è·é›¢æƒ…å ±ãŒæ··åœ¨ã—ã€æ¤œç´¢ãŒæ­£ã—ãå‹•ä½œã—ã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-green-600 mb-2">After</p>
                                    <div class="bg-green-50 border border-green-200 rounded p-4">
                                        <p class="text-sm text-gray-700 mb-2">ç´”ç²‹ãªã‚«ãƒ†ã‚´ãƒªãƒ¼åã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š</p>
                                        <ul class="text-xs text-gray-600 space-y-1 list-disc list-inside">
                                            <li>ãƒ‰ãƒ¼ãƒŠãƒ„</li>
                                            <li>ã‚«ãƒ•ã‚§</li>
                                            <li>ã‚¹ã‚¤ãƒ¼ãƒ„</li>
                                            <li>å±…é…’å±‹</li>
                                        </ul>
                                        <p class="text-xs text-gray-600 mt-2">é§…åã‚„è·é›¢æƒ…å ±ã‚’è‡ªå‹•çš„ã«é™¤å»ã—ã€æ¤œç´¢ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ©Ÿèƒ½2: å…¨ä»¶é¸æŠæ©Ÿèƒ½ -->
                        <div class="border border-gray-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                <span>âœ…</span>
                                <span>ã‚«ãƒ†ã‚´ãƒªãƒ¼å…¨ä»¶é¸æŠæ©Ÿèƒ½ã®è¿½åŠ </span>
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-medium text-red-600 mb-2">Before</p>
                                    <div class="bg-red-50 border border-red-200 rounded p-4">
                                        <p class="text-sm text-gray-700 mb-2">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã™ã‚‹ã«ã¯ã€å„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å€‹åˆ¥ã«ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚</p>
                                        <p class="text-xs text-gray-600 mt-2">å¤§é‡ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã™ã‚‹å ´åˆã€éå¸¸ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã—ãŸã€‚</p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-green-600 mb-2">After</p>
                                    <div class="bg-green-50 border border-green-200 rounded p-4">
                                        <p class="text-sm text-gray-700 mb-2">ã€Œå…¨ä»¶é¸æŠã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã ã‘ã§ã€ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä¸€åº¦ã«é¸æŠã§ãã¾ã™ã€‚</p>
                                        <ul class="text-xs text-gray-600 space-y-1 list-disc list-inside mt-2">
                                            <li>æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨æ™‚ã¯ã€è¡¨ç¤ºä¸­ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã¿ã‚’é¸æŠ</li>
                                            <li>ã™ã¹ã¦é¸æŠæ¸ˆã¿ã®å ´åˆã¯ã€Œå…¨é¸æŠè§£é™¤ã€ãƒœã‚¿ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ©Ÿèƒ½3: Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                        <div class="border border-gray-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                <span>ğŸ“Š</span>
                                <span>Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®è¿½åŠ </span>
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-medium text-red-600 mb-2">Before</p>
                                    <div class="bg-red-50 border border-red-200 rounded p-4">
                                        <p class="text-sm text-gray-700 mb-2">ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯CSVå½¢å¼ã¨JSONå½¢å¼ã®ã¿ã§ã—ãŸã€‚</p>
                                        <p class="text-xs text-gray-600 mt-2">Excelã§é–‹ãå ´åˆã€æ‰‹å‹•ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚</p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-green-600 mb-2">After</p>
                                    <div class="bg-green-50 border border-green-200 rounded p-4">
                                        <p class="text-sm text-gray-700 mb-2">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å½¢å¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š</p>
                                        <ul class="text-xs text-gray-600 space-y-1 list-disc list-inside mt-2">
                                            <li>CSVå½¢å¼</li>
                                            <li>JSONå½¢å¼</li>
                                            <li><strong>Excelå½¢å¼ï¼ˆæ–°è¦è¿½åŠ ï¼‰</strong></li>
                                        </ul>
                                        <p class="text-xs text-gray-600 mt-2">Excelå½¢å¼ã§ã¯ã€è¦‹ã‚„ã™ã„è¡¨å½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã¾ã™ã€‚</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ©Ÿèƒ½4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„ -->
                        <div class="border border-gray-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                <span>ğŸ› ï¸</span>
                                <span>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„</span>
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-medium text-red-600 mb-2">Before</p>
                                    <div class="bg-red-50 border border-red-200 rounded p-4">
                                        <p class="text-sm text-gray-700 mb-2">APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã¨ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å¤§é‡ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã—ãŸã€‚</p>
                                        <p class="text-xs text-gray-600 mt-2">ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚ã€ã‚¨ãƒ©ãƒ¼ãŒç¹°ã‚Šè¿”ã—è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã—ãŸã€‚</p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-green-600 mb-2">After</p>
                                    <div class="bg-green-50 border border-green-200 rounded p-4">
                                        <p class="text-sm text-gray-700 mb-2">ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„ã—ã€ä»¥ä¸‹ã®å¯¾å¿œã‚’è¡Œã„ã¾ã—ãŸï¼š</p>
                                        <ul class="text-xs text-gray-600 space-y-1 list-disc list-inside mt-2">
                                            <li>ngrokãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã¦æ¥ç¶šã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢</li>
                                            <li>ã‚¨ãƒ©ãƒ¼ã‚’é™ã‹ã«å‡¦ç†ã—ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ãƒã‚¤ã‚ºã‚’å‰Šæ¸›</li>
                                            <li>localStorageã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’å¼·åŒ–</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button
                            id="close-release-notes-btn"
                            class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors"
                        >
                            é–‰ã˜ã‚‹
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            const closeModal = () => {
                modal.remove();
            };
            
            document.getElementById('close-release-notes').addEventListener('click', closeModal);
            document.getElementById('close-release-notes-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
    </script>
</body>
</html>

