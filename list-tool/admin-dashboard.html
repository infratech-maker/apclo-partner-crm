<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ãƒ­ã‚±ãƒƒãƒˆãƒŠã‚¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script>
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã¯ç„¡åŠ¹åŒ–ï¼ˆé–‹ç™ºç’°å¢ƒç”¨ï¼‰
      // (function() {
      //   const isAdmin = sessionStorage.getItem("isAdmin") === "true";
      //   const currentPartnerId = sessionStorage.getItem("currentPartnerId");
      //   
      //   if (!currentPartnerId) {
      //     window.location.href = "/login";
      //     return;
      //   }
      //   
      //   if (!isAdmin) {
      //     window.location.replace("/login");
      //     return;
      //   }
      // })();
      
      // é–‹ç™ºç’°å¢ƒç”¨: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚’è¨­å®š
      if (!sessionStorage.getItem("currentPartnerId")) {
        sessionStorage.setItem("currentPartnerId", "ADMIN");
        sessionStorage.setItem("isAdmin", "true");
      }
    </script>
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
        background-color: #f8f9fa;
      }
    </style>
  </head>
  <body class="antialiased text-slate-900 bg-slate-100">
    <div class="min-h-screen flex">
      <!-- ã‚µã‚¤ãƒ‰ãƒŠãƒ“ï¼ˆå…±é€šãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ -->
      <aside class="hidden md:flex md:flex-col w-64 bg-slate-900 text-slate-100">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
          <div>
            <div class="text-xs uppercase tracking-widest text-slate-400">
              APCLO PARTNER
            </div>
            <div class="text-lg font-semibold tracking-tight">
              Admin Board
            </div>
          </div>
        </div>
        <nav class="flex-1 px-3 py-4 space-y-1 text-sm">
          <a
            href="/admin-dashboard"
            class="flex items-center gap-2 px-3 py-2 rounded-md bg-slate-800 text-slate-50 font-medium"
          >
            <span>ğŸ“Š</span>
            <span>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
          </a>
          <a
            href="/list-tool"
            class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
          >
            <span>ğŸ“‹</span>
            <span>ãƒªã‚¹ãƒˆåé›†ãƒ„ãƒ¼ãƒ«</span>
          </a>
          <a
            href="/billing"
            class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
          >
            <span>ğŸ’°</span>
            <span>è«‹æ±‚é–¢é€£ï¼ˆå…¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼‰</span>
          </a>
          <a
            href="/products"
            class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
          >
            <span>ğŸ›’</span>
            <span>ãã®ä»–å•†æ</span>
          </a>
          <a
            href="/account-management"
            class="flex items-center gap-2 px-3 py-2 rounded-md text-slate-200 hover:bg-slate-800 hover:text-white"
          >
            <span>ğŸ‘¥</span>
            <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</span>
          </a>
        </nav>
        <div class="px-4 py-4 border-t border-slate-800 text-xs text-slate-400">
          <div>FAST ALONE FAR TOGETHER</div>
          <div class="mt-1">ä¸€äººã§ã¯ãŸã©ã‚Šç€ã‘ãªã„æœªæ¥ã‚’ã€ã¨ã‚‚ã«ã€‚</div>
        </div>
      </aside>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="flex-1 flex flex-col">
        <header class="bg-white border-b border-slate-200">
          <div class="px-4 md:px-8 py-4 flex items-center justify-between">
            <div>
              <h1 class="text-xl md:text-2xl font-semibold tracking-tight text-slate-900">
                ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
              </h1>
              <p class="text-xs md:text-sm text-slate-500 mt-1">
                å…¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®é€²æ—ã¨åç›Šã‚’ä¸€å…ƒç®¡ç†
              </p>
            </div>
            <div class="flex items-center gap-4">
              <span
                id="admin-id-display"
                class="hidden sm:inline-flex text-xs md:text-sm font-medium text-slate-600 px-3 py-1 rounded-full bg-slate-100"
              >
                ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†è€…
              </span>
              <button
                id="btn-logout"
                class="px-3 py-2 md:px-4 md:py-2 bg-slate-900 text-white rounded-md text-xs md:text-sm font-medium hover:bg-slate-800 transition"
              >
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
              </button>
            </div>
          </div>
        </header>
        
        <main class="px-4 md:px-8 py-6 md:py-8 max-w-7xl w-full mx-auto">
      <!-- å…¨ä½“çµ±è¨ˆ -->
      <section class="mb-8 bg-white p-6 rounded-lg shadow-xl">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">å…¨ä½“çµ±è¨ˆ</h2>
        <div id="overall-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </section>
      
      <!-- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¸€è¦§ -->
      <section class="mb-8 bg-white p-6 rounded-lg shadow-xl">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¸€è¦§</h2>
        <div class="mb-4">
          <input
            type="text"
            id="search-partner"
            placeholder="ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã§æ¤œç´¢..."
            class="w-full md:w-1/3 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div id="partners-list" class="space-y-4">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </section>
        </main>
      </div>
    </div>
    <script>
      // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
      const isAdmin = sessionStorage.getItem("isAdmin") === "true";
      if (!isAdmin) {
        window.location.href = "/login";
      }
      
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById("btn-logout").addEventListener("click", () => {
        sessionStorage.removeItem("currentPartnerId");
        sessionStorage.removeItem("isAdmin");
        window.location.href = "/login";
      });
      
      // å…¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      function getAllPartnersData() {
        const partners = [];
        const keys = Object.keys(localStorage);
        
        // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚’æŠ½å‡ºï¼ˆpartner_XXX_* ã®å½¢å¼ã‹ã‚‰ï¼‰
        const partnerIds = new Set();
        keys.forEach(key => {
          const match = key.match(/^partner_([^_]+)_/);
          if (match) {
            partnerIds.add(match[1]);
          }
        });
        
        // å„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
        partnerIds.forEach(partnerId => {
          const reports = JSON.parse(localStorage.getItem(`partner_${partnerId}_dailyReports`) || "[]");
          const strategies = JSON.parse(localStorage.getItem(`partner_${partnerId}_savedStrategies`) || "[]");
          
          // ä»Šæœˆã®ãƒ¬ãƒãƒ¼ãƒˆã‚’é›†è¨ˆ
          const now = new Date();
          const currentMonth = now.getMonth();
          const currentYear = now.getFullYear();
          
          const monthlyReports = reports.filter(r => {
            const reportDate = new Date(r.date);
            return reportDate.getMonth() === currentMonth && reportDate.getFullYear() === currentYear;
          });
          
          const totals = monthlyReports.reduce((acc, r) => {
            acc.visits += parseInt(r.visits) || 0;
            acc.contacts += parseInt(r.contacts) || 0;
            acc.toss += parseInt(r.toss) || 0;
            acc.negotiations += parseInt(r.negotiations) || 0;
            acc.contracts += parseInt(r.contracts) || 0;
            acc.revenue += parseInt(r.revenue) || 0;
            return acc;
          }, { visits: 0, contacts: 0, toss: 0, negotiations: 0, contracts: 0, revenue: 0 });
          
          partners.push({
            id: partnerId,
            reports: reports.length,
            monthlyReports: monthlyReports.length,
            strategies: strategies.length,
            totals: totals,
            lastActivity: reports.length > 0 ? reports[reports.length - 1].createdAt : null,
          });
        });
        
        return partners;
      }
      
      // å…¨ä½“çµ±è¨ˆã‚’è¡¨ç¤º
      function displayOverallStats(partners) {
        const totalPartners = partners.length;
        const totalReports = partners.reduce((sum, p) => sum + p.reports, 0);
        const totalMonthlyReports = partners.reduce((sum, p) => sum + p.monthlyReports, 0);
        const totalRevenue = partners.reduce((sum, p) => sum + p.totals.revenue, 0);
        const totalContracts = partners.reduce((sum, p) => sum + p.totals.contracts, 0);
        
        document.getElementById("overall-stats").innerHTML = `
          <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-600">
            <h3 class="text-sm font-semibold text-gray-600 mb-1">ç™»éŒ²ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ•°</h3>
            <p class="text-3xl font-bold text-blue-600">${totalPartners}</p>
          </div>
          <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-600">
            <h3 class="text-sm font-semibold text-gray-600 mb-1">ä»Šæœˆã®æ—¥å ±æ•°</h3>
            <p class="text-3xl font-bold text-green-600">${totalMonthlyReports}</p>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-600">
            <h3 class="text-sm font-semibold text-gray-600 mb-1">ä»Šæœˆã®ç·åç›Š</h3>
            <p class="text-3xl font-bold text-purple-600">Â¥${totalRevenue.toLocaleString()}</p>
          </div>
          <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-600">
            <h3 class="text-sm font-semibold text-gray-600 mb-1">ä»Šæœˆã®ç·æˆç´„æ•°</h3>
            <p class="text-3xl font-bold text-orange-600">${totalContracts}ä»¶</p>
          </div>
        `;
      }
      
      // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
      function displayPartners(partners, searchTerm = "") {
        const filtered = searchTerm
          ? partners.filter(p => p.id.toLowerCase().includes(searchTerm.toLowerCase()))
          : partners;
        
        if (filtered.length === 0) {
          document.getElementById("partners-list").innerHTML = `
            <p class="text-center text-gray-500 py-8">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
          `;
          return;
        }
        
        document.getElementById("partners-list").innerHTML = filtered
          .map(partner => {
            const lastActivity = partner.lastActivity
              ? new Date(partner.lastActivity).toLocaleString("ja-JP")
              : "ãªã—";
            
            return `
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="text-xl font-bold text-gray-800">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ID: ${partner.id}</h3>
                    <p class="text-sm text-gray-500 mt-1">æœ€çµ‚æ´»å‹•: ${lastActivity}</p>
                  </div>
                  <button
                    onclick="viewPartnerDetail('${partner.id}')"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm"
                  >
                    è©³ç´°ã‚’è¦‹ã‚‹
                  </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                  <div>
                    <p class="text-xs text-gray-500">ä»Šæœˆã®è¨ªå•åº—èˆ—æ•°</p>
                    <p class="text-lg font-bold text-gray-800">${partner.totals.visits}</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">ä»Šæœˆã®ã‚­ãƒ¼ãƒãƒ³æ¥è§¦æ•°</p>
                    <p class="text-lg font-bold text-gray-800">${partner.totals.contacts}</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">ä»Šæœˆã®æˆç´„ä»¶æ•°</p>
                    <p class="text-lg font-bold text-gray-800">${partner.totals.contracts}</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">ä»Šæœˆã®åç›Š</p>
                    <p class="text-lg font-bold text-gray-800">Â¥${partner.totals.revenue.toLocaleString()}</p>
                  </div>
                </div>
                <div class="mt-3 text-sm text-gray-500">
                  <span>ç·æ—¥å ±æ•°: ${partner.reports}ä»¶</span>
                  <span class="ml-4">ä¿å­˜æˆ¦ç•¥æ•°: ${partner.strategies}ä»¶</span>
                </div>
              </div>
            `;
          })
          .join("");
      }
      
      // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è©³ç´°ã‚’è¡¨ç¤ºï¼ˆåˆ¥ãƒšãƒ¼ã‚¸ã¾ãŸã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
      window.viewPartnerDetail = function(partnerId) {
        sessionStorage.setItem("viewPartnerId", partnerId);
        window.open(`index.html?view=${partnerId}`, "_blank");
      };
      
      // æ¤œç´¢æ©Ÿèƒ½
      document.getElementById("search-partner").addEventListener("input", async (e) => {
        const partners = await getAllPartnersData();
        displayPartners(partners, e.target.value);
      });
      
      // åˆæœŸè¡¨ç¤º
      document.addEventListener("DOMContentLoaded", async () => {
        const partners = await getAllPartnersData();
        displayOverallStats(partners);
        displayPartners(partners);
      });
    </script>
  </body>
</html>

