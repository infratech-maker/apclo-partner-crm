# Leadsデータバックアップガイド

## 📋 概要

Leadsデータのデイリーバックアップ機能を実装しました。この機能により、毎日自動的にリードデータをバックアップし、2世代分を保持します。

## 🚀 使用方法

### 手動実行

```bash
npm run backup:leads
```

### 自動実行（cron設定）

毎日午前2時に自動実行するようにcronを設定します：

```bash
# セットアップスクリプトを実行
./scripts/setup-backup-cron.sh
```

または、手動でcronを設定する場合：

```bash
# crontabを編集
crontab -e

# 以下の行を追加（プロジェクトディレクトリのパスを適宜変更）
0 2 * * * cd /Users/a/CallSenderApp/crm-platform && npm run backup:leads >> logs/backup-leads.log 2>&1
```

## 📁 バックアップファイルの保存場所

バックアップファイルは以下のディレクトリに保存されます：

```
backups/leads/
  ├── leads_2026-01-06.json  (最新)
  └── leads_2026-01-05.json  (1世代前)
```

## 📊 バックアップファイルの形式

バックアップファイルはJSON形式で、以下の情報を含みます：

```json
{
  "backupDate": "2026-01-06T08:00:00.000Z",
  "totalLeads": 7298,
  "leads": [
    {
      "id": "...",
      "name": "...",
      "source": "...",
      "sourceUrl": "...",
      "status": "...",
      "data": {...},
      "notes": "...",
      "tenantId": "...",
      "organizationId": "...",
      "assignedToId": "...",
      "createdAt": "...",
      "updatedAt": "..."
    }
  ]
}
```

## 🔄 2世代保存の仕組み

- 最新のバックアップと1世代前のバックアップを保持
- 3世代目以降のバックアップは自動的に削除されます
- バックアップファイル名は日付形式（`leads_YYYY-MM-DD.json`）

## 📝 ログ

バックアップの実行ログは以下のファイルに記録されます：

```
logs/backup-leads.log
```

## 🔧 トラブルシューティング

### バックアップが実行されない

1. cronジョブが正しく設定されているか確認：
   ```bash
   crontab -l | grep backup:leads
   ```

2. ログファイルを確認：
   ```bash
   tail -f logs/backup-leads.log
   ```

3. 手動実行でエラーを確認：
   ```bash
   npm run backup:leads
   ```

### バックアップファイルが見つからない

1. バックアップディレクトリが存在するか確認：
   ```bash
   ls -la backups/leads/
   ```

2. ディレクトリの権限を確認：
   ```bash
   chmod -R 755 backups/
   ```

### ディスク容量の確認

バックアップファイルのサイズを確認：

```bash
du -sh backups/leads/*
```

## 💡 ベストプラクティス

1. **定期的な確認**: 週に1回程度、バックアップファイルが正しく作成されているか確認
2. **ログの監視**: エラーがないかログファイルを定期的に確認
3. **容量管理**: バックアップディレクトリの容量を定期的に確認
4. **オフサイトバックアップ**: 重要なデータは別の場所にもバックアップを保存することを推奨

## 🔐 セキュリティ

- バックアップファイルには機密情報が含まれる可能性があります
- バックアップディレクトリへのアクセス権限を適切に設定してください
- 必要に応じて、バックアップファイルを暗号化することを検討してください

